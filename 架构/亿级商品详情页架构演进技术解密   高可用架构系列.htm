<!DOCTYPE html>
<!-- saved from url=(0129)http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=210272034&idx=1&sn=3be9d2b53c7fec88716ee8affd2515f8&scene=21#wechat_redirect -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
<script type="text/javascript"> 
    var page_begintime = (+new Date());

    var biz = "MzAwMDU1MTE1OQ==";
    var sn = "3be9d2b53c7fec88716ee8affd2515f8" || "";
    var mid = "210272034" || "";
    var idx = "1" || "" ;
    
    //辟谣需求
    var is_rumor = ""*1;
    var norumor = ""*1;
    if (!!is_rumor&&!norumor){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/rumor") == -1){
        location.href = "http://mp.weixin.qq.com/mp/rumor?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }

    //原创需求，需要跳转到中间页
    /*
    var copyrightInfo = {
        display_source : ""*1,
        nocopyrightsource : ""*1
    };
    if (!!copyrightInfo.display_source&&!copyrightInfo.nocopyrightsource){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/reprint") == -1){
        location.href = "http://mp.weixin.qq.com/mp/reprint?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }*/
</script>

        
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">

<link rel="dns-prefetch" href="http://res.wx.qq.com/">
<link rel="dns-prefetch" href="http://mmbiz.qpic.cn/">
<link rel="shortcut icon" type="image/x-icon" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/favicon22c41b.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<script type="text/javascript">
    String.prototype.html = function(encode) {
        var replace =["&#39;", "'", "&quot;", '"', "&nbsp;", " ", "&gt;", ">", "&lt;", "<", "&amp;", "&", "&yen;", "¥"];
        if (encode) {
            replace.reverse();
        }
        for (var i=0,str=this;i< replace.length;i+= 2) {
             str=str.replace(new RegExp(replace[i],'g'),replace[i+1]);
        }
        return str;
    };

    window.isInWeixinApp = function() {
        return /MicroMessenger/.test(navigator.userAgent);
    };

    window.getQueryFromURL = function(url) {
        url = url || 'http://qq.com/s?a=b#rd'; // 做一层保护，保证URL是合法的
        var query = url.split('?')[1].split('#')[0].split('&'),
            params = {};
        for (var i=0; i<query.length; i++) {
            var arg = query[i].split('=');
            params[arg[0]] = arg[1];
        }
        if (params['pass_ticket']) {
        	params['pass_ticket'] = encodeURIComponent(params['pass_ticket'].html(false).html(false).replace(/\s/g,"+"));
        }
        return params;
    };

    (function() {
	    var params = getQueryFromURL(location.href);
        window.uin = params['uin'] || '';
        window.key = params['key'] || '';
        window.wxtoken = params['wxtoken'] || '';
        window.pass_ticket = params['pass_ticket'] || '';
    })();

    window.logs = {
    	pagetime: {}
    };
</script>

        <title>亿级商品详情页架构演进技术解密&nbsp;| 高可用架构系列</title>
        
<link rel="stylesheet" type="text/css" href="./亿级商品详情页架构演进技术解密   高可用架构系列_files/page_mp_article_improve29d6da.css">
<style>
     
    </style>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css">
<![endif]-->
<script type="text/javascript">
    document.domain = "qq.com";
</script>

    <link rel="stylesheet" type="text/css" href="./亿级商品详情页架构演进技术解密   高可用架构系列_files/not_in_mm2637ae.css"></head>
    <body id="activity-detail" class="zh_CN mm_appmsg not_in_mm" ontouchstart="">
        
    <script type="text/javascript">
        var write_sceen_time = (+new Date());
    </script>
    
    <div id="js_cmt_mine" class="discuss_container editing access" style="display:none;">
        <div class="discuss_container_inner">
            <h2 class="rich_media_title">亿级商品详情页架构演进技术解密&nbsp;| 高可用架构系列</h2>
            <span id="log"></span>
            <div class="frm_textarea_box_wrp">
                <span class="frm_textarea_box">
                    <textarea id="js_cmt_input" class="frm_textarea" placeholder="评论将由公众帐号筛选后显示，对所有人可见。"></textarea>
                    <div class="emotion_tool">
                        <span class="emotion_switch" style="display:none;"></span>
                        <span id="js_emotion_switch" class="pic_emotion_switch_wrp">
                            <img class="pic_default" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/icon_emotion_switch.2x278965.png" alt="">
                            <img class="pic_active" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/icon_emotion_switch_active.2x278965.png" alt="">
                        </span>
                        <div class="emotion_panel" id="js_emotion_panel">
                            <span class="emotion_panel_arrow_wrp" id="js_emotion_panel_arrow_wrp">
                                <i class="emotion_panel_arrow arrow_out"></i>
                                <i class="emotion_panel_arrow arrow_in"></i>
                            </span>
                            <div class="emotion_list_wrp" id="js_slide_wrapper">
                                
                                
                            </div>
                            <ul class="emotion_navs" id="js_navbar">
                                
                            </ul>
                        </div>
                    </div>
                </span>
            </div>
            <div class="discuss_btn_wrp"><a id="js_cmt_submit" class="btn btn_primary btn_discuss btn_disabled" href="javascript:;">提交</a></div>
            <div class="discuss_list_wrp" style="display:none">
                <div class="rich_tips with_line title_tips discuss_title_line">
                    <span class="tips">我的评论</span>
                </div>
                <ul class="discuss_list" id="js_cmt_mylist"></ul>
            </div>
            <div class="rich_tips tips_global loading_tips" id="js_mycmt_loading">
                <img src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                <span class="tips">加载中</span>
            </div>
            <div class="wx_poptips" id="js_cmt_toast" style="display:none;">
                <img alt="" class="icon_toast" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGoAAABqCAYAAABUIcSXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3NpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMTUxMzkxZS1jYWVhLTRmZTMtYTY2NS0xNTRkNDJiOGQyMWIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTA3QzM2RTg3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTA3QzM2RTc3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NWMyOGVjZTMtNzllZS00ODlhLWIxZTYtYzNmM2RjNzg2YjI2IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIxNTEzOTFlLWNhZWEtNGZlMy1hNjY1LTE1NGQ0MmI4ZDIxYiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmvxj1gAAAVrSURBVHja7J15rF1TFMbXk74q1ZKHGlMkJVIhIgg1FH+YEpEQJCKmGBpThRoSs5jVVNrSQUvEEENIhGiiNf9BiERICCFIRbUiDa2qvudbOetF3Tzv7XWGffa55/uS7593977n3vO7e5+199p7v56BgQGh0tcmvAUERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERVAUQVEERVAUQbVYk+HdvZVG8b5F0xj4RvhouB+eCy8KrdzDJc1RtAX8ILxvx98V1GyCSkN98Cx4z/95/Wn4fj6j6tUEeN4wkFSnw1MJqj5NhBfAuwaUHREUg4lqNMmePVsHll/HFhVfe1t3FwpJI8DXCCquDrCWNN4B6Tb4M3Z98aTPmTvh0YHl18PXw29yZiKejoPvcUD6E74yFBJbVDk6Bb7K8aP/Hb4c/tRzEYIqprPhSxzlf4Uvhb/0Xoig8qnHAJ3lqPMzfDH8XZ4LEpRf2sVdA5/sqPO9Qfop70UJyn+/boaPddT5yrq7VUUvTIVJI7q74MMddXR8NB1eXcYvhBpZm0s2w72/o86HFoKvLau/pYaXzjLMdUJ6y0LwtWV9CIIaXtvA8+G9HHV03u5q+K+yH47U0NoRngPv7KjzHDwTLj0bS1BDazfJJlcnOOostC6ysnCT+q80G/sIvFVgeW09D8FPVT0uoP7VfvAD8NjA8pqmuAN+OcYAjso0RbIZ8DGB5TVNcRO8JMaHY9SXSdfa3eeANJimWBLrA7JFiZwIXye+NMUV8CcxP2SRFjXefok7NRjSGZJlWUPvw2/wtNiQirSoXWyMsR28wR7AzzYM0oXw+Y7yK+CLJGeaoqjyrJSdZJD6Ov4+z5y6NJc0Az7NUecHydIUy+v60KNyQHoM3nKI1y7YCFiq0i7uBvgER52vDdKqWn9djhY1Dn4G3n6Ecqm2rF74dvgoR53S0hQxW9RJAZAGW5bSn58QJA27dQ7uIEedjywEX5NKVxCqsY6y+qA+LxFI4+yZ6oH0trWkNan80jygtIUsc5SflgAsDXgehfdx1KkkTRE76tN+Xue2jnTU0Ru1oIbvpt30bBtKhOp5yaaRkts0lic8V1i6dPcIRx2d/l8Y8XtNNEg7OOo8bl1kmmOKnDsO88CaYzejau0hWZqiL7C83oCH4SeTHvwV2BqqsHRVztSEYOmWF80NeXZT6Hd4KflResE9vCnBOlCyGfDNAstHTVPUDWoQ1t3iW+9WNizvlhfd4aerXd+ThqiMfNR6+9LvOOro5OY5JX2H4+F7HZD+kGzlamMgldWiirQsjcwWFbjmqZJteekJLK9pisvgL6RhKvuciZiwzrWWGapfrPy30kBVcSBIrw0aD3PU0XB6cehntq7rTMf7/2iQlktDVdXJLXlg6VjmiYBn6rWSTRCH6hvJ0hQrpcGq8oidsmHpTP8t8DGO9/vcWt9qabiqPgup1yKyQwvC2tSefZ73SSpNkUJ4PlLorlHZ+446nc8f3fIyywlJhwrTuwVSjBa1ccvSxN0hjjoK5xVrYZMd9V6XbFfgBukixTwGLg8sDam3dZR/wZ6L/dJlin1en8LS+bgpFbz3Ygvzu1J1HKxYNqxGpCmaCEo12rrBorD6LRp8UbpcdR5VWhTW35KlKd6QFqjuM2XzwlpnMxTvSkuUwuG/Xlg6NtPjbT6WFimF/VG6LEvXgn8QGDjMbBukVECFwhpoS+CQatfX2Q1q6H7wENHdrfCr0lKleEB9JyxNneus+VJpsVL9TwI6W65LovWIGl3KtVJaLv7LBwYTFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFFWq/hFgADUMN4RzT6/OAAAAAElFTkSuQmCC">
                <p class="toast_content">已评论</p>
            </div>
        </div>
    </div>

    <div id="js_article" class="rich_media">
        
        <div id="js_top_ad_area" class="top_banner">
 
        </div>
                

        <div class="rich_media_inner">
            <div id="page-content">
                <div id="img-content" class="rich_media_area_primary">
                    <h2 class="rich_media_title" id="activity-name">
                        亿级商品详情页架构演进技术解密&nbsp;| 高可用架构系列 
                    </h2>
                    <div class="rich_media_meta_list">
                        						                        <em id="post-date" class="rich_media_meta rich_media_meta_text">2015-08-31</em>

                                                <em class="rich_media_meta rich_media_meta_text">张开涛</em>
                                                <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="javascript:void(0);" id="post-user">高可用架构</a>
                        <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">高可用架构</span>

                        <div id="js_profile_qrcode" class="profile_container" style="display: none;">
                            <div class="profile_inner">
                                <strong class="profile_nickname">高可用架构</strong>
                                <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                                <p class="profile_meta">
                                <label class="profile_meta_label">微信号</label>
                                <span class="profile_meta_value">ArchNotes</span>
                                </p>

                                <p class="profile_meta">
                                <label class="profile_meta_label">功能介绍</label>
                                <span class="profile_meta_value">高可用架构公众号。</span>
                                </p>
                                
                            </div>
                            <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                                <i class="profile_arrow arrow_out"></i>
                                <i class="profile_arrow arrow_in"></i>
                            </span>
                        </div>
                    </div>
                                        
                                                            
                                                            
                    
                    <div class="rich_media_content " id="js_content">
                        
                        <p><strong>此文是开涛在【三体高可用架构群】之分享内容，“三体”是为了纪念三体一书对技术人的伟大影响而冠名。</strong></p><p><strong><br></strong></p><blockquote><p>张开涛：2014年加入京东，主要负责商品详情页、详情页统一服务架构与开发工作，设计并开发了多个亿级访问量系统。工作之余喜欢写技术博客，有《跟我学Spring》、《跟我学Spring MVC》、《跟我学Shiro》、《跟我学Nginx+Lua开发》等系列教程，博客 http://jinnianshilongnian.iteye.com/  的访问量超过500W。</p></blockquote><p><br></p><p>京东618的硝烟虽已散去，可开发和备战618期间总结过的一些设计原则和遇到的一些坑还历历在目。伴随着网站业务发展，需求日趋复杂多样并随时变化；传统静态化方案会遇到业务瓶颈，不能满足瞬变的需求。因此，需要一种能高性能实时渲染的动态化模板技术来解决这些问题。</p><p><br></p><p>今夜（编者：指8/27），我们将进行服装品类的垂直详情页的AB测试和切新库存服务的1/n流量。就此机会，和大家分享一下最近一年做的京东商品详情页的架构升级的心路历程。</p><p><br></p><h3><span style="font-size: 24px;">商品详情页是什么</span></h3><p>商品详情页是展示商品详细信息的一个页面，承载在网站的大部分流量和订单的入口。京东商城目前有通用版、全球购、闪购、易车、惠买车、服装、拼购、今日抄底等许多套详情页模板，通过一些特殊属性、商家类型和打标来区分，每套模板数据是一样的，核心逻辑基本一样，但是一些前端逻辑是有差别的。</p><p><br></p><p>目前商品详情页个性化需求非常多，数据来源也是非常多的（目前统计后端有差不多数十个依赖服务），而且许多基础服务做不了的不想做的或者说需要紧急处理的都放我们这处理，比如一些屏蔽商品需求等。因此我们需要一种架构能快速响应和优雅的解决这些需求问题，来了问题能在5~10分钟内搞定。我们这边经还常收到一些紧急需求，比如工商的一些投诉等需要及时响应。之前架构是静态化的，肯定无法满足这种日趋复杂和未知的需求。静态化时做屏蔽都是通过js，所以我们重新设计了商品详情页的架构。</p><p><br></p><p>它主要包括以下三部分：</p><p><strong><em>商品详情页系统</em></strong><br>负责静的部分（整个页面）</p><p><br></p><p><strong><em>商品详情页动态服务系统和商品详情页统一服务系统</em></strong><br><code>统一服务系统</code> 负责动的部分，比如实时库存。目前已经上线了几个核心服务，今晚计划切新库存服务的1/n流量。<br><code>动态服务系统</code> 负责给内网其他系统提供一些数据服务（比如大客户系统需要商品数据），目前商品详情页系统已经稳定运行半年了，目前主要给列表页提供一些数据。</p><p><br></p><p><strong><em>键值结构的异构数据集群</em></strong><br></p><p>商品主数据因为是存储在DB中，对于一些聚合数据需要联合查询非常多，会导致查询性能差的问题，因此对于键值类型的查询，我们这套异构数据非常有用。我们这次架构的调整的主要目的是满足日趋复杂的业务需求，能及时开发业务方的需求。我们的系统主要处理键值数据的逻辑，关系查询我们有另一套异构系统。</p><p><br></p><p>下图是我们的模板页，核心数据都是一样的，只是展示方式和一些前端逻辑不太一样。<br></p><p><img data-w="" data-ratio="0.7151051625239006" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnYXuVUJYXuznaZ60zUgy7FM9Hm8vxEGia4icrdstDnBpicaLTuCumfWCIA/0?wx_fmt=jpeg" style="width: auto !important; visibility: visible !important; height: auto !important;" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640"></p><p><img data-w="" data-ratio="0.6730401529636711" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wniaQHubmlEzXSy9BBFCyWuwfkV6Dza7z0RDoBa0v1fdPygI8HQhBydiaA/0?wx_fmt=jpeg" style="width: auto !important; visibility: visible !important; height: auto !important;" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(1)"></p><p><img data-w="" data-ratio="0.6711281070745698" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnHcEAibyWIG3R0AMfQAOa3khlib53c8ekK6steiaMSL4RmOvAMicgkia1CuQ/0?wx_fmt=jpeg" style="width: auto !important; visibility: visible !important; height: auto !important;" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(2)"></p><p><br></p><p>我们详情页的前端展示主要分为这么几个维度：</p><ul class=" list-paddingleft-2"><li><p>商品维度(标题、图片、属性等)</p></li><li><p>主商品维度（商品介绍、规格参数）</p></li><li><p>分类维度</p></li><li><p>商家维度</p></li><li><p>店铺维度</p></li></ul><p>另外还有一些实时性要求比较高的如实时价格、实时促销、广告词、配送至、预售等是通过异步加载。</p><p><br></p><p>我们目前把数据按维度化存储，比如一些维度直接redis存，性能好。<br></p><p><img data-w="" data-ratio="0.6195028680688337" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wn4XRzXT9RrtG7ZdY1wHXO2icWO5XZ87sCvpz73QYrjnHibIeE3x06N5wQ/0?wx_fmt=jpeg" style="width: auto !important; visibility: visible !important; height: auto !important;" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(3)"></p><p>京东商城还有一些特殊维度数据：比如套装、手机合约机等，这些数据是主商品数据外挂的，通过异步加载来实现的逻辑。还有一些与第三方合作的，如易车，很多数据都是无法异构的，都是直接异步加载的。目前有易车、途牛等一些公司有这种合作。<br></p><p><br></p><p>我们618当天PV数亿，服务器端TOP99响应时间低于38ms（此处是第1000次中第99次排名的时间，PV具体数据不便公开，但TOP99基本在40ms之内）。<br><img data-w="" data-ratio="0.4168260038240918" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnOqHiaoZ83TL8TJ63KokzwZtGreQfPeyceWQ72aTrvTISPxAUeibKRj3A/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(4)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p>上图是我们的一个监控图。我们详情页流量特点是离散数据，热点少，各种爬虫、比价软件抓取；所以如果直接查库，防刷没做好，很容易被刷挂。</p><h3><br><strong><span style="font-size: 24px;"></span></strong></h3><h3><strong><span style="font-size: 24px;">商品详情页发展史</span></strong></h3><p><img data-w="" data-ratio="0.5946462715105163" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wn8pMJZianI0m9jYFOvjbYVvsYOQ4boM7Ry8iczqrkbONrqFmGRg2ibmPTw/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(5)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>这是我们的一个架构历史。</p><h4><br><strong><span style="font-size: 20px;"></span></strong></h4><h4><strong><span style="font-size: 20px;">架构1.0</span></strong></h4><p><img data-w="" data-ratio="0.2982791586998088" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wneahH2HyEZPKSeAoxszvQmqSD3MiaSDoMdgfOcDX8rge10GznV7qY9LQ/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(6)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>IIS+C#+Sql Server，最原始的架构，直接调用商品库获取相应的数据，扛不住时加了一层memcached来缓存数据。</p><p><br></p><p>这种方式经常受到依赖的服务不稳定而导致的性能抖动。基本发展初期都是这个样子的，扛不住加层缓存。因此我们设计了架构2.0。</p><h4><br><span style="font-size: 20px;"></span></h4><h4><span style="font-size: 20px;"><strong>架构2.0</strong></span></h4><p><img data-w="433" data-ratio="0.9006928406466512" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnPMfibNF4RSCFNKtO2vaL0aj9md6LiaTlgoe6ka59yP8le7rpKQ40zUPg/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(7)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>该方案使用了静态化技术，按照商品维度生成静态化HTML，这就是一个静态化方案。</p><p><strong> 主要思路：</strong></p><ol class=" list-paddingleft-2"><li><p>通过MQ得到变更通知；</p></li><li><p>通过Java Worker调用多个依赖系统生成详情页HTML；</p></li><li><p>通过rsync同步到其他机器；</p></li><li><p>通过Nginx直接输出静态页；</p></li><li><p>接入层负责负载均衡。</p><p><br></p></li></ol><p><strong> 主要缺点：</strong></p><ol class=" list-paddingleft-2"><li><p>假设只有分类、面包屑变更了，那么所有相关的商品都要重刷；</p></li><li><p>随着商品数量的增加，rsync会成为瓶颈；</p></li><li><p>无法迅速响应一些页面需求变更，大部分都是通过JavaScript动态改页面元素。</p></li></ol><p><br></p><p>之前需求没那么多，因此页面变更不是很频繁，基本没什么问题。但是随着商品数量的增加这种架构的存储容量到达了瓶颈，而且按照商品维度生成整个页面会存在如分类维度变更就要全部刷一遍这个分类下所有信息的问题，因此我们又改造了一版按照尾号路由到多台机器。这种生成整个页面的方案会存在比如只有分类信息变了，也需要把这个分类下的商品重新刷一遍。</p><h4><br><strong><span style="font-size: 20px;"></span></strong></h4><h4><strong><span style="font-size: 20px;">架构2.1</span></strong></h4><p><img data-w="" data-ratio="0.6902485659655831" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnTicsXg9O6LUygwiaKMibXF6uVBF2kI2zq7gq0pDuPcuvx0Ru8rYNNuhAg/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(8)" style="width: auto !important; visibility: visible !important; height: auto !important;"></p><p><br><strong> 主要思路：</strong></p><ol class=" list-paddingleft-2"><li><p>容量问题通过按照商品尾号做路由分散到多台机器，按照自营商品单独一台，第三方商品按照尾号分散到11台；</p></li><li><p>按维度生成HTML片段（框架、商品介绍、规格参数、面包屑、相关分类、店铺信息），而不是一个大HTML；</p></li><li><p>通过Nginx SSI合并片段输出；</p></li><li><p>接入层负责负载均衡；</p></li><li><p>多机房部署也无法通过rsync同步，而是使用部署多套相同的架构来实现。</p></li></ol><p><br></p><p>这种方式通过尾号路由的方式分散到多台机器扩容，然后生成HTML片段，按需静态化；当时我们做闪购的时候，需要加页头，都是通过js搞定的。但对于大的页面结构变更，需要全量生成。尤其像面包屑不一样的话会很麻烦，需要生成多个版本。</p><p><strong><br></strong></p><p><strong>主要缺点：</strong></p><ol class=" list-paddingleft-2"><li><p>碎片文件太多，导致如无法rsync；</p></li><li><p>机械盘做SSI合并时，高并发时性能差，此时我们还没有尝试使用SSD；</p></li><li><p>模板如果要变更，数亿商品需要数天才能刷完；</p></li><li><p>到达容量瓶颈时，我们会删除一部分静态化商品，然后通过动态渲染输出，动态渲染系统在高峰时会导致依赖系统压力大，抗不住；</p></li><li><p>还是无法迅速响应一些业务需求。</p></li></ol><p><br></p><p>当时我记得印象最深的就是碎片文件太多，我们的inode不够了，经常要半夜去公司删文件。因为存在删除问题，每台服务器并不是全量，所以我们需要一个动态生成的服务，当静态化不存在的时候还原到动态服务；但这样双十一时压力非常大，我们依赖的系统随时都给我们降级。</p><h4><br><strong><span style="font-size: 20px;"></span></strong></h4><h4><strong><span style="font-size: 20px;">架构3.0</span></strong></h4><p><strong>我们的痛点：</strong></p><ol class=" list-paddingleft-2"><li><p>之前架构的问题存在容量问题，很快就会出现无法全量静态化，还是需要动态渲染；（对于全量静态化可以通过分布式文件系统解决该问题，这种方案没有尝试）</p></li><li><p>最主要的问题是随着业务的发展，无法满足迅速变化、还有一些变态的需求。</p></li></ol><p><br></p><p>其实最痛快的是业务来说我们要搞垂直，我们要模块化，我们要个性化；这些统统不好搞，因此我们就考虑做一版全动态的。其实思路和静态化差不多， 数据静态化聚合、页面模板化。</p><p><strong><br></strong></p><p><strong>我们要考虑和要解决的问题：</strong></p><ol class=" list-paddingleft-2"><li><p>能迅速响瞬变的需求，各种变态需求；</p></li><li><p>支持各种垂直化页面改版；</p></li><li><p>页面模块化；</p></li><li><p>AB测试；</p></li><li><p>高性能、水平扩容；</p></li><li><p>多机房多活、异地多活。</p></li></ol><p><img data-w="" data-ratio="0.5315487571701721" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnjuicQmgFNyiaTecnmneeQ3d9W6qicjpyG7S0cuzuxQlkRd5KYm49gyKUQ/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(9)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>这是我们新的系统：三个子系统。</p><p><strong>主要思路：</strong></p><ol class=" list-paddingleft-2"><li><p>数据变更还是通过MQ通知；</p></li><li><p>数据异构Worker得到通知，然后按照一些维度进行数据存储，存储到数据异构JIMDB集群（JIMDB：Redis+持久化引擎，是基于Redis改造的一个加了持久化引擎的KV存储），存储的数据都是未加工的原子化数据，如商品基本信息、商品扩展属性、商品其他一些相关信息、商品规格参数、分类、商家信息等；</p></li><li><p>数据异构Worker存储成功后，会发送一个MQ给数据同步
Worker，数据同步Worker也可以叫做数据聚合Worker，按照相应的维度聚合数据存储到相应的JIMDB集群；三个维度：基本信息（基本信息+扩展属性等的一个聚合）、商品介绍（PC版、移动版）、其他信息（分类、商家等维度，数据量小，直接Redis存储）；</p></li><li><p>前端展示分为两个：商品详情页和商品介绍，使用Nginx+Lua技术获取数据并渲染模板输出。</p></li></ol><p><br></p><p>思路差不多： MQ得到变更通知，Worker刷元数据到JIMDB，前端展示系统取数据渲染模板。另外我们当时架构的目标是详情页上有的数据，我们都可以提供服务出去，主要提供单个商品的查询服务，所以我们把这个系统叫做动态服务系统。<br><img data-w="" data-ratio="0.42829827915869984" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnryxxaia5I5jCVRSHUgoMlSQbabGkB82OJGIgJNoiaUmt0hmdCanfXe0A/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(10)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>该动态服务分为前端和后端，即公网还是内网，如目前该动态服务为列表页、商品对比、微信单品页、总代等提供相应的数据来满足和支持其业务。</p><p><br></p><p>目前每天为列表页提供增量数据服务。微信上京东入口看到的详情页 也是我们这个服务提供的数据。APP的数据暂时没走我们的系统，不过我们目前系统实现的是平常流量的50倍左右，性能和流量基本不是问题。我们详情页架构设计的一些原则：</p><ol class=" list-paddingleft-2"><li><p>数据闭环</p></li><li><p>数据维度化</p></li><li><p>拆分系统</p></li><li><p>Worker无状态化+任务化</p></li><li><p>异步化+并发化</p></li><li><p>多级缓存化</p></li><li><p>动态化</p></li><li><p>弹性化</p></li><li><p>降级开关</p></li><li><p>多机房多活</p></li><li><p>多种压测方案</p></li></ol><p><br></p><p>因为我们这边主要是读服务，因此我们架构可能偏读为主的设计；目前我设计的几个系统都遵循这些原则去设计：</p><p><br></p><p><strong>数据闭环</strong>：<br><img data-w="487" data-ratio="1.1909650924024642" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnUckWExkaEia4IGMotr8libIhwyraSJa8l3uSUgxhQIGX2yumKsnpxucw/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(11)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br><em>数据闭环</em>，即数据的自我管理，或者说是数据都在自己系统里维护，不依赖于任何其他系统，去依赖化，这样得到的好处就是别人抖动跟我没关系。因此我们要先数据异构。</p><p><em><br></em></p><p><em>数据异构</em>，是数据闭环的第一步，将各个依赖系统的数据拿过来，按照自己的要求存储起来；我们把很多数据划分为三个主要维度进行异构：商品信息、商品介绍和其他信息（分类、商家、店铺等）。</p><p><em><br></em></p><p><em>数据原子化处理</em>，数据异构的数据是原子化数据，这样未来我们可以对这些数据再加工再处理而响应变化的需求。我们有了一份原子化异构数据虽然方便处理新需求，但恰恰因为第一份数据是原子化的，那么它会很分散，前端读取时mget的话 性能不是很好，因此我们又做了数据聚合。</p><p><em><br></em></p><p><em>数据聚合</em>，是将多个原子数据聚合为一个大JSON数据，这样前端展示只需要一次get，当然要考虑系统架构，比如我们使用的Redis改造，Redis又是单线程系统，我们需要部署更多的Redis来支持更高的并发，另外存储的值要尽可能的小。</p><p><em><br></em></p><p><em>数据存储</em>，我们使用JIMDB，Redis加持久化存储引擎，可以存储超过内存N倍的数据量，我们目前一些系统是Redis+LMDB引擎的存储，目前是配合SSD进行存储；另外我们使用Hash Tag机制把相关的数据哈希到同一个分片，这样mget时不需要跨分片合并。分片逻辑使用的是Twemproxy，和应用端混合部署在一起；减少了一层中间层，也节约一部分机器。</p><p><br></p><p>我们目前的异构数据是键值结构的，用于按照商品维度查询，还有一套异构时关系结构的用于关系查询使用。</p><p><strong><br></strong></p><p><strong>数据维度化</strong><br>对于数据应该按照维度和作用进行维度化，这样可以分离存储，进行更有效的存储和使用。我们数据的维度比较简单：</p><ol class=" list-paddingleft-2"><li><p>商品基本信息，标题、扩展属性、特殊属性、图片、颜色尺码、规格参数等；<br>这些信息都是商品维度的。</p></li><li><p>商品介绍信息，商品维度商家模板、商品介绍等；<br>京东的商品比较特殊：自营和第三方。<br>自营的商品可以任意组合，选择其中一个作为主商品，因此他的商品介绍是商品维度。<br>第三方的组合是固定的，有一个固定的主商品，商品介绍是主商品维度。</p></li><li><p>非商品维度其他信息，分类信息、商家信息、店铺信息、店铺头、品牌信息等；<br>这些数据量不是很大，一个redis实例就能存储。</p></li><li><p>商品维度其他信息（异步加载），价格、促销、配送至、广告词、推荐配件、最佳组合等。</p></li></ol><p><br></p><p>这些数据很多部门在维护，只能异步加载；目前这些服务比较稳定，性能也不错，我们在把这些服务在服务端聚合，然后一次性吐出去。现在已经这么做了几个，比如下面这个就是在服务端聚合吐出去的情况。<br><img data-w="" data-ratio="0.32887189292543023" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnR9Dsm5L95wXICNJXV7SfuPN2AStbn1YHUIDibZzj7NLKJ4PenbunSbg/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 230.21032504780115px !important;"><br>http://c.3.cn/recommend?callback=jQuery4132621&amp;methods=accessories%2Csuit&amp;p=103003&amp;sku=1217499&amp;cat=9987%2C653%2C655&amp;lid=1&amp;uuid=1156941855&amp;pin=zhangkaitao1987&amp;ck=pin%2CipLocation%2Catw%2Caview&amp;lim=6&amp;cuuid=1156941855&amp;csid=122270672.4.1156941855%7C91.1440679162&amp;c1=9987&amp;c2=653&amp;c3=655&amp;_=1440679196326</p><p>这是我们url的一些规则，methods指定聚合的服务。我们还对系统按照其作用做了拆分。</p><p><strong><br></strong></p><p><strong>拆分系统</strong><br><img data-w="" data-ratio="0.47418738049713194" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnXmwsmEHtrYPDD0NG6LzDzTH8gsShfDDrNtwuN3uoBN27NcaWlXvGBA/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 331.93116634799236px !important;"><br></p><p>将系统拆分为多个子系统虽然增加了复杂性，但是可以得到更多的好处。比如，数据异构系统存储的数据是原子化数据，这样可以按照一些维度对外提供服务；而数据同步系统存储的是聚合数据，可以为前端展示提供高性能的读取。而前端展示系统分离为商品详情页和商品介绍，可以减少相互影响；目前商品介绍系统还提供其他的一些服务，比如全站异步页脚服务。我们后端还是一个任务系统。</p><p><strong><br></strong></p><p><strong>Worker无状态化+任务化</strong><br><img data-w="458" data-ratio="1.2925764192139737" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnBYrCD1wTCd0rReqI1kNs6uOFhVuBn04VLYzRPKibtgdLXKUEWFqGKCw/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 458px !important; visibility: visible !important; height: 592px !important;"><br></p><ol class=" list-paddingleft-2"><li><p>数据异构和数据同步Worker无状态化设计，这样可以水平扩展；</p></li><li><p>应用虽然是无状态化的，但是配置文件还是有状态的，每个机房一套配置，这样每个机房只读取当前机房数据；</p></li><li><p>任务多队列化，等待队列、排重队列、本地执行队列、失败队列；</p></li><li><p>队列优先级化，分为：普通队列、刷数据队列、高优先级队列；<br> 例如，一些秒杀商品会走高优先级队列保证快速执行。</p></li><li><p>副本队列，当上线后业务出现问题时，修正逻辑可以回放，从而修复数据；可以按照比如固定大小队列或者小时队列设计；</p></li><li><p>在设计消息时，按照维度更新，比如商品信息变更和商品上下架分离，减少每次变更接口的调用量，通过聚合Worker去做聚合。</p></li></ol><p><strong><br></strong></p><p><strong>异步化+并发化<br></strong></p><p>我们系统大量使用异步化，通过异步化机制提升并发能力。首先我们使用了消息异步化进行系统解耦合，通过消息通知我变更，然后我再调用相应接口获取相关数据；之前老系统使用同步推送机制，这种方式系统是紧耦合的，出问题需要联系各个负责人重新推送还要考虑失败重试机制。数据更新异步化，更新缓存时，同步调用服务，然后异步更新缓存。</p><p>可并行任务并发化，商品数据系统来源有多处，但是可以并发调用聚合，这样本来串行需要1s的经过这种方式我们提升到300ms之内。异步请求合并，异步请求做合并，然后一次请求调用就能拿到所有数据。前端服务异步化/聚合，实时价格、实时库存异步化，使用如线程或协程机制将多个可并发的服务聚合。异步化还一个好处就是可以对异步请求做合并，原来N次调用可以合并为一次，还可以做请求的排重。</p><p><br></p><p><strong>多级缓存化</strong><br>因之前的消息粒度较粗，我们目前在按照一些维度拆分消息，因此读服务肯定需要大量缓存设计,所以我们是一个多级缓存的系统。</p><p><em><br></em></p><p><em>浏览器缓存</em>，当页面之间来回跳转时走local cache，或者打开页面时拿着Last-Modified去CDN验证是否过期，减少来回传输的数据量；</p><p><em><br></em></p><p><em>CDN缓存</em>，用户去离自己最近的CDN节点拿数据，而不是都回源到北京机房获取数据，提升访问性能；</p><p><em><br></em></p><p><em>服务端应用本地缓存</em>，我们使用Nginx+Lua架构，使用HttpLuaModule模块的shared dict做本地缓存（ reload不丢失）或内存级Proxy Cache，从而减少带宽。</p><p><br></p><p>我们的应用就是通过Nginx+Lua写的，每次重启共享缓存不丢，这点我们受益颇多，重启没有抖动，另外我们还使用使用一致性哈希（如商品编号/分类）做负载均衡内部对URL重写提升命中率；我们对mget做了优化，如去商品其他维度数据，分类、面包屑、商家等差不多8个维度数据，如果每次mget获取性能差而且数据量很大，30KB以上；而这些数据缓存半小时也是没有问题的，因此我们设计为先读local cache，然后把不命中的再回源到remote cache获取，这个优化减少了一半以上的remote cache流量；这个优化减少了这个数据获取的一半流量；</p><p><em><br></em></p><p><em>服务端分布式缓存</em>，我们使用内存+SSD+JIMDB持久化存储。</p><p><strong><br></strong></p><p><strong>动态化</strong><br>我们整个页面是动态化渲染，输出的数据获取动态化，商品详情页：按维度获取数据，商品基本数据、其他数据（分类、商家信息等）；而且可以根据数据属性，按需做逻辑，比如虚拟商品需要自己定制的详情页，那么我们就可以跳转走，比如全球购的需要走jd.hk域名，那么也是没有问题的；未来比如医药的也要走单独域名。</p><p><em><br></em></p><p><em>模板渲染实时化</em>，支持随时变更模板需求；我们目前模板变更非常频繁，需求非常多，一个页面8个开发。</p><p><em><br></em></p><p><em>重启应用秒级化</em>，
使用Nginx+Lua架构，重启速度快，重启不丢共享字典缓存数据；其实我们有一些是Tomcat应用，我们也在考虑使用如Tomcat+Local 
Redis 或 Tomcat+Nginx Local Shared Dict 做一些本地缓存，防止重启堆缓存失效的问题。</p><p><em><br></em></p><p><em>需求上线速度化</em>，因为我们使用了Nginx+Lua架构，可以快速上线和重启应用，不会产生抖动；另外Lua本身是一种脚本语言，我们也在尝试把代码如何版本化存储，直接内部驱动Lua代码更新上线而不需要重启Nginx。</p><p><strong><br></strong></p><p><strong>弹性化</strong><br>我们所有应用业务都接入了Docker容器，存储还是物理机；我们会制作一些基础镜像，把需要的软件打成镜像，这样不用每次去运维那安装部署软件了；未来可以支持自动扩容，比如按照CPU或带宽自动扩容机器，目前京东一些业务支持一分钟自动扩容，下个月会进行弹性调度尝试。</p><p><strong><br></strong></p><p><strong>降级开关</strong><br>一个前端提供服务的系统必须考虑降级，推送服务器推送降级开关，开关集中化维护，然后通过推送机制推送到各个服务器；</p><p><em><br></em></p><p><em>可降级的多级读服务</em>，前端数据集群—-&gt;数据异构集群—-&gt;动态服务(调用依赖系统)；这样可以保证服务质量，假设前端数据集群坏了一个磁盘，还可以回源到数据异构集群获取数据；基本不怕磁盘坏或一些机器故障、或者机架故障。</p><p><em><br></em></p><p><em>开关前置化</em>，如Nginx代替Tomcat，在Nginx上做开关，请求就到不了后端，减少后端压力；我们目前很多开关都是在Nginx上。</p><p><em><br></em></p><p><em>可降级的业务线程池隔离</em>，从Servlet3开始支持异步模型，Tomcat7/Jetty8开始支持，相同的概念是Jetty6的Continuations。我们可以把处理过程分解为一个个的事件。</p><p><br></p><p>通过这种将请求划分为事件方式我们可以进行更多的控制。如，我们可以为不同的业务再建立不同的线程池进行控制：即我们只依赖tomcat线程池进行请求的解析，对于请求的处理我们交给我们自己的线程池去完成；这样tomcat线程池就不是我们的瓶颈，造成现在无法优化的状况。通过使用这种异步化事件模型，我们可以提高整体的吞吐量，不让慢速的A业务处理影响到其他业务处理。慢的还是慢，但是不影响其他的业务。我们通过这种机制还可以把tomcat线程池的监控拿出来，出问题时可以直接清空业务线程池，另外还可以自定义任务队列来支持一些特殊的业务。</p><p><br></p><p>去年使用的是JDK7+Tomcat7 最近一个月我们升级到了JDK8+Tomcat8+G1。<br><img data-w="477" data-ratio="1.0775681341719077" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnPPnpTqFtlv9tHVEhgreib4GrgZqNCy1epmMr2u99gLNkQTMKmCXWMcg/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 477px !important; visibility: visible !important; height: 514px !important;"><br></p><p><strong><br></strong></p><p><strong>多机房多活</strong><br>对于我们这种核心系统，我们需要考虑多机房多活的问题。目前是应用无状态，通过在配置文件中配置各自机房的数据集群来完成数据读取。<br><img data-w="" data-ratio="0.5258126195028681" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnvTxEicp08MBk2m3Zses34ibicnX19iauwzzynpAfK7sq8lUtP0ay0iaSDpA/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(12)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>其实我们系统只要存储多机房就多活了，因为系统天然就是。数据集群采用一主三从结构，防止当一个机房挂了，另一个机房压力大产生抖动。<br><img data-w="" data-ratio="0.5219885277246654" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnaVTza1rBNySpmn6ibRgzcq2GRuftLcqGNPUsY806W50z75ruMBZoGlw/0?wx_fmt=jpeg" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(13)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br>各个机房都是读本机房的从另外每个机房都是俩份数据，不怕因为机房突然中断恢复后的影响。</p><p><strong><br></strong></p><p><strong>多种压测方案</strong><br>我们在验证系统时需要进行压测。<br><em>线下压测</em>，Apache ab，Apache Jmeter，这种方式是固定url压测，一般通过访问日志收集一些url进行压测，可以简单压测单机峰值吞吐量，但是不能作为最终的压测结果，因为这种压测会存在热点问题；</p><p><em><br></em></p><p><em>线上压测</em>，可以使用Tcpcopy直接把线上流量导入到压测服务器，这种方式可以压测出机器的性能，而且可以把流量放大，也可以使用Nginx+Lua协程机制把流量分发到多台压测服务器，或者直接在页面埋点，让用户压测，此种压测方式可以不给用户返回内容。服务刚开始的时候大量使用tcpcopy做验证，对于一些
新服务，如果无法使用tcpcopy我们就在页面埋url让用户来压。</p><p><br></p><p>另外压测时，要考虑读、写、读或写同时压。只压某一种场景可能都会不真实。</p><p><br></p><h3><strong><span style="font-size: 24px;">遇到的一些问题和解决方案</span></strong></h3><h4><span style="font-size: 18px;"><strong>SSD性能差</strong></span></h4><p>使用SSD做KV存储时发现磁盘IO非常低。配置成RAID10的性能只有3<sub>6MB/s；配置成RAID0的性能有</sub>130MB/s，系统中没有发现CPU，MEM，中断等瓶颈。一台服务器从RAID1改成RAID0后，性能只有~60MB/s。这说明我们用的SSD盘性能不稳定。</p><p><br></p><p>据以上现象，初步怀疑以下几点：SSD盘，线上系统用的三星840Pro是消费级硬盘；RAID卡设置，Write back和Write through策略（后来测试验证，有影响，但不是关键）；RAID卡类型，线上系统用的是LSI 2008，比较陈旧。</p><p><br></p><p>下面是使用dd做的简单测试。<br><img data-w="" data-ratio="0.5755258126195029" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnIC9eG0wT8BCTZkviajXsibDooe1azbKODIBYp2wTvMVD19495Q9j0QhA/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 402.868068833652px !important;"><br>我们现实竟然使用的是民用级盘， 一个月坏几块很正常。后来我们全部申请换成了INTEL企业级盘，线上用3500型号。</p><h4><br></h4><h4><span style="font-size: 18px;"><strong>键值存储选型压测</strong></span></h4><p>在系统设计初期最头痛的就是存储选型，我们对于存储选型时尝试过LevelDB、RocksDB、BeansDB、LMDB、Riak等，最终根据我们的需求选择了LMDB。</p><p><br></p><p>机器：2台<br>配置：32核CPU、32GB内存、SSD（(512GB)三星840Pro—&gt; (600GB)Intel 3500 /Intel S3610）<br>数据：1.7亿数据（800多G数据）、大小5~30KB左右<br>KV存储引擎：LevelDB、RocksDB、LMDB，每台启动2个实例<br>压测工具：tcpcopy直接线上导流<br>压测用例：随机写+随机读</p><p><br></p><p>LevelDB压测时，随机读+随机写会产生抖动（我们的数据出自自己的监控平台，分钟级采样）。<br><img data-w="" data-ratio="0.8030592734225621" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnD3t8QUBcvibTDNhiaNxYBusYJbMEJvgiaibicxWWYyJ3pZvZIK1Cy7CnuLQ/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 562.1414913957935px !important;"><br>我们线上一些顺序写的服务在使用leveldb，RocksDB是改造自LevelDB，对SSD做了优化，我们压测时单独写或读，性能非常好，但是读写混合时就会因为归并产生抖动。<br><img data-w="" data-ratio="0.7590822179732314" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnyhCaNPibPrKdicJDv7nmKALUibSjJFRT00nYZ9wOdv7Ld6IwibvAXp4hzA/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 531.357552581262px !important;"><br>在归并时基本达到了我们磁盘的瓶颈，LMDB引擎没有大的抖动，基本满足我们的需求。<br><img data-w="" data-ratio="0.7705544933078394" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnI4pdVzR3KSyS7GXIGzBBUIhbgobM09EabSknvT33bamhgcAkf1rhCg/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 539.3881453154876px !important;"><br>我们目前一些线上服务器使用的是LMDB，新机房正在尝试公司自主研发的CycleDB引擎。目前我看到的应该很少使用LMDB引擎的。</p><h4><br></h4><h4><span style="font-size: 18px;"><strong>数据量大时Jimdb同步不动</strong></span></h4><p>Jimdb数据同步时要dump数据，SSD盘容量用了50%以上，dump到同一块磁盘容量不足。<br>解决方案：</p><ol class=" list-paddingleft-2"><li><p>一台物理机挂2块SSD(512GB)，单挂raid0；启动8个jimdb实例；这样每实例差不多125GB左右；目前是挂4块，raid0；新机房计划8块raid10；</p></li><li><p>目前是千兆网卡同步，同步峰值在100MB/s左右；</p></li><li><p>dump和sync数据时是顺序读写，因此挂一块SAS盘专门来同步数据；</p></li><li><p>使用文件锁保证一台物理机多个实例同时只有一个dump；</p></li><li><p>后续计划改造为直接内存转发而不做dump。</p></li></ol><h4><br><span style="font-size: 18px;"></span></h4><h4><span style="font-size: 18px;"><strong>切换主从</strong></span></h4><p>因为是基于Redis的，目前是先做数据RDB dump然后同步。后续计划改造为直接内存复制，之前存储架构是一主二从（主机房一主一从，备机房一从）切换到备机房时，只有一个主服务，读写压力大时有抖动，因此我们改造为之前架构图中的一主三从。</p><h4><br><strong><span style="font-size: 18px;"></span></strong></h4><h4><strong><span style="font-size: 18px;">分片配置</span></strong></h4><p>之前的架构是存储集群的分片逻辑分散到多个子系统的配置文件中，切换时需要操作很多系统。</p><p>解决方案：</p><ol class=" list-paddingleft-2"><li><p>引入Twemproxy中间件，我们使用本地部署的Twemproxy来维护分片逻辑；</p></li><li><p>使用自动部署系统推送配置和重启应用，重启之前暂停mq消费保证数据一致性；</p></li><li><p>用unix domain socket减少连接数和端口占用不释放启动不了服务的问题。</p></li></ol><p><br></p><p>我们都是在应用本地部署的Twemproxy，然后通过中间系统对外提供数据。</p><h4><br><strong><span style="font-size: 18px;"></span></strong></h4><h4><strong><span style="font-size: 18px;">模板元数据存储HTML</span></strong></h4><p>我们前端应用使用的是Nginx+Lua，起初不确定Lua做逻辑和渲染模板性能如何，就尽量减少for、if/else之类的逻辑；通过java 
worker组装html片段存储到jimdb，html片段会存储诸多问题，假设未来变了也是需要全量刷出的，因此存储的内容最好就是元数据。</p><p><br></p><p>因此通过线上不断压测，最终jimdb只存储元数据，lua做逻辑和渲染；逻辑代码在3000行以上；模板代码1500行以上，其中大量for、if/else，目前渲染性可以接受。</p><p><br></p><p>线上真实流量，整体性能从TOP99 53ms降到32ms。<br><img data-w="" data-ratio="0.875717017208413" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wntrr2WXBt9Gz8cNWGibVlXLDhkGXBnwQ3icuPibax6WxrM5iaqicKegCh10g/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 613.0019120458891px !important;"><br>绑定8 CPU测试的，渲染模板的性能可以接受。<br><img data-w="" data-ratio="0.4091778202676864" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnV8OLLY8rlo2D63w8GmeS4eDI5ONEze2A9H16OqJsiaF2K3LVCCcW5MA/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 286.4244741873805px !important;"></p><p><br></p><h4><br><span style="font-size: 18px;"></span></h4><h4><span style="font-size: 18px;"><strong>库存接口访问量600W/分钟</strong></span></h4><p>商品详情页库存接口2014年被恶意刷，每分钟超过600w访问量，tomcat机器只能定时重启；因为是详情页展示的数据，缓存几秒钟是可以接受的，因此开启nginx proxy 
cache来解决该问题，开启后降到正常水平；我们目前正在使用Nginx+Lua架构改造服务，数据过滤、URL重写等在Nginx层完成，通过URL重写+一致性哈希负载均衡，不怕随机URL，一些服务提升了10%+的缓存命中率。</p><p><br></p><p>目前我们大量使用内存级nginx proxy cache和nginx共享字典做数据缓存。<br>http://c.3.cn/recommend?callback=jQuery4132621&amp;methods=accessories%2Csuit&amp;p=103003&amp;sku=1217499&amp;cat=9987%2C653%2C655&amp;lid=1&amp;uuid=1156941855&amp;pin=zhangkaitao1987&amp;ck=pin%2CipLocation%2Catw%2Caview&amp;lim=6&amp;cuuid=1156941855&amp;csid=122270672.4.1156941855%7C91.1440679162&amp;c1=9987&amp;c2=653&amp;c3=655&amp;_=1440679196326</p><p>还有我们会对这些前端的url进行重写，所以不管怎么加随机数，都不会影响我们服务端的命中率，我们服务端做了参数的重新拼装和验证。</p><p><br></p><h4><strong><span style="font-size: 18px;">微信接口调用量暴增</span></strong></h4><p>14年的一段时间微信接口调用量暴增，通过访问日志发现某IP频繁抓取；而且按照商品编号遍历，但是会有一些不存在的编号。</p><p>解决方案：</p><ol class=" list-paddingleft-2"><li><p>读取KV存储的部分不限流；</p></li><li><p>回源到服务接口的进行请求限流，保证服务质量。</p></li><li><p>回源到DB的或者依赖系统的，我们也只能通过限流保证服务质量。</p></li></ol><h4><br><strong><span style="font-size: 18px;"></span></strong></h4><h4><strong><span style="font-size: 18px;">开启Nginx Proxy Cache性能不升反降</span></strong></h4><p>开启Nginx Proxy Cache后，性能下降，而且过一段内存使用率到达98%。</p><p>解决方案：</p><ol class=" list-paddingleft-2"><li><p>对于内存占用率高的问题是内核问题，内核使用LRU机制，本身不是问题，不过可以通过修改内核参数<br>sysctl -w vm.extra_free_kbytes=6436787<br>sysctl -w vm.vfs_cache_pressure=10000</p></li><li><p>使用Proxy Cache在机械盘上性能差可以通过tmpfs缓存或nginx共享字典缓存元数据，或者使用SSD，我们目前使用内存文件<strong>系统。</strong></p></li></ol><h4><br><strong><span style="font-size: 18px;"></span></strong></h4><h4><strong><span style="font-size: 18px;">配送至读服务因依赖太多，响应时间偏慢</span></strong></h4><p>配送至服务每天有数十亿调用量，响应时间偏慢。<br><strong>解决方案：</strong></p><ol class=" list-paddingleft-2"><li><p>串行获取变并发获取，这样一些服务可以并发调用，在我们某个系统中能提升一倍多的性能，从原来TP99差不多1s降到500ms以下；</p></li><li><p>预取依赖数据回传，这种机制还一个好处，比如我们依赖三个下游服务，而这三个服务都需要商品数据，那么我们可以在当前服务中取数据，然后回传给他们，这样可以减少下游系统的商品服务调用量，如果没有传，那么下游服务再自己查一下。</p></li></ol><p><br></p><p>假设一个读服务是需要如下数据：</p><ol class=" list-paddingleft-2"><li><p>数据A 10ms</p></li><li><p>数据B 15ms</p></li><li><p>数据C  20ms</p></li><li><p>数据D  5ms</p></li><li><p>数据E  10ms</p></li></ol><p><br></p><p>那么如果串行获取那么需要：60ms；而如果数据C依赖数据A和数据B、数据D谁也不依赖、数据E依赖数据C；那么我们可以这样子来获取数据：<br><img data-w="217" data-ratio="1.6589861751152073" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnl069NHiczbSNK2YDrbdeIQUiaiaY5KWTvAm4rvy7LLAosv9enluJg3pUg/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 217px !important; visibility: visible !important; height: 360px !important;"><br></p><p>那么如果并发化获取那么需要：30ms；能提升一倍的性能。</p><p><br></p><p>假设数据E还依赖数据F(5ms)，而数据F是在数据E服务中获取的，此时就可以考虑在此服务中在取数据A/B/D时预取数据F，那么整体性能就变为了：25ms。</p><p><br></p><p>我们目前大量使用并发获取和预取数据，通过这种优化我们服务提升了差不多10ms性能。 而且能显著减少一些依赖服务的重复调用，给他们减流。<br><img data-w="" data-ratio="0.4588910133843212" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnXpK6RnY1TIefiaVZjtju40S8rPlZ6TdCY30lPd7pUrCDtWEiaabZSI1g/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 321.22370936902485px !important;"><br>如下服务是在抖动时的性能，老服务TOP99 211ms，新服务118ms，此处我们主要就是并发调用+超时时间限制，超时直接降级。<br><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnmfyIPPFBibiaFmwTl6QcH94Qj0icqdPT2P9f3xj35obCjGuKusgfINJbA/0?wx_fmt=png" data-ratio="0.9573170731707317" data-w="328" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 328px !important; visibility: visible !important; height: 314px !important;"><br></p><h4><br><span style="font-size: 18px;"></span></h4><h4><span style="font-size: 18px;"><strong>网络抖动时，返回502错误</strong></span></h4><p>Twemproxy配置的timeout时间太长，之前设置为5s，而且没有分别针对连接、读、写设置超时。后来我们减少超时时间，内网设置在150ms以内，当超时时访问动态服务。对于读服务的话，应该设置合理的超时时间，比如超时了直接降级。</p><p><br></p><h4><br><span style="font-size: 18px;"></span></h4><h4><span style="font-size: 18px;"><strong>机器流量太大</strong></span></h4><p>2014年双11期间，服务器网卡流量到了400Mbps，CPU30%左右。原因是我们所有压缩都在接入层完成，因此接入层不再传入相关请求头到应用，随着流量的增大，接入层压力过大，因此我们把压缩下方到各个业务应用，添加了相应的请求头，Nginx GZIP压缩级别在2~4吞吐量最高；应用服务器流量降了差不多5倍；目前正常情况CPU在4%以下。</p><p><br></p><p>因为之前压缩都是接入层做的，后来因为接入的服务太多，因此我们决定在各应用去做。<br><img data-w="" data-ratio="0.16061185468451242" data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOO7GkEodD9GG2kEP4Xm42wnDdxCACu0s0VsMbtlaE8CUXpoSpOZRFtvsZPGWOCxOVUAbXvdDVP3mw/0?wx_fmt=jpeg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 112.4282982791587px !important;"><br></p><h3><span style="font-size: 24px;"><strong>一些总结</strong></span></h3><ul class=" list-paddingleft-2"><li><p>数据闭环</p></li><li><p>数据维度化</p></li><li><p>拆分系统</p></li><li><p>Worker无状态化+任务化</p></li><li><p>异步化+并发化</p></li><li><p>多级缓存化</p></li><li><p>动态化</p></li><li><p>弹性化</p></li><li><p>降级开关</p></li><li><p>多机房多活</p></li><li><p>多种压测方案</p></li><li><p>Nginx接入层线上灰度引流</p></li><li><p>接入层转发时只保留有用请求头</p></li><li><p>使用不需要cookie的无状态域名（如c.3.cn），减少入口带宽</p></li><li><p>Nginx Proxy Cache只缓存有效数据，如托底数据不缓存</p></li><li><p>使用非阻塞锁应对local cache失效时突发请求到后端应用(lua-resty-lock/proxy_cache_lock)</p></li><li><p>使用Twemproxy减少Redis连接数</p></li><li><p>使用unix domain socket套接字减少本机TCP连接数</p></li><li><p>设置合理的超时时间（连接、读、写）</p></li><li><p>使用长连接减少内部服务的连接数</p></li><li><p>去数据库依赖（协调部门迁移数据库是很痛苦的，目前内部使用机房域名而不是ip），服务化</p></li><li><p>客户端同域连接限制，进行域名分区：c0.3.cn c1.3.cn，如果未来支持HTTP/2.0的话，就不再适用了。</p><p><br></p></li></ul><h3><strong><span style="font-size: 24px;">Q&amp;A</span></strong></h3><p><strong>Q1：对于依赖服务的波动，导致我们系统的不稳定，我们是怎么设计的？</strong><br>我们的数据源有三套：前端数据集群 该数据每个机房有两套，目前两个机房。数据异构集群同上动态服务(调用依赖系统)。</p><ol class=" list-paddingleft-2"><li><p>设置好超时时间，尤其连接超时，内网我们一般100ms左右；</p></li><li><p>每个机房读从、如果从挂了降级读主；</p></li><li><p>如果前端集群挂了，我们会读取动态服务（1、先mget原子数据异构集群；2、失败了读依赖系统）。</p></li></ol><p><strong><br></strong></p><p><strong>Q2：静态化屏蔽通过js是怎么做的？</strong></p><ol class=" list-paddingleft-2"><li><p>紧急上线js，做跳转；</p></li><li><p>上线走流程需要差不多10分钟，然后还有清理CDN缓存，用户端还有本地缓存无法清理；</p></li><li><p>我们目前文件都放到我们的自动部署上，出问题直接修改，然后同步上去，重启nginx搞定。</p></li></ol><p><strong><br></strong></p><p><strong>Q3：内网的服务通过什么方式提供？</strong><br>我偏好使用HTTP，目前也在学习HTTP2.0，有一些服务使用我们自己开发类似于DUBBO的服务化框架，之前的版本就是DUBBO改造的。</p><p><strong><br></strong></p><p><strong>Q4：对于mq 的处理如果出现异常是怎么发现和处理的？</strong></p><ol class=" list-paddingleft-2"><li><p>MQ，我们目前是接收下来存Redis，然后会写一份到本地磁盘文件；</p></li><li><p>我们会把消息存一天的；</p></li><li><p>一般出问题是投诉，我们会紧急回滚消息到一天中的某个时间点。</p></li></ol><p><strong><br></strong></p><p><strong>Q5：对于模板这块，有做预编译处理？或者直接使用Lua写模板吗？</strong></p><ol class=" list-paddingleft-2"><li><p>luajit，类似于java jit；</p></li><li><p>lua直接写模板。</p></li></ol><p><strong><br></strong></p><p><strong>Q6： jimdb能否介绍下，特性是什么，为什么选用?</strong></p><ol class=" list-paddingleft-2"><li><p>jimdb就是我们起的一个名字，之前版本就是redis+lmdb持久化引擎，做了持久化；</p></li><li><p>我们根据当时的压测结果选择的，按照对比结果选择的，我们当时也测了豆瓣的beansdb，性能非常好，就是需要定期人工归并。</p></li></ol><p><strong><br></strong></p><p><strong>Q7：咨询下对于价格这类敏感数据，前端有缓存么？还是都靠价格服务扛？</strong></p><ol class=" list-paddingleft-2"><li><p>价格前端不缓存；</p></li><li><p>价格实时同步到Nginx+Lua本地的redis集群（大内存）；</p></li><li><p>不命中的才回源到tomcat查主redis/DB。</p></li></ol><p>价格数据也是通过MQ得到变更存储到本地redis的，nginx+lua直接读本机redis，性能没的说。</p><p><strong><br></strong></p><p><strong>Q8：库存和价格一样的模式处理吗？</strong><br>前端展示库存不是，我们做了几秒的服务端缓存。</p><p><strong><br></strong></p><p><strong>Q9：github里有一个开源的基于lmdb的redis 你们用的这个吗?</strong><br>我们内部自己写的，有一版基于LevelDB的，我记得github上叫ardb。</p><p><strong><br></strong></p><p><strong>Q10：看测试条件说测试的是大小5~30KB左右的数据，有没有测试过更大文件lmdb的表现？</strong><br>这个没有，我们的数据都是真实数据，最大的有50KB左右的，但是分布比较均匀；当时还考虑压缩，但是发现没什么性能问题，就没有压缩做存储了。</p><p><strong><br></strong></p><p><strong>Q11：关于redis缓存，是每个子系统拥有自己的一套缓存；还是使用统一的缓存服务？是否有进行过对比测试？（看到又说使用单机缓存防止服务挂掉，影响整体服务）</strong></p><ol class=" list-paddingleft-2"><li><p>我们公司有统一的缓存服务接入并提供运维；</p></li><li><p>我们的服务自己运维，因为我们是多机房从，每机房读自己的从，目前不支持这种方式；</p></li><li><p>（看到又说使用单机缓存防止服务挂掉，影响整体服务）这个主要是降级+备份+回源解决。</p></li></ol><p><strong><br></strong></p><p><strong>Q12： “我们目前一些线上服务器使用的是LMDB，其他一些正在尝试公司自主研发的CycleDB引擎”。 开始自主研发，这个是由于lmdb有坑还是处于别的考虑？</strong></p><ol class=" list-paddingleft-2"><li><p>写放大问题；</p></li><li><p>挂主从需要dump整个文件进行同步。</p></li></ol><p><br></p><p>想和群内专家继续交流电商高可用架构，请关注公众号后，回复arch，申请进群。</p><p><br></p><p><span style=" color: rgb(0, 0, 0) ; ;; font-style: normal; font-variant: normal; font-weight: bold; letter-spacing: normal; line-height: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; word-spacing: 0px; display: inline ! important; float: none; font-size: 16px; ">本文策划陈刚@北京智识，内容由刘世杰@猎聘网编辑，四正@大连华信校对与发布，其他多位志愿者对本文亦有贡献。更多关于架构方面的内容，读者可以通过搜索"ArchNotes"或点击页首的蓝字，关注"高可用架构"公众号，查看更多架构方面内容，获取通往架构师之路的宝贵经验。转载请注明来自"高可用架构 (ArchNotes)"微信公众号。</span></p><p><span style=" color: rgb(0, 0, 0) ; ;; font-style: normal; font-variant: normal; font-weight: bold; letter-spacing: normal; line-height: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; word-spacing: 0px; display: inline ! important; float: none; font-size: 16px; "><br></span></p><p><span style=" color: rgb(0, 0, 0) ; ;; font-style: normal; font-variant: normal; font-weight: bold; letter-spacing: normal; line-height: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; word-spacing: 0px; display: inline ! important; float: none; font-size: 16px; "><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONia2SViaUA3MoTnibjX46FaUicBg4AqaC58tCGAaUlM1zO8mic4XiaiajEqgib8rywbKHdECYDe8iaO3bvuPg/0?wx_fmt=jpeg" data-ratio="0.7495219885277247" data-w="" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/640(14)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></span></p><p><span style=" color: rgb(0, 0, 0) ; ;; font-style: normal; font-variant: normal; font-weight: bold; letter-spacing: normal; line-height: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; word-spacing: 0px; display: inline ! important; float: none; font-size: 16px; "><br></span></p><footer style="   font-size:.8em; text-align:right; bottom:0px; margin-left:-25px; height:20px; width:100%; "><br></footer>
                    </div>
                    <script type="text/javascript">
                        var first_sceen__time = (+new Date());

                        if ("" == 1 && document.getElementById('js_content'))
                            document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });

                                        (function(){
                            if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                                var link = document.createElement('link');
                                var head = document.getElementsByTagName('head')[0];
                                link.rel = 'stylesheet';
                                link.type = 'text/css';
                                link.href = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
                                head.appendChild(link);
                            }
                        })();
                    </script>
                    <link rel="stylesheet" type="text/css" href="./亿级商品详情页架构演进技术解密   高可用架构系列_files/page_mp_article_improve_combo29ab01.css">
                                        
                                        
                                        <div class="rich_media_tool" id="js_toobar3">
                                                                    <a class="media_tool_meta meta_primary" id="js_view_source" href="javascript:void(0);">阅读原文</a>
                                                <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                        <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                            <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                        </span>

                        <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="javascript:void(0);">举报</a>

                    </div>
                </div>

                <div class="rich_media_area_extra">

                    
                                        <div class="mpda_bottom_container" id="js_bottom_ad_area">
                        
                    </div>

                    
                    <div id="js_iframetest" style="display:none;"></div>

                    
                                    </div>
               
            </div>
            <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display: block;">
                <div class="qr_code_pc_inner">
                    <div class="qr_code_pc">
                        <img id="js_pc_qr_code_img" class="qr_code_pc_img" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/qrcode">
                        <p>微信扫一扫<br>关注该公众号</p>
                    </div>
                </div>
            </div>

        </div>
    </div>


        
        <script>window.moon_map = {"appmsg/emotion/caret.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/caret278965.js","appmsg/emotion/map.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/map278965.js","appmsg/emotion/textarea.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/textarea27cdc5.js","appmsg/emotion/nav.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/nav278965.js","appmsg/emotion/common.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/common278965.js","appmsg/emotion/slide.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/slide27cdc5.js","biz_wap/jsapi/cardticket.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/cardticket275627.js","pages/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report292ed8.js","pages/music_player.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_player298e98.js","pages/loadscript.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/loadscript292ed8.js","appmsg/emotion/dom.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/dom278965.js","appmsg/emotion/emotion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/emotion27f4f1.js","biz_wap/utils/hashrouter.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/hashrouter2805ea.js","a/gotoappdetail.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/gotoappdetail29b1f8.js","a/ios.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/ios275627.js","a/android.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/android275627.js","a/profile.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/profile29b1f8.js","a/card.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/card29b1f8.js","biz_wap/utils/position.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/position29b1f8.js","appmsg/a_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a_report282222.js","biz_common/utils/monitor.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/monitor27f4f1.js","biz_common/utils/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/report275627.js","biz_common/utils/huatuo.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/huatuo293afc.js","biz_common/utils/cookie.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/cookie275627.js","pages/voice_component.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_component298e98.js","new_video/ctl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/ctl292ed8.js","biz_common/utils/spin.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/spin275627.js","biz_wap/jsapi/pay.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/pay275627.js","appmsg/reward_entry.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/reward_entry29bb2b.js","appmsg/comment.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment29f4e9.js","appmsg/like.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/like29f4e9.js","appmsg/a.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a29ff2a.js","pages/version4video.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/version4video292ed8.js","biz_wap/utils/storage.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/storage275627.js","biz_common/tmpl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/tmpl275627.js","biz_common/ui/imgonepx.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/ui/imgonepx275627.js","biz_common/dom/attr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/attr275627.js","biz_wap/utils/ajax.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/ajax297cdb.js","biz_common/utils/string/html.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/string/html29f4e9.js","appmsg/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report29f4e9.js","biz_common/dom/class.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/class275627.js","appmsg/report_and_source.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report_and_source29f4e9.js","appmsg/page_pos.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/page_pos29f4e9.js","appmsg/cdn_speed_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_speed_report275627.js","appmsg/voice.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voice29ef1e.js","appmsg/qqmusic.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/qqmusic29ef1e.js","appmsg/iframe.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/iframe2989c1.js","appmsg/review_image.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/review_image29d138.js","appmsg/outer_link.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/outer_link275627.js","biz_wap/jsapi/core.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/core275627.js","biz_common/dom/event.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/event275627.js","appmsg/copyright_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/copyright_report2805ea.js","appmsg/pay_for_reading.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/pay_for_reading28f721.js","appmsg/async.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/async29ff2a.js","biz_wap/ui/lazyload_img.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/ui/lazyload_img275627.js","biz_common/log/jserr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/log/jserr2805ea.js","appmsg/share.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share29bb2b.js","biz_wap/utils/mmversion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/mmversion275627.js","appmsg/cdn_img_lib.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_img_lib275627.js","biz_common/utils/url/parse.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/url/parse275627.js","biz_wap/utils/device.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/device27f46f.js","appmsg/index.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/index29f4e9.js"};window.moon_crossorigin = true;</script><script type="text/javascript" src="./亿级商品详情页架构演进技术解密   高可用架构系列_files/moon275627.js" crossorigin=""></script>
    <script id="voice_tpl" type="text/html">        
        <span id="voice_main_<#=voiceid#>_<#=posIndex#>" class="db audio_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="audio_wrp db">
                <span id="voice_play_<#=voiceid#>_<#=posIndex#>" class="audio_play_area">
                    <i class="icon_audio_default"></i>
                    <i class="icon_audio_playing"></i>
                    <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/audio/icon_audio_unread26f1f1.png" alt="" class="pic_audio_default">
                </span>
                <span class="audio_length tips_global"><#=duration_str#></span>
                <span class="db audio_info_area">
                    <strong class="db audio_title"><#=title#></strong>
                    <span class="audio_source tips_global"><#if(window.nickname){#>来自<#=window.nickname#><#}#></span>
                </span>
                <span id="voice_progress_<#=voiceid#>_<#=posIndex#>" class="progress_bar" style="width:0px;"></span>
            </span>
        </span>
    </script>

    <script id="qqmusic_tpl" type="text/html">        
        <span id="qqmusic_main_<#=comment_id#>_<#=posIndex#>" class="db qqmusic_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="db qqmusic_wrp">
                <span class="db qqmusic_bd">
                    <span id="qqmusic_play_<#=musicid#>_<#=posIndex#>" class="play_area">
                        <i class="icon_qqmusic_switch"></i>
                        <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_default.2x26f1f1.png" alt="" class="pic_qqmusic_default">
                        <img src="<#=music_img#>" data-autourl="<#=audiourl#>" data-musicid="<#=musicid#>" class="qqmusic_thumb" alt="">
                    </span>
                                        <a id="qqmusic_home_<#=musicid#>_<#=posIndex#>" href="javascript:void(0);" class="access_area">
                        <span class="qqmusic_songname"><#=music_name#></span>
                        <span class="qqmusic_singername"><#=singer#></span>
                        <span class="qqmusic_source"><img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_source263724.png" alt=""></span>
                    </a>
                </span>
            </span>       
        </span>
    </script>

    <script id="t_cmt" type="text/html">
        <li class="discuss_item" id="cid<# if (is_from_me == 1) { #><#=my_id#><# } else { #><#=content_id#><# } #>">
            <# if(is_elected == 1){ #>
            <div class="discuss_opr">
                <span class="media_tool_meta tips_global meta_praise js_comment_praise <# if(like_status == 1){ #>praised<# } #>" data-status="<#=like_status#>" data-content-id='<#=content_id#>'>
                    <i class="icon_praise_gray"></i>
                    <span class="praise_num"><# if(like_num_format !== 0){ #><#=like_num_format#> <# } #></span>
                </span>
            </div>
            <# } #>
            <div class="user_info">
                <strong class="nickname"><#=nick_name#><# if(is_from_friend == 1){ #>(朋友)<# } #></strong>
                <img class="avatar" src="<#=logo_url#>">
            </div>
            <div class="discuss_message">
                <span class="discuss_status"><#=status#></span>
                <div class="discuss_message_content">
                <#=content#>
                </div>
            </div>
            <p class="discuss_extra_info">
                <#=time#>               
                <# if (is_from_me == 1) { #>
                <a class="discuss_del js_del" href="javascript:;" data-my-id="<#=my_id#>" data-content-id="<#=content_id#>">删除</a>
                <# } #>
            </p>
            <# if(reply && reply.reply_list && reply.reply_list.length > 0){ #>
                <div class="reply_result">
                    <div class="nickname">作者回复</div>
                    <div class="discuss_message">
                        <div class="discuss_message_content">
                        <#=reply.reply_list[0].content#>
                        </div>
                    </div>
                    <p class="discuss_extra_info"><#=reply.reply_list[0].time#></p>
                </div>
            <# } #>
                
        </li>
    </script>

    <script type="text/html" id="img_copyright_tpl">
        <span class="original_img_wrp">            
            <span class="tips_global">来自: <#=source_nickname#></span>
        </span>    
    </script>

  <script id="t_ad" type="text/html">
    <div class="rich_media_extra" id="gdt_area">
        <# if(pos_type==0){ #>
        <div class="rich_tips with_line title_tips">
            <span class="tips">广告</span>
        </div>
        <# } #>
        <div class="js_ad_link extra_link" data-type="<#=type#>" data-ticket="<#=ticket#>" data-url="<#=url#>" data-rl="<#=rl#>"  data-aid="<#=aid#>" data-pt="<#=pt#>" data-tid="<#=traceid#>" data-gid="<#=group_id#>" data-apurl="<#=apurl#>">




            <# if(pt==1){ #>
            <#=hint_txt#>
            <img class="icon_arrow_gray" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_arrow_gray1ef6d4.png">
            <img class="icon_loading_white icon_after" style="display:none;" id="loading_<#=traceid#>" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_loading_white2805ea.gif">
            <# }else if(pt==2){ #>
            
            <# if (logo.indexOf("http://mmsns.qpic.cn/") == 0){ #>
            <div class="brand_logo"><img src="<#=logo#>" alt="logo图片"></div>
            <# } #>
            <img class="appmsg_banner" src="<#=image_url#>">
            <# if(watermark_type!=0){ #><i class="promotion_tag"><# if(watermark_type==1){ #>商品推广<# }else if (watermark_type==2){ #>活动推广<# } #></i><# } #>
            <# }else if(pt==7){ #>
            
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">
                    <div class="preview_group_info">
                        <strong class="preview_group_title2"><#=hint_txt#></strong>
                        <div class="preview_group_desc"><#=ad_desc#></div>
                        <img src="<#=image_url#>" alt="" class="preview_card_avatar">
                    </div>
                </div>
            </div>
            <# }else if(pt==100){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=biz_info.nick_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <# if(!!biz_info.head_img){ #>
                        <img src="<#=biz_info.head_img#>" alt="" class="preview_group_avatar br_radius">
                        <# }else{ #>
                        <img class="preview_group_avatar br_radius" src="http://mmbiz.qpic.cn/mmbiz/a5icZrUmbV8p5jb6RZ8aYfjfS2AVle8URwBt8QIu6XbGewB9wiaWYWkPwq4R7pfdsFibuLkic16UcxDSNYtB8HnC1Q/0" alt="<#=biz_info.nick_name#>">
                        <# } #>                                 
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_view_profile_<#=pos_type#>" <# if(biz_info.is_subscribed == 0){ #>style="display:none"<# } #> class="btn btn_inline btn_primary btn_line js_ad_btn" href="javascript:void(0);">查看</a>
                        <a id="js_add_contact_<#=pos_type#>" data-url="<#=url#>" data-type="<#=type#>" data-tid="<#=traceid#>" data-rl="<#=rl#>" <# if(biz_info.is_subscribed ==1){ #>style="display:none"<# } #> class="btn btn_inline btn_line  btn_primary js_ad_btn" href="javascript:void(0);">关注</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==102){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_group_avatar br_radius">
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn btn_download" href="javascript:void(0);">下载</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==101){ #>
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">                            
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_card_avatar">                               
                    </div>
                    <div class="preview_group_opr">
                        <a href="javascript:void(0);" id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn">下载</a>
                    </div>
                </div>                        
            </div>
            <# }else if(pt==103||pt==104){ #>
            <div class="preview_group obvious_app">
                <div class="preview_group_inner">
                    <div class="pic_app">
                        <img src="<#=image_url#>" alt="">
                    </div>
                    <div class="info_app">
                        <p class="name_app"><#=app_info.app_name#></p>
                        <# if(pt==103){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._category#></span><em>|</em><span class="compacity"><#=app_info._app_size#></span></p>
                        <# } else if(pt==104){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._app_size#></span><em>|</em><span class="compacity"><#=app_info._down_count#></span></p>
                        <# } #>
                        
                        <p class="grade_app" id="js_app_rating_<#=pos_type#>">
                            
                            <span class="js_stars stars" style="display:none;"></span>
                            
                            <span class="js_scores scores">暂无评分</span>
                        </p>
                        <div class="dm_app">
                            <a href="javascript:void(0);" id="js_appdetail_action_<#=pos_type#>" class="ad_btn btn_download js_ad_btn">下载</a>
                            <p class="extra_info">来自<# if(pt==103){ #>App Store<# }else{ #>腾讯应用宝<# } #></p>
                        </div>
                    </div>
                </div>            
            </div>
            <# }else if(pt==105){ #>
            <div class="mpda_card cardticket">
                <div class="cardticket_hd cell">
                    <div class="cell_hd">
                        <span class="radius_avatar">
                            <img class="avatar" src="<#=card_info.card_logo_url#>">
                        </span>
                    </div>
                    <div class="cell_bd cell_primary"><#=card_info.card_title#></div>
                    <div class="cell_ft">
                        <a href="javascript:void(0);"  class="btn btn_plain_primary btn_inline js_ad_btn" id="js_card_action_<#=pos_type#>">领券</a>
                    </div>
                </div>
                <div class="cardticket_ft">
                    <div class="cardticket_theme"></div>
                    <p class="cardticket_source tips_global"><#=card_info.card_brand_name#></p>
                </div>
            </div>
            <# } #>
        </div>
    </div>
  </script>
  <script type="text/javascript">
      var not_in_mm_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/not_in_mm2637ae.css";
      var windowwx_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
      var tid = "";
      var aid = "";
      var clientversion = "0";
      var appuin = "MzAwMDU1MTE1OQ==";

      var source = "21";
      var scene = 75;
      
      var itemidx = "";
      var nickname = "高可用架构";
      var ct = "1441030587";
      var user_name = "gh_ef1c37a72e61";
      var user_name_new = "";
      var fakeid   = "";
      var version   = "";
      var is_limit_user   = "0";
      var msg_title = "亿级商品详情页架构演进技术解密&nbsp;|&nbsp;高可用架构系列";
      var msg_desc = "京东技术专家分享最近一年京东商品详情页的架构升级的心路历程";
      var msg_cdn_url = "http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONia2SViaUA3MoTnibjX46FaUiciaXc8lHEJvbvpsdrEpA2Ka8Cg1NgZJVZHfuZmG7MsIcNk7KQEvS6iabQ/0?wx_fmt=jpeg";
      var msg_link = "http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=210272034&amp;idx=1&amp;sn=3be9d2b53c7fec88716ee8affd2515f8#rd";
      var user_uin = "0"*1;
      var msg_source_url = 'http://www.upyun.com#rd';
      var img_format = 'jpeg';
      var srcid = '';
      var networkType;
      var appmsgid = '' || '210272034';
      var comment_id = "0" * 1;
      var comment_enabled = "" * 1;
      var is_need_reward = "0" * 1;
      var is_https_res = ("" * 1) && (location.protocol == "https:");

      var devicetype = "";
      var source_username = "";
      var reprint_ticket = "";
      var source_mid = "";
      var source_idx = "";

      var show_comment = "";
      var __appmsgCgiData = {
            can_use_page : "0"*1,
            is_wxg_stuff_uin : "0"*1,
            card_pos : "",
            copyright_stat : "0",
            hd_head_img : "http://wx.qlogo.cn/mmhead/Q3auHgzwzM4DkCqSIEoCCu1zKRml7uqGvKdYV2Z2KHyFjuydwib6dNA/0"||(window.location.protocol+"//"+window.location.host + "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_rumor_link.2x264e76.jpg")
      };
      var _empty_v = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/pages/voice/empty26f1f1.mp3";

      var copyright_stat = "0" * 1;

      var pay_fee = "" * 1; // 付费阅读费用
      var pay_timestamp = "";
      var need_pay = "" * 1;

      var need_report_cost = "0" * 1;
      
            window.wxtoken = "";
        </script>

  <script type="text/javascript">
        (function() {
        var JSAPI = {
            ready: function(onBridgeReady) {
                if (typeof top.window.WeixinJSBridge == 'undefined' || !top.window.WeixinJSBridge.invoke) {
                    if (top.window.document.addEventListener) {
                        top.window.document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                    } else if (top.window.document.attachEvent) {
                        top.window.document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
                        top.window.document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                    }
                } else {
                    onBridgeReady();
                }
            },
            on: function(eventName, callback) {
                top.window.WeixinJSBridge.on(eventName, callback);
            }
        };
        var onA8KeyReady = function(A8KeyUrl) {
            if (A8KeyUrl) {
                var params = getQueryFromURL(A8KeyUrl);
                window.uin = params['uin'] || window.uin;
                window.key = params['key'] || window.key;
                window.pass_ticket = params['pass_ticket'] || window.pass_ticket;
            }
            seajs.use('appmsg/index.js');
        };
        var bridgeReadyTimer;
        var onBridgeReady = function() {
            window.logs.pagetime['jsapi_ready_time'] = (+new Date());
            if (bridgeReadyTimer) {
                clearTimeout(bridgeReadyTimer);
            }
            if (!window.isWeixinCached) {
                                window.logs['is_page_cached'] = 0;
                onA8KeyReady();
            } else if (window.getA8KeyUrl) {
                                window.logs.pagetime['a8key_ready_time'] = (+new Date());
                onA8KeyReady(window.getA8KeyUrl);
            } else {
                                JSAPI.on('onGetA8KeyUrl', function(res) {
                    window.logs.pagetime['a8key_ready_time'] = (+new Date());
                    onA8KeyReady(res.url);
                });
            }
        };

                if (typeof window.pass_ticket !== 'undefined' && !!window.pass_ticket) {
                        onA8KeyReady();
        } else if (window.isInWeixinApp() == false) {
                        onA8KeyReady();
        } else {
                        window.logs['is_page_cached'] = 1;
            JSAPI.ready(onBridgeReady);
                        bridgeReadyTimer = setTimeout(function() {
                window.logs['jsapi_ready_fail'] = 1000;
                onA8KeyReady();
            }, 2000);
        }
    })();
  </script>

    


 
</body><style type="text/css" id="577930070000"></style></html>