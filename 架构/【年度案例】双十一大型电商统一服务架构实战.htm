<!DOCTYPE html>
<!-- saved from url=(0147)http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=401843895&idx=1&sn=2d4efc3f1c8ffc56c99d28150536fe93&scene=22&srcid=1126u8JqMh5cO4VeIAxoEoyz#rd -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
<script type="text/javascript"> 
    var page_begintime = (+new Date());

    var biz = "MzAwMDU1MTE1OQ==";
    var sn = "2d4efc3f1c8ffc56c99d28150536fe93" || "";
    var mid = "401843895" || "";
    var idx = "1" || "" ;
    
    //辟谣需求
    var is_rumor = ""*1;
    var norumor = ""*1;
    if (!!is_rumor&&!norumor){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/rumor") == -1){
        location.href = "http://mp.weixin.qq.com/mp/rumor?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }

    //原创需求，需要跳转到中间页
    /*
    var copyrightInfo = {
        display_source : ""*1,
        nocopyrightsource : ""*1
    };
    if (!!copyrightInfo.display_source&&!copyrightInfo.nocopyrightsource){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/reprint") == -1){
        location.href = "http://mp.weixin.qq.com/mp/reprint?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }*/
</script>

        
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">

<link rel="dns-prefetch" href="http://res.wx.qq.com/">
<link rel="dns-prefetch" href="http://mmbiz.qpic.cn/">
<link rel="shortcut icon" type="image/x-icon" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/favicon22c41b.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<script type="text/javascript">
    String.prototype.html = function(encode) {
        var replace =["&#39;", "'", "&quot;", '"', "&nbsp;", " ", "&gt;", ">", "&lt;", "<", "&amp;", "&", "&yen;", "¥"];
        if (encode) {
            replace.reverse();
        }
        for (var i=0,str=this;i< replace.length;i+= 2) {
             str=str.replace(new RegExp(replace[i],'g'),replace[i+1]);
        }
        return str;
    };

    window.isInWeixinApp = function() {
        return /MicroMessenger/.test(navigator.userAgent);
    };

    window.getQueryFromURL = function(url) {
        url = url || 'http://qq.com/s?a=b#rd'; // 做一层保护，保证URL是合法的
        var query = url.split('?')[1].split('#')[0].split('&'),
            params = {};
        for (var i=0; i<query.length; i++) {
            var arg = query[i].split('=');
            params[arg[0]] = arg[1];
        }
        if (params['pass_ticket']) {
        	params['pass_ticket'] = encodeURIComponent(params['pass_ticket'].html(false).html(false).replace(/\s/g,"+"));
        }
        return params;
    };

    (function() {
	    var params = getQueryFromURL(location.href);
        window.uin = params['uin'] || '';
        window.key = params['key'] || '';
        window.wxtoken = params['wxtoken'] || '';
        window.pass_ticket = params['pass_ticket'] || '';
    })();

    window.logs = {
    	pagetime: {}
    };
</script>

        <title>【年度案例】双十一大型电商统一服务架构实战</title>
        
<link rel="stylesheet" type="text/css" href="./【年度案例】双十一大型电商统一服务架构实战_files/page_mp_article_improve29d6da.css">
<style>
     
    </style>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css">
<![endif]-->
<script type="text/javascript">
    document.domain = "qq.com";
</script>

    <link rel="stylesheet" type="text/css" href="./【年度案例】双十一大型电商统一服务架构实战_files/not_in_mm2637ae.css"></head>
    <body id="activity-detail" class="zh_CN mm_appmsg not_in_mm" ontouchstart="">
        
    <script type="text/javascript">
        var write_sceen_time = (+new Date());
    </script>
    
    <div id="js_cmt_mine" class="discuss_container editing access" style="display:none;">
        <div class="discuss_container_inner">
            <h2 class="rich_media_title">【年度案例】双十一大型电商统一服务架构实战</h2>
            <span id="log"></span>
            <div class="frm_textarea_box_wrp">
                <span class="frm_textarea_box">
                    <textarea id="js_cmt_input" class="frm_textarea" placeholder="评论将由公众帐号筛选后显示，对所有人可见。"></textarea>
                    <div class="emotion_tool">
                        <span class="emotion_switch" style="display:none;"></span>
                        <span id="js_emotion_switch" class="pic_emotion_switch_wrp">
                            <img class="pic_default" src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_emotion_switch.2x278965.png" alt="">
                            <img class="pic_active" src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_emotion_switch_active.2x278965.png" alt="">
                        </span>
                        <div class="emotion_panel" id="js_emotion_panel">
                            <span class="emotion_panel_arrow_wrp" id="js_emotion_panel_arrow_wrp">
                                <i class="emotion_panel_arrow arrow_out"></i>
                                <i class="emotion_panel_arrow arrow_in"></i>
                            </span>
                            <div class="emotion_list_wrp" id="js_slide_wrapper">
                                
                                
                            </div>
                            <ul class="emotion_navs" id="js_navbar">
                                
                            </ul>
                        </div>
                    </div>
                </span>
            </div>
            <div class="discuss_btn_wrp"><a id="js_cmt_submit" class="btn btn_primary btn_discuss btn_disabled" href="javascript:;">提交</a></div>
            <div class="discuss_list_wrp" style="display:none">
                <div class="rich_tips with_line title_tips discuss_title_line">
                    <span class="tips">我的评论</span>
                </div>
                <ul class="discuss_list" id="js_cmt_mylist"></ul>
            </div>
            <div class="rich_tips tips_global loading_tips" id="js_mycmt_loading">
                <img src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                <span class="tips">加载中</span>
            </div>
            <div class="wx_poptips" id="js_cmt_toast" style="display:none;">
                <img alt="" class="icon_toast" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGoAAABqCAYAAABUIcSXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3NpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMTUxMzkxZS1jYWVhLTRmZTMtYTY2NS0xNTRkNDJiOGQyMWIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTA3QzM2RTg3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTA3QzM2RTc3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NWMyOGVjZTMtNzllZS00ODlhLWIxZTYtYzNmM2RjNzg2YjI2IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIxNTEzOTFlLWNhZWEtNGZlMy1hNjY1LTE1NGQ0MmI4ZDIxYiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmvxj1gAAAVrSURBVHja7J15rF1TFMbXk74q1ZKHGlMkJVIhIgg1FH+YEpEQJCKmGBpThRoSs5jVVNrSQUvEEENIhGiiNf9BiERICCFIRbUiDa2qvudbOetF3Tzv7XWGffa55/uS7593977n3vO7e5+199p7v56BgQGh0tcmvAUERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERVAUQVEERVAUQbVYk+HdvZVG8b5F0xj4RvhouB+eCy8KrdzDJc1RtAX8ILxvx98V1GyCSkN98Cx4z/95/Wn4fj6j6tUEeN4wkFSnw1MJqj5NhBfAuwaUHREUg4lqNMmePVsHll/HFhVfe1t3FwpJI8DXCCquDrCWNN4B6Tb4M3Z98aTPmTvh0YHl18PXw29yZiKejoPvcUD6E74yFBJbVDk6Bb7K8aP/Hb4c/tRzEYIqprPhSxzlf4Uvhb/0Xoig8qnHAJ3lqPMzfDH8XZ4LEpRf2sVdA5/sqPO9Qfop70UJyn+/boaPddT5yrq7VUUvTIVJI7q74MMddXR8NB1eXcYvhBpZm0s2w72/o86HFoKvLau/pYaXzjLMdUJ6y0LwtWV9CIIaXtvA8+G9HHV03u5q+K+yH47U0NoRngPv7KjzHDwTLj0bS1BDazfJJlcnOOostC6ysnCT+q80G/sIvFVgeW09D8FPVT0uoP7VfvAD8NjA8pqmuAN+OcYAjso0RbIZ8DGB5TVNcRO8JMaHY9SXSdfa3eeANJimWBLrA7JFiZwIXye+NMUV8CcxP2SRFjXefok7NRjSGZJlWUPvw2/wtNiQirSoXWyMsR28wR7AzzYM0oXw+Y7yK+CLJGeaoqjyrJSdZJD6Ov4+z5y6NJc0Az7NUecHydIUy+v60KNyQHoM3nKI1y7YCFiq0i7uBvgER52vDdKqWn9djhY1Dn4G3n6Ecqm2rF74dvgoR53S0hQxW9RJAZAGW5bSn58QJA27dQ7uIEedjywEX5NKVxCqsY6y+qA+LxFI4+yZ6oH0trWkNan80jygtIUsc5SflgAsDXgehfdx1KkkTRE76tN+Xue2jnTU0Ru1oIbvpt30bBtKhOp5yaaRkts0lic8V1i6dPcIRx2d/l8Y8XtNNEg7OOo8bl1kmmOKnDsO88CaYzejau0hWZqiL7C83oCH4SeTHvwV2BqqsHRVztSEYOmWF80NeXZT6Hd4KflResE9vCnBOlCyGfDNAstHTVPUDWoQ1t3iW+9WNizvlhfd4aerXd+ThqiMfNR6+9LvOOro5OY5JX2H4+F7HZD+kGzlamMgldWiirQsjcwWFbjmqZJteekJLK9pisvgL6RhKvuciZiwzrWWGapfrPy30kBVcSBIrw0aD3PU0XB6cehntq7rTMf7/2iQlktDVdXJLXlg6VjmiYBn6rWSTRCH6hvJ0hQrpcGq8oidsmHpTP8t8DGO9/vcWt9qabiqPgup1yKyQwvC2tSefZ73SSpNkUJ4PlLorlHZ+446nc8f3fIyywlJhwrTuwVSjBa1ccvSxN0hjjoK5xVrYZMd9V6XbFfgBukixTwGLg8sDam3dZR/wZ6L/dJlin1en8LS+bgpFbz3Ygvzu1J1HKxYNqxGpCmaCEo12rrBorD6LRp8UbpcdR5VWhTW35KlKd6QFqjuM2XzwlpnMxTvSkuUwuG/Xlg6NtPjbT6WFimF/VG6LEvXgn8QGDjMbBukVECFwhpoS+CQatfX2Q1q6H7wENHdrfCr0lKleEB9JyxNneus+VJpsVL9TwI6W65LovWIGl3KtVJaLv7LBwYTFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFFWq/hFgADUMN4RzT6/OAAAAAElFTkSuQmCC">
                <p class="toast_content">已评论</p>
            </div>
        </div>
    </div>

    <div id="js_article" class="rich_media">
        
        <div id="js_top_ad_area" class="top_banner">
 
        </div>
                

        <div class="rich_media_inner">
            <div id="page-content">
                <div id="img-content" class="rich_media_area_primary">
                    <h2 class="rich_media_title" id="activity-name">
                        【年度案例】双十一大型电商统一服务架构实战 
                    </h2>
                    <div class="rich_media_meta_list">
                                                <span id="copyright_logo" class="rich_media_meta meta_original_tag">原创</span>
                        						                        <em id="post-date" class="rich_media_meta rich_media_meta_text">2015-11-26</em>

                                                <em class="rich_media_meta rich_media_meta_text">张开涛</em>
                                                <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="javascript:void(0);" id="post-user">高可用架构</a>
                        <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">高可用架构</span>

                        <div id="js_profile_qrcode" class="profile_container" style="display: none;">
                            <div class="profile_inner">
                                <strong class="profile_nickname">高可用架构</strong>
                                <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                                <p class="profile_meta">
                                <label class="profile_meta_label">微信号</label>
                                <span class="profile_meta_value">ArchNotes</span>
                                </p>

                                <p class="profile_meta">
                                <label class="profile_meta_label">功能介绍</label>
                                <span class="profile_meta_value">高可用架构公众号。</span>
                                </p>
                                
                            </div>
                            <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                                <i class="profile_arrow arrow_out"></i>
                                <i class="profile_arrow arrow_in"></i>
                            </span>
                        </div>
                    </div>
                                        
                                                            
                                                            
                    
                    <div class="rich_media_content " id="js_content">
                        
                        <p><span style="font-size: 16px;"><em style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; line-height: 22.4px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);">编者按：高可用架构推出2015年度案例系列文章，分享在架构领域具有典型意义的年度案例，本文根据张开涛分享的大型电商网站应对双十一的架构案例记录。转载请注明高可用架构公众号ArchNotes。</em></span></p><p><span style="font-size: 16px;"><em style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; line-height: 22.4px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><br></em></span></p><blockquote><p><span style="font-size: 16px;"><strong style="color: rgb(62, 62, 62); line-height: 25.6px; white-space: pre-wrap;">张开涛</strong></span></p><p style="max-width: 100%; min-height: 1em; white-space: pre-wrap; color: rgb(62, 62, 62); line-height: 25.6px; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; line-height: 25.6px; font-size: 16px; box-sizing: border-box !important; word-wrap: break-word !important;">2014年加入京东，主要负责商品详情页、详情页统一服务架构与开发工作，设计并开发了多个亿级访问量系统。工作之余喜欢写技术博客，有《跟我学Spring》、《跟我学Spring MVC》、《跟我学Shiro》、《跟我学Nginx+Lua开发》等系列教程，博客访问量500万。开涛之前在高可用架构群分享《亿级商品详情页架构演进技术解密》，受到高度关注，文章阅读数超过1.8万，关注本群公众号，回复29可查看。</span></p></blockquote><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 16px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">京东商品详情页技术方案在之前<a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=210272034&idx=1&sn=3be9d2b53c7fec88716ee8affd2515f8&scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=210272034&amp;idx=1&amp;sn=3be9d2b53c7fec88716ee8affd2515f8&amp;scene=21#wechat_redirect">《亿级商品详情页架构演进技术解密》</a>这篇文章已经为大家揭秘了，接下来为大家揭秘下双十一抗下几十亿流量的商品详情页统一服务架构。<br></span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">这次双十一整个商品详情页在流量增长数倍的情况下，没有出现不可用的情况，服务非常稳定。</span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">统一服务提供了：促销和广告词合并服务、库存状态/配送至服务、延保服务、试用服务、推荐服务、图书相关服务、详情页优惠券服务、今日抄底服务等服务支持。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">其实就是一个大的网关，提供各种服务。但区别于一般网关，它还提供业务逻辑的处理。</span><span style="line-height: 1.6; font-family: sans-serif;">这些服务中有我们自己做的服务实现，而有些是简单做下代理或者接口做了合并输出到页面，我们聚合这些服务到一个系统的目的是打造服务闭环，优化现有服务。并为未来需求做准备，跟着自己的方向走，而不被别人乱了我们的方向。这样一起尽在自己的掌控之中，想怎么玩就看心情了。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">大家在页面中看到的c.3.cn/c0.3.cn/c1.3.cn/cd.jd.com请求都是统一服务的入口。</span><span style="font-family: sans-serif; line-height: 1.6;">我们分别为有状态服务和无状态服务提供了不同的域名，而且域名还做了分区。</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">为什么需要统一服务？</span></strong></span><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">商品详情页虽然只有一个页面，但是依赖的服务众多，我们需要把控好入口，一统化管理。</span></p><p><span style="font-family: sans-serif; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; font-size: 18px;">这样的好处：</span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">统一管理和监控，出问题可以统一降级</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">可以把一些相关接口合并输出，减少页面的异步加载请求</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">一些前端逻辑后移到服务端，前端只做展示，不进行逻辑处理。</span></p></li></ul><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">有了它，所有入口都在我们服务中，我们可以更好的监控和思考我们页面的服务，让我们能运筹于帷幄之中，决胜于千里之外。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">在设计一个高度灵活的系统时，要想着当出现问题时怎么办：是否可降级、不可降级怎么处理、是否会发送滚雪球问题、如何快速响应异常。</span><span style="font-family: sans-serif; line-height: 1.6;">完成了系统核心逻辑只是保证服务能工作，服务如何更好更有效或者在异常情况下能正常工作也是我们要深入思考和解决的问题。</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">整体架构</span></strong></span></p><p><span style="font-family: sans-serif; font-size: 16px;"><br></span></p><p style="text-align: center;"><span style="font-family: sans-serif; font-size: 16px;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhk5JjQFOYtXhdfUeBmqxJM6g7DJsTOmQlwDiaBgmvm2lsctWePu5qvK9g/0?wx_fmt=jpeg" data-ratio="0.758" data-w="500" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 500px !important; visibility: visible !important; height: 379px !important;"><br></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">整体流程</span></strong></span></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="font-family: sans-serif; font-size: 18px;">请求首先进入Nginx，Nginx调用Lua进行一些前置逻辑处理，如果前置逻辑不合法直接返回；然后查询本地缓存，如果命中直接返回数据。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">如果本地缓存不命中数据，则查询分布式Redis集群，如果命中数据，则直接返回。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">如果分布式Redis集群不命中，则会调用Tomcat进行回源处理；然后把结果异步写入Redis集群，并返回。</span></p></li></ol><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">如上是整个逻辑流程，可以看到我们在Nginx这一层做了很多前置逻辑处理，以此来减少后端压力，另外我们Redis集群分机房部署，如下图所示：</span></p><p><span style="font-family: sans-serif; font-size: 16px;"><br></span></p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkZJLE1s69iaFfON4LlOTAj2y3dZAFT9JdqeHQIWBiaoxibKmTo9guibiaTzg/0?wx_fmt=jpeg" data-ratio="0.5452755905511811" data-w="508" src="./【年度案例】双十一大型电商统一服务架构实战_files/640" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">即数据会写一个主集群，然后通过主从方式把数据复制到其他机房，而各个机房读自己的集群；此处没有在各个机房做一套独立的集群来保证机房之间没有交叉访问，这样做的目的是保证数据一致性。</span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">在这套新架构中，我们可以看到Nginx+Lua已经是我们应用的一部分，我们在实际使用中，也是把它做为项目开发，做为应用进行部署。</span></p><p><span style="line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="line-height: 1.6; font-size: 18px;">我们主要遵循如下几个原则设计系统架构：</span><span style="line-height: 1.6; font-size: 16px;"><br></span></p><p><br></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">两种读服务架构模式</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">本地缓存</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">多级缓存</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">统一入口/服务闭环</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">引入接入层</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">前端业务逻辑后置</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">前端接口服务端聚合</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">服务隔离</span></p></li></ul><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">两种读服务架构模式</span></strong></span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">读取分布式Redis数据架构</span></p></li></ul><p><span style="font-family: sans-serif; font-size: 16px;"><br></span></p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhknvOdOKOwjZKgr2kVrzGAiaqccaySwBl5ePbW2Ud9MFYwEiaKPyfAV0Ng/0?wx_fmt=jpeg" data-ratio="0.5452755905511811" data-w="508" src="./【年度案例】双十一大型电商统一服务架构实战_files/640(1)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">可以看到Nginx应用和Redis单独部署，这种方式是一般应用的部署模式，也是我们统一服务的部署模式，此处会存在跨机器、跨交换机或跨机柜读取Redis缓存的情况，但是不存在跨机房情况，</span><span style="font-family: sans-serif; line-height: 1.6;">因为使用容器化，不太好做不跨机柜的应用了。通过主从把数据复制到各个机房。如果对性能要求不是非常苛刻，可以考虑这种架构，比较容易维护。</span></span></p><p><br></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">读取本地Redis数据架构</span></p></li></ul><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">可以看到Nginx应用和Redis集群部署在同一台机器，这样好处可以消除跨机器、跨交换机或跨机柜，甚至跨机房调用。</span><span style="font-family: sans-serif; line-height: 1.6;">如果本地Redis集群不命中， 还是回源到Tomcat集群进行取数据。此种方式可能受限于TCP连接数，可以考虑使用unix domain socket套接字减少本机TCP连接数。如果单机内存成为瓶颈（比如单机内存最大256GB），就需要路由机制来进行Sharding，比如按照商品尾号Sharding，Redis集群一般采用树状结构挂主从部署。</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">本地缓存</span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">我们把Nginx作为应用部署，因此大量使用Nginx共享字典作为本地缓存，Nginx+Lua架构中，使用HttpLuaModule模块的shared dict做本地缓存（ reload不丢失）或内存级Proxy Cache，提升缓存带来的性能并减少带宽消耗。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">之前的详情页架构也是采用这种缓存。</span><span style="font-family: sans-serif; line-height: 1.6;">另外使用一致性哈希（如商品编号/分类）做负载均衡内部对URL重写提升命中率。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">在缓存数据时采用了维度化存储缓存数据，增量获取失效缓存数据（比如10个数据，3个没命中本地缓存，只需要取这3个即可）。</span><span style="font-family: sans-serif; line-height: 1.6;">维度如商家信息、店铺信息、商家评分、店铺头、品牌信息、分类信息等；比如本地缓存30分钟，调用量减少差不多3倍。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">另外使用一致性哈希+本地缓存，如库存数据缓存5秒，平常命中率：本地缓存25%；</span><span style="font-family: sans-serif; line-height: 1.6;">分布式Redis28%；回源47%。一次普通秒杀活动命中率：本地缓存 58%；分布式Redis 15%；回源27%。而某个服务使用一致哈希后命中率提升10%。对URL按照规则重写作为缓存KEY，去随机，即页面URL不管怎么变都不要让它成为缓存不命中的因素。</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">多级缓存</span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">对于读服务，在设计时会使用多级缓存来尽量减少后端服务压力，在统一服务系统中，设计了四级缓存，如下图所示：</span></p><p><span style="font-family: sans-serif; font-size: 16px;"><br></span></p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkJwM7atTctscc3qLANSickTOUgZzpKbMrjGicAKVsb3WN3ibgtWZqyFy4A/0?wx_fmt=jpeg" data-ratio="0.30035971223021585" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 210.2517985611511px !important;"></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 16px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">首先在接入层，会使用Nginx本地缓存，这种前端缓存主要目的是抗热点；根据场景来设置缓存时间。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">如果Nginx本地缓存不命中，接着会读取各个机房的分布式从Redis缓存集群，该缓存主要是保存大量离散数据，抗大规模离散请求，比如使用一致性哈希来构建Redis集群，即使其中的某台机器出问题，也不会出现雪崩的情况。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">如果从Redis集群不命中，Nginx会回源到Tomcat；Tomcat首先读取本地堆缓存，这个主要用来支持在一个请求中多次读取一个数据或者该数据相关的数据。而其他情况命中率是非常低的，或者缓存一些规模比较小但用的非常频繁的数据，如分类，品牌数据；堆缓存时间设置为Redis缓存时间的一半。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">如果Java堆缓存不命中，会读取主Redis集群，正常情况该缓存命中率非常低，不到5%。读取该缓存的目的是防止前端缓存失效之后的大量请求的涌入，导致后端服务压力太大而雪崩。默认开启了该缓存，虽然增加了几毫秒的响应时间，但是加厚了防护盾，使服务更稳当可靠。此处可以做下改善，比如设置一个阀值，超过这个阀值才读取主Redis集群，比如Guava就有RateLimiter API来实现。</span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 16px;"></span></p></li></ul><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">统<span style="font-family: sans-serif;">一入口/服务闭环</span></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">在《亿级商品详情页架构演进技术解密》中已经讲过了数据异构闭环的收益，在统一服务中也遵循这个设计原则，此处主要做了两件事情</span></p><p><br></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="font-family: sans-serif; font-size: 18px;">数据异构，如判断库存状态依赖的套装、配件关系进行了异构，未来可以对商家运费等数据进行异构，减少接口依赖。</span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">服务闭环，所有单品页上用到的核心接口都接入统一服务。</span></p></li></ol><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">有些是查库/缓存然后做一些业务逻辑，有些是http接口调用然后进行简单的数据逻辑处理；还有一些就是做了下简单的代理，并监控接口服务质量。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">引入Nginx接入层</span></strong></span></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">在设计系统时需要把一些逻辑尽可能前置以此来减轻后端核心逻辑的压力。</span><span style="font-family: sans-serif; line-height: 1.6;">另外如服务升级/服务降级能非常方便的进行切换，在接入层做了如下事情：</span></span></p><p><br></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">数据校验/过滤逻辑前置、缓存前置、业务逻辑前置</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">降级开关前置</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">AB测试</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">灰度发布/流量切换</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">监控服务质量</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">限流</span></p></li></ul><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">服务有两种类型的接口：一种是用户无关的接口，另一种则是用户相关的接口。</span><span style="font-family: sans-serif; line-height: 1.6;">因此使用了两种类型的域名c.3.cn/c0.3.cn/c1.3.cn和cd.jd.com。</span></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">当请求cd.jd.com会带着用户cookie信息到服务端。在服务器上会进行请求头的处理，用户无关的所有数据通过参数传递，在接入层会丢弃所有的请求头(保留gzip相关的头)。</span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">而用户相关的会从cookie中解出用户信息然后通过参数传递到后端；也就是后端应用从来就不关心请求头及Cookie信息，所有信息通过参数传递。</span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; font-size: 18px;">有些是查库/缓存然后做一些业务逻辑，有些是http接口调用然后进行简单的数据逻辑处理；还有一些就是做了下简单的代理，并监控接口服务质量。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">请求进入接入层后，会对参数进行校验，如果参数校验不合法直接拒绝这次请求。</span><span style="font-family: sans-serif; line-height: 1.6;">对每个请求的参数进行了最严格的数据校验处理，保证数据的有效性。</span></span></p><p><span style="font-family: sans-serif; font-size: 18px;"><br></span></p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkE1QxKbj8ONLqC6sRn8qFSicdfAjHmformuvkrk81QOt8LlHtXkkJYbA/0?wx_fmt=jpeg" data-ratio="0.16204690831556504" data-w="469" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 469px !important; visibility: visible !important; height: 76px !important;"><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">如图所示，我们对关键参数进行了过滤，如果这些参数不合法就直接拒绝请求。</span><span style="font-family: sans-serif; line-height: 1.6;">另外还会对请求的参数进行过滤然后重新按照固定的模式重新拼装URL调度到后端应用。此时URL上的参数是固定的而且是有序的，可以按照URL进行缓存</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">缓存前置</span></strong></span></p><p><span style="line-height: 1.6; font-family: sans-serif;"></span><span style="font-size: 18px; line-height: 1.6; font-family: sans-serif;">很多缓存都前置到了接入层，来进行热点数据的削峰，而且配合一致性哈希可能提升缓存的命中率。在缓存时按照业务来设置缓存池，减少相互之间的影响和提升并发，使用Lua读取共享字典来实现本地缓存。</span><br></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">业务逻辑前置</span></strong></span><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">  在接入层直接实现了一些业务逻辑，原因是当在高峰时出问题，可以在这一层做一些逻辑升级。</span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">  后端是Java应用，当修复逻辑时需要上线，而一次上线可能花费数十秒时间启动应用。重启应用后Java应用JIT的问题会存在性能抖动的问题。可能因为重启造成服务一直启动不起来的问题。而在Nginx中做这件事情，改完代码推送到服务器，重启只需要秒级，而且不存在抖动的问题。这些逻辑都是在Lua中完成。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">降级开关前置</span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">降级开关分为这么几种：</span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">接入层开关和后端应用开关。<span style="font-family: sans-serif; line-height: 20.3636px; font-size: 16px;">在接入层设置开关的目的是防止降级后流量还无谓的打到后端应用。</span></span></p><p><span style="font-family: sans-serif; font-size: 18px;"></span></p></li><li><p><span style="font-family: sans-serif; line-height: 20.3636px; font-size: 18px;">总开关是对整个服务降级，比如库存服务默认有货。<br></span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">原子开关是<span style="font-size: 16px; font-family: sans-serif; line-height: 20.3636px;">整个服务中的其中一个小服务降级，比如库存服务中需要调用商家运费服务，如果只是商家运费服务出问题了，此时可以只降级商家运费服务。</span></span></p></li></ul><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"> 另外还可以根据服务重要程度来使用超时自动降级机制。使用init_by_lua_file初始化开关数据，共享字典存储开关数据。提供API进行开关切换（switch_get(“stock.api.not.call”) ~= “1”）。可以实现：秒级切换开关、增量式切换开关（可以按照机器组开启，而不是所有都开启）、功能切换开关、细粒度服务降级开关、非核心服务可以超时自动降级。</span></p><p><span style="line-height: 1.6; font-family: sans-serif;"><br></span></p><p><span style="font-size: 18px; line-height: 1.6; font-family: sans-serif;"> 比如双十一期间有些服务出问题了，进行过大服务和小服务的降级操作，这些操作对用户来说都是无感知的。有一个后台可以直接控制开关，切换非常方便。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">AB测试</span></strong></span><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"> 对于服务升级，最重要的就是能做AB测试，然后根据AB测试的结果来看是否切新服务。这一块算是家常便饭。有了接入层非常容易进行这种AB测试；不管是上线还是切换都非常容易。</span></p><p><span style="line-height: 1.6; font-family: sans-serif;"><br></span></p><p><span style="font-size: 18px; line-height: 1.6; font-family: sans-serif;">可以动态改Nginx配置、推送然后reload。也可以在Lua中根据请求的信息调用不同的服务或者upstream分组即可完成AB测试。因为有了Lua，可以实现复杂逻辑的编程，比如根据商品属性进行切换。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">灰度发布/流量切换</span></strong></span><span style="font-size: 18px;"><strong><span style="font-size: 16px; font-family: sans-serif;"></span></strong><strong><span style="font-size: 16px; font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"> 对于一个灵活的系统来说，能随时进行灰度发布和流量切换是非常重要的一件事情。比如验证新服务器是否稳定，或者验证新的架构是否比老架构更优秀，有时候只有在线上跑着才能看出是否有问题。</span></p><p><br></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">在接入层也是通过配置或Lua代码来完成这些事情。灵活性非常好，可以设置多个upstream分组，然后根据需要切换分组即可。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">监控服务质量</span></strong></span><span style="font-size: 18px;"><strong><span style="font-size: 16px; font-family: sans-serif;"></span></strong><strong><span style="font-size: 16px; font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"> 对于一个系统最重要的是要有双眼睛能盯着系统来尽可能早的发现问题。</span><span style="font-family: sans-serif; font-size: 18px; line-height: 1.6;">在接入层会对请求进行代理，记录status、request_time、response_time来监控服务质量，比如根据调用量、状态码是否是200、响应时间来告警。 这些都是通过Nginx子请求记录的。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">限流</span></strong></span><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">系统中存在的主要限流逻辑是：<br></span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">对于大多数请求按照IP请求数限流，对于登陆用户按照用户限流<br></span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">对于读取缓存的请求不进行限流，只对打到后端系统的请求进行限流<br></span></p></li><li><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">还可以限制用户访问频率，比如使用ngx_lua中的ngx.sleep对请求进行休眠处理，让刷接口的速度降下来或者种植cookie token之类的，必须按照流程访问。当然还可以对爬虫/刷数据的请求返回假数据来减少影响。</span></p></li></ul><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">前端业务逻辑后置</span></strong></span><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"> 前端JS应该尽可能少的业务逻辑和一些切换逻辑，因为前端JS一般推送到CDN。假设逻辑出问题了，需要更新代码上线，推送到CDN然后失效各个边缘CDN节点或者通过版本号机制在服务端模板中修改版本号上线。这两种方式都存在效率问题，假设处理一个紧急故障用这种方式处理完了可能故障也恢复了。</span></p><p><span style="line-height: 1.6; font-family: sans-serif;"><br></span></p><p><span style="font-size: 18px; line-height: 1.6; font-family: sans-serif;">因此我们的观点是前端JS只拿数据展示，所有或大部分逻辑交给后端去完成，即静态资源CSS/JS CDN，动态资源JSONP。前端JS瘦身，业务逻辑后置。这种方案可能在我们的场景下更适用。</span></p><p><span style="line-height: 1.6; font-family: sans-serif;"><br></span></p><p><span style="font-size: 18px; line-height: 1.6; font-family: sans-serif;">在双十一期间某些服务出问题了，不能更新商品信息。此时秒杀商品如果不打标就不能购买。因此我们在服务端完成了这件事情，整个处理过程只需要几十秒就能搞定，避免了商品不能被秒杀的问题。而如果在JS中完成需要耗费非常长的时间，因为JS在客户端还有缓存时间，而且一般缓存时间非常长。这也是详情页动态化后能灵活的应对各种问题。</span></p><p><br></p><p><strong><span style="font-size: 20px; font-family: sans-serif;">前端接口服务端聚合</span></strong></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">商品详情页上依赖的服务众多，一个类似的服务需要请求多个不相关的服务接口，造成前端代码臃肿，判断逻辑众多。</span><span style="font-family: sans-serif; line-height: 1.6;">而我无法忍受这种现状，我想要的结果就是前端异步请求我的一个API，我把相关数据准备好发过去，前端直接拿到数据展示即可。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">所有或大部分逻辑在服务端完成而不是在客户端完成。</span><span style="font-family: sans-serif; line-height: 1.6;">因此在接入层使用Lua协程机制并发调用多个相关服务然后最后把这些服务进行了合并。比如推荐服务：最佳组合、推荐配件、优惠套装。</span></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;">通过</span></p><p><span style="font-size: 18px;">http://c.3.cn/recommend?methods=accessories,suit,combination&amp;sku=1159330&amp;cat=6728,6740,12408&amp;lid=1&amp;lim=6</span></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">进行请求获取聚合的数据。</span><span style="font-family: sans-serif; line-height: 1.6;">这样原来前端需要调用三次的接口只需要一次就能吐出所有数据。我们对这种请求进行了API封装，如下图所示 :</span></span></p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkPg8vO9ODruJzaQDK9fDgQkmdupNqQ9aFFzT57S3Z4ankiaibsayx7bOw/0?wx_fmt=jpeg" data-ratio="0.4982014388489209" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 348.7410071942446px !important;"><br></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">比如库存服务，判断商品是否有货需要判断：1、主商品库存状态、2、主商品对应的套装子商品库存状态、主商品附件库存状态及套装子商品附件库存状态。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">套装商品是一个虚拟商品，是多个商品绑定在一起进行售卖的形式。</span><span style="font-family: sans-serif; line-height: 1.6;">如果这段逻辑放在前段完成，需要多次调用库存服务，然后进行组合判断，这样前端代码会非常复杂，凡是涉及到调用库存的服务都要进行这种判断。因此我们把这些逻辑封装到服务端完成。另外对这些关系数据进行了异构存储，减少与其他系统进行交互带来的未知性能开销。这样只需要读取自己的Redis就能拿到关系。</span></span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">前端请求</span></p><p><span style="font-family: sans-serif; color: blue; text-decoration: underline; font-size: 18px;"></span>http://c0.3.cn/stock?skuId=1856581&amp;venderId=0&amp;cat=9987,653,655&amp;area=1_72_2840_0&amp;buyNum=1&amp;extraParam={%22originid%22:%221%22}&amp;ch=1&amp;callback=getStockCallback</p><p><span style="font-family: sans-serif; font-size: 18px;">然后服务端计算整个库存状态，而前端不需要做任何调整。</span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">在服务端使用Lua协程并发的进行库存调用，如下图所示 : </span></p><p><br></p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkqxVib395ZmO1kRY2WtcCQjmVC3jCYjOib3rUcqwAgtib7iamsAHTk26Tibg/0?wx_fmt=jpeg" data-ratio="0.12589928057553956" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 88.12949640287769px !important;"><br></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">另外接口也会吐出相关的附件/套装的库存状态，方便前台万一需要时使用。</span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">另外比如今日抄底服务，调用接口太多，如库存、价格、促销等都需要调用，因此也使用这种机制把这几个服务在接入层合并为一个大服务，对外暴露。</span></p><p>http://c.3.cn/today?skuId=1264537&amp;area=1_72_2840_0&amp;promotionId=182369342&amp;cat=737,752,760&amp;callback=jQuery9364459&amp;_=1444305642364</p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">整个详情页的未来就是首屏尽量一个大服务提供所有数据，各子接口设置超时时间，在超时后，单独发送一次请求查询相关数据。</span></p><p><span style="font-family: sans-serif; font-size: 18px;">目前合并的主要有：促销和广告词合并、配送至相关服务合并。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">服务隔离</span></strong></span></p><p><span style="font-size: 18px; font-family: sans-serif; line-height: 1.6;">服务隔离的目的是防止因为某些服务抖动而造成整个应用内的所有服务不可用。<br></span></p><p><span style="font-family: sans-serif; line-height: 1.6; font-size: 18px;"><br></span></p><p><span style="font-size: 18px; font-family: sans-serif; line-height: 1.6;">可总结为：<br></span></p><ul class=" list-paddingleft-2" style="list-style-type: square;"><li><p><span style="font-family: sans-serif; font-size: 18px;">应用内线程池隔离</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">部署/分组隔离</span></p></li><li><p><span style="font-family: sans-serif; font-size: 18px;">拆应用隔离</span></p><p><span style="font-family: sans-serif; font-size: 18px;"></span></p></li></ul><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">应用内线程池隔离，采用了Servlet3异步化，并为不同的请求按照重要级别分配线程池，这些线程池是相互隔离的。</span><span style="font-family: sans-serif; line-height: 1.6;">也提供了监控接口以便发现问题及时进行动态调整，该实践可以参考我博客的《商品详情页系统的Servlet3异步化实践》。目前Java系统也全面升级为JDK8+Servlet3。</span></span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">部署/分组隔离，意思是为不同的消费方提供不同的分组，不同的分组之间不相互影响，以免因为大家使用同一个分组导致有些人乱用导致整个分组服务不可用。</span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">拆应用隔离，如果一个服务调用量巨大，那便可以把这个服务单独拆出去，做成一个应用，减少因其他服务上线或者重启导致影响本应用。</span></p><p><br></p><p><span style="font-size: 20px;"><strong><span style="font-family: sans-serif;">其他</span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">对于http 304一些服务都设置了，如延保，设置了一个容忍时间，如果在这段时间内重复请求，会直接返回304，而不查缓存或回源处理。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">超时时间/重试，</span><span style="font-family: sans-serif; line-height: 1.6;">对于一个系统来说，超时时间是必须设置的，主要有如TCP连接/读/写超时时间、连接池超时时间，还有相关的重试时机/次数。对于一个网络服务，需要根据实际情况设置TCP连接/读/写超时时间，如果不设置很可能会在网络出问题时服务直接挂断，比如连接Redis都设置在150ms以内。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">还有如果使用Nginx，还需要考虑Nginx超时时间、upstream超时时间和业务超时时间。</span><span style="font-family: sans-serif; line-height: 1.6;">假设Nginx超时时间是5s、upstream超时时间是6s，而业务的超时时间是8s，那么假设业务处理了7s，那么upstream超时时间到了需要进行下一个upstream的重试，但是Nginx总的超时时间是5s，所以就无法重试了</span></span></p><p><br></p><p><span style="font-family: sans-serif; font-size: 18px;">连接池也需要设置获取连接的等待时间，如果不设置会有很多线程一直在等待，之前自己实现连接池时，会去发现是否网络错误，如果网络错误就没必要等待连接了，而立即失败即可。</span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">还需要考虑服务失败重试时机，比如是立即重试，还是指数式重试；还有重试次数，是一次性重试三次还是指数式等待时间后进行一次次的重试。</span><span style="font-family: sans-serif; line-height: 1.6;">比如HttpClient（DefaultHttpRequestRetryHandler）默认会立即进行三次重试。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">CDN缓存评价使用了版本化。</span><span style="font-family: sans-serif; line-height: 1.6;">对于版本化的意思是对于一些内容可以通过版本化机制设置更长的超时时间，而且固定URL顺序，这样相同的URL请求只要版本不变就会更有效的命中CDN数据。</span></span></p><p><br></p><p><span style="font-size: 18px;"><span style="font-family: sans-serif;">版本可以通过消息推送机制通知相关系统。</span><span style="font-family: sans-serif; line-height: 1.6;">比如评价数据的版本化，可以每隔几分钟推送变更了版本的商品更新版本号，还要注意消息排重。另外为了发现是哪台服务器出现了问题，都要在响应响应头记录服务器真实IP。这样出问题后，直接定位到哪台服务器出问题了。还有如对于整个系统无法保证整个系统不出现脏数据，所以需要提供刷脏数据的接口，以便出现问题时进行数据的更新或删除。</span></span></p><p><br></p><p><span style="font-size: 20px;"><strong style="max-width: 100%; color: rgb(62, 62, 62); line-height: 25.6px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);">Q&amp;A</strong></span><span style="font-size: 16px;"><strong style="max-width: 100%; color: rgb(62, 62, 62); line-height: 25.6px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"></strong><strong style="max-width: 100%; color: rgb(62, 62, 62); line-height: 25.6px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;"><strong style="max-width: 100%; color: rgb(62, 62, 62); line-height: 25.6px; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);">Q1 : </strong><strong>逻辑由前段向后端迁移后，后端压力对比上升了多少？还是降低了？</strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">我个人从来不认为后端会有压力，我们的某服务响应时间在10-100ms之间，8CPU容器压测在10000~20000qps。另外后端是比较容易水平扩展的。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q2 : 获取多维度数据时，部分维度需要回源，这时候逻辑上会阻塞。是如何做到大并发下的高吞吐？基于事件驱动网络IO？协程？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">Nginx的非阻塞IO+Lua协程；另外我们使用Nginx共享字典，按照不同的维度开辟共享字典，对于大流量的可以做sharding，目前没有做sharding，只是按照维度分离共享字典，防止LRU和锁竞争。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q3 : 多级缓存如何保证一致性？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">1、缓存数据时间都非常短；2、有些可以持久化的数据是通过消息通知变更推送；3、不能保证100%没问题，也提供了清理接口进行清理。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q4 : 接入层的本地缓存用啥存的也是redis么？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">ngx_lua提供的共享字典，目前使用中没有遇到任何问题，reload不丢，减少了部署Redis的繁琐。也考虑过Java堆外缓存使用Local Redis或Local Nginx。</span></p><p><br></p><p><strong style="font-size: 18px; line-height: 1.6;"><span style="font-family: sans-serif;">Q5 : "另外对这些关系数据进行了异构存储，减少与其他系统进行交互带来的未知性能开销 这样只需要读取自己的Redis就能拿到关系"这个异构存储是怎么维护和更新的?</span></strong><br></p><p><span style="font-family: sans-serif; font-size: 18px;">数据都是KV存储，复杂的数据通过Redis Lua脚本减少交互。异构数据都是通过消息对接的。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q6 : 请问商品数量这种变化相对较快的数据如何缓存的，如何防止超卖，特别对于热门商品？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">超卖通过库存系统的服务进行控制，详情页是前端展示库存，主要是展示商品、价格、库存都是通过消息通知变更的。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q7 ：秒杀预热，开始，结束后：几个阶段的库存，价格相关信息如果管理？如何防止超卖和缺货？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">秒杀是单独的服务实现，跟详情页是分开实现；另外据我知道的 1、秒杀是和主交易流程隔离的，防止相互影响；2、库存扣减通过Redis。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q8 ：聚合服务的超时时间如何设置？根据所有依赖服务的超时进行设置？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">几个点：1、Nginx proxy timeout；2、客户端timeout，如HttpClient；3、每个服务都是单独设置超时时间。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q9 ：服务的超时时间统一管理么，某个业务超时时间变化可能影响很大，怎么控制？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">根据业务去控制，不同的业务要求不一样；比如库存/配送至依赖的商家配送时效，正常100ms以内，如果超过这个时间，排除网络问题，相关系统肯定出问题了，可以进行优雅的降级。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q10 ：用户鉴权也是用ngx_lua共享字典做的么？用户信息这种敏感信息如果在接入暴露应该会产生安全隐患，但不在接入做放到后面核心域又会拖慢返回速度？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">我们封装了一个API，专门在接入层对一些服务进行鉴权，不对用户信息的输出和暴露，这样能更好的控制而且可以尽早的发现非法请求；拖慢速度的情况，因为在接入层验证，这个就不是问题了。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="font-family: sans-serif;">Q11 ：秒杀的商品库存 跟正常商品库存是分开的吗？</span></strong><strong><span style="font-family: sans-serif;"></span></strong><strong><span style="font-family: sans-serif;"></span></strong></span></p><p><span style="font-family: sans-serif; font-size: 18px;">对，包括整个交易流程也是分离的，可以走下流程就看到了，而且必须按照正常用户步骤去访问才可以。</span></p><p><span style="font-family: sans-serif; font-size: 18px;"><br></span></p><p><span style="font-family: sans-serif; font-size: 18px;">参考文章：<a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=210272034&idx=1&sn=3be9d2b53c7fec88716ee8affd2515f8&scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=210272034&amp;idx=1&amp;sn=3be9d2b53c7fec88716ee8affd2515f8&amp;scene=21#wechat_redirect">亿级商品详情页架构演进技术解密 | 高可用架构系列</a></span></p><p><br></p><p style="max-width: 100%; min-height: 1em; white-space: normal; color: rgb(62, 62, 62); font-size: 1em; line-height: 23.2727px; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 16px; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><hr style="max-width: 100%; color: rgb(62, 62, 62); line-height: 23.2727px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><p style="max-width: 100%; min-height: 1em; white-space: normal; color: rgb(62, 62, 62); font-size: 1em; line-height: 23.2727px; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; white-space: pre-wrap; color: rgb(62, 62, 62); line-height: 23.2727px; text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOMfMQrqmrMAHRUk5JtXOIeibLAUalzOia8BCKUe0CUtIibZwj326FujB2ibE2CgXyRJ5nCgft8beJbS6w/0?wx_fmt=png" data-ratio="0.8888888888888888" data-w="360" style="box-sizing: border-box !important; word-wrap: break-word !important; width: auto !important; visibility: visible !important; height: auto !important;" _width="auto" src="./【年度案例】双十一大型电商统一服务架构实战_files/640(2)"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 16px; box-sizing: border-box !important; word-wrap: break-word !important;"><em style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="color: rgb(136, 136, 136); max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">本文策划陈刚、编辑王杰，转载请注明来自"高可用架构(ArchNotes)"微信公众号。高可用架构聚焦互联网架构分享，咨询投稿或报名分享请回复“speaker”。</span></em></span></p><p style="max-width: 100%; min-height: 1em; white-space: normal; color: rgb(62, 62, 62); font-size: 1em; line-height: 23.2727px; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; min-height: 1em; white-space: normal; color: rgb(62, 62, 62); font-size: 1em; line-height: 23.2727px; text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><img data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOM0ZXPv0OM1TG3c0PL6ktTotB03sC6rMVUXee4eziblLNrp8I6iawfltdx6XzTa8p2ibXP9GplibfQRgA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-ratio="0.5557553956834532" data-w="" style="box-sizing: border-box !important; word-wrap: break-word !important; width: auto !important; visibility: visible !important; height: auto !important;" _width="auto" src="./【年度案例】双十一大型电商统一服务架构实战_files/640(3)"></p><p><br></p>
                    </div>
                    <script type="text/javascript">
                        var first_sceen__time = (+new Date());

                        if ("" == 1 && document.getElementById('js_content'))
                            document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });

                                        (function(){
                            if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                                var link = document.createElement('link');
                                var head = document.getElementsByTagName('head')[0];
                                link.rel = 'stylesheet';
                                link.type = 'text/css';
                                link.href = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
                                head.appendChild(link);
                            }
                        })();
                    </script>
                    <link rel="stylesheet" type="text/css" href="./【年度案例】双十一大型电商统一服务架构实战_files/page_mp_article_improve_combo29ab01.css">
                                        
                                        
                                        <div class="rich_media_tool" id="js_toobar3">
                                                                    <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                        <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                            <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                        </span>

                        <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="javascript:void(0);">举报</a>

                    </div>
                </div>

                <div class="rich_media_area_extra">

                    
                                        <div class="mpda_bottom_container" id="js_bottom_ad_area">
                        
                    </div>

                    
                    <div id="js_iframetest" style="display:none;"></div>

                    
                                        <div class="rich_media_extra" id="js_cmt_area" style="display:none">

                        <div class="discuss_container" id="js_cmt_main" style="display:none">
                            <div class="rich_tips with_line title_tips discuss_title_line">
                                <span class="tips">精选评论</span>
                            </div>
                            <p class="tips_global tc title_bottom_tips" id="js_cmt_nofans1" style="display:none;">关注该公众号可参与评论</p>
                            <p class="discuss_icon_tips title_bottom_tips tr" id="js_cmt_addbtn1" style="display:none">
                                
                                                                <a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=401843895&idx=1&sn=2d4efc3f1c8ffc56c99d28150536fe93&scene=22&srcid=1126u8JqMh5cO4VeIAxoEoyz#comment">写评论<img class="icon_edit" src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_edit25ded2.png" alt=""></a>
                                                            </p>
                            <ul class="discuss_list" id="js_cmt_list"></ul>
                        </div>


                        <div class="tips_global rich_split_tips tc" id="js_cmt_nofans2" style="display:none;">
                            关注该公众号可参与评论
                        </div>

                        <p class="discuss_icon_tips rich_split_tips tr" id="js_cmt_addbtn2" style="display:none">
                            
                                                        <a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=401843895&idx=1&sn=2d4efc3f1c8ffc56c99d28150536fe93&scene=22&srcid=1126u8JqMh5cO4VeIAxoEoyz#comment">写评论<img class="icon_edit" src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_edit25ded2.png" alt=""></a>
                                                    </p>

                        <p class="rich_split_tips tc tips_global" id="js_cmt_tips" style="display:none;"></p>


                        <div class="rich_tips tips_global loading_tips" id="js_cmt_loading">
                            <img src="./【年度案例】双十一大型电商统一服务架构实战_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                            <span class="tips">加载中</span>
                        </div>

                        <div class="rich_tips with_line tips_global" id="js_cmt_statement" style="display:none">
                            <span class="tips">以上评论由公众帐号筛选后显示</span>
                        </div>

                        <p class="rich_split_tips tc" id="js_cmt_qa" style="display:none;">
                            <a href="http://kf.qq.com/touch/sappfaq/150211YfyMVj150313qmMbyi.html?scene_id=kf264">
                                了解评论功能详情
                            </a>
                        </p>

                    </div>
                                    </div>
               
            </div>
            <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display: block;">
                <div class="qr_code_pc_inner">
                    <div class="qr_code_pc">
                        <img id="js_pc_qr_code_img" class="qr_code_pc_img" src="./【年度案例】双十一大型电商统一服务架构实战_files/qrcode">
                        <p>微信扫一扫<br>关注该公众号</p>
                    </div>
                </div>
            </div>

        </div>
    </div>


        
        <script>window.moon_map = {"appmsg/emotion/caret.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/caret278965.js","appmsg/emotion/map.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/map278965.js","appmsg/emotion/textarea.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/textarea27cdc5.js","appmsg/emotion/nav.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/nav278965.js","appmsg/emotion/common.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/common278965.js","appmsg/emotion/slide.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/slide27cdc5.js","biz_wap/jsapi/cardticket.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/cardticket275627.js","pages/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report292ed8.js","pages/music_player.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_player298e98.js","pages/loadscript.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/loadscript292ed8.js","appmsg/emotion/dom.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/dom278965.js","appmsg/emotion/emotion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/emotion27f4f1.js","biz_wap/utils/hashrouter.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/hashrouter2805ea.js","a/gotoappdetail.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/gotoappdetail29b1f8.js","a/ios.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/ios275627.js","a/android.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/android275627.js","a/profile.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/profile29b1f8.js","a/card.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/card29b1f8.js","biz_wap/utils/position.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/position29b1f8.js","appmsg/a_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a_report282222.js","biz_common/utils/monitor.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/monitor27f4f1.js","biz_common/utils/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/report275627.js","biz_common/utils/huatuo.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/huatuo293afc.js","biz_common/utils/cookie.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/cookie275627.js","pages/voice_component.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_component298e98.js","new_video/ctl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/ctl292ed8.js","biz_common/utils/spin.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/spin275627.js","biz_wap/jsapi/pay.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/pay275627.js","appmsg/reward_entry.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/reward_entry29bb2b.js","appmsg/comment.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment29f4e9.js","appmsg/like.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/like29f4e9.js","appmsg/a.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a29ff2a.js","pages/version4video.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/version4video292ed8.js","biz_wap/utils/storage.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/storage275627.js","biz_common/tmpl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/tmpl275627.js","biz_common/ui/imgonepx.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/ui/imgonepx275627.js","biz_common/dom/attr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/attr275627.js","biz_wap/utils/ajax.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/ajax297cdb.js","biz_common/utils/string/html.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/string/html29f4e9.js","appmsg/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report29f4e9.js","biz_common/dom/class.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/class275627.js","appmsg/report_and_source.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report_and_source29f4e9.js","appmsg/page_pos.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/page_pos29f4e9.js","appmsg/cdn_speed_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_speed_report275627.js","appmsg/voice.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voice29ef1e.js","appmsg/qqmusic.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/qqmusic29ef1e.js","appmsg/iframe.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/iframe2989c1.js","appmsg/review_image.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/review_image29d138.js","appmsg/outer_link.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/outer_link275627.js","biz_wap/jsapi/core.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/core275627.js","biz_common/dom/event.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/event275627.js","appmsg/copyright_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/copyright_report2805ea.js","appmsg/pay_for_reading.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/pay_for_reading28f721.js","appmsg/async.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/async29ff2a.js","biz_wap/ui/lazyload_img.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/ui/lazyload_img275627.js","biz_common/log/jserr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/log/jserr2805ea.js","appmsg/share.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share29bb2b.js","biz_wap/utils/mmversion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/mmversion275627.js","appmsg/cdn_img_lib.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_img_lib275627.js","biz_common/utils/url/parse.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/url/parse275627.js","biz_wap/utils/device.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/device27f46f.js","appmsg/index.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/index29f4e9.js"};window.moon_crossorigin = true;</script><script type="text/javascript" src="./【年度案例】双十一大型电商统一服务架构实战_files/moon275627.js" crossorigin=""></script>
    <script id="voice_tpl" type="text/html">        
        <span id="voice_main_<#=voiceid#>_<#=posIndex#>" class="db audio_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="audio_wrp db">
                <span id="voice_play_<#=voiceid#>_<#=posIndex#>" class="audio_play_area">
                    <i class="icon_audio_default"></i>
                    <i class="icon_audio_playing"></i>
                    <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/audio/icon_audio_unread26f1f1.png" alt="" class="pic_audio_default">
                </span>
                <span class="audio_length tips_global"><#=duration_str#></span>
                <span class="db audio_info_area">
                    <strong class="db audio_title"><#=title#></strong>
                    <span class="audio_source tips_global"><#if(window.nickname){#>来自<#=window.nickname#><#}#></span>
                </span>
                <span id="voice_progress_<#=voiceid#>_<#=posIndex#>" class="progress_bar" style="width:0px;"></span>
            </span>
        </span>
    </script>

    <script id="qqmusic_tpl" type="text/html">        
        <span id="qqmusic_main_<#=comment_id#>_<#=posIndex#>" class="db qqmusic_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="db qqmusic_wrp">
                <span class="db qqmusic_bd">
                    <span id="qqmusic_play_<#=musicid#>_<#=posIndex#>" class="play_area">
                        <i class="icon_qqmusic_switch"></i>
                        <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_default.2x26f1f1.png" alt="" class="pic_qqmusic_default">
                        <img src="<#=music_img#>" data-autourl="<#=audiourl#>" data-musicid="<#=musicid#>" class="qqmusic_thumb" alt="">
                    </span>
                                        <a id="qqmusic_home_<#=musicid#>_<#=posIndex#>" href="javascript:void(0);" class="access_area">
                        <span class="qqmusic_songname"><#=music_name#></span>
                        <span class="qqmusic_singername"><#=singer#></span>
                        <span class="qqmusic_source"><img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_source263724.png" alt=""></span>
                    </a>
                </span>
            </span>       
        </span>
    </script>

    <script id="t_cmt" type="text/html">
        <li class="discuss_item" id="cid<# if (is_from_me == 1) { #><#=my_id#><# } else { #><#=content_id#><# } #>">
            <# if(is_elected == 1){ #>
            <div class="discuss_opr">
                <span class="media_tool_meta tips_global meta_praise js_comment_praise <# if(like_status == 1){ #>praised<# } #>" data-status="<#=like_status#>" data-content-id='<#=content_id#>'>
                    <i class="icon_praise_gray"></i>
                    <span class="praise_num"><# if(like_num_format !== 0){ #><#=like_num_format#> <# } #></span>
                </span>
            </div>
            <# } #>
            <div class="user_info">
                <strong class="nickname"><#=nick_name#><# if(is_from_friend == 1){ #>(朋友)<# } #></strong>
                <img class="avatar" src="<#=logo_url#>">
            </div>
            <div class="discuss_message">
                <span class="discuss_status"><#=status#></span>
                <div class="discuss_message_content">
                <#=content#>
                </div>
            </div>
            <p class="discuss_extra_info">
                <#=time#>               
                <# if (is_from_me == 1) { #>
                <a class="discuss_del js_del" href="javascript:;" data-my-id="<#=my_id#>" data-content-id="<#=content_id#>">删除</a>
                <# } #>
            </p>
            <# if(reply && reply.reply_list && reply.reply_list.length > 0){ #>
                <div class="reply_result">
                    <div class="nickname">作者回复</div>
                    <div class="discuss_message">
                        <div class="discuss_message_content">
                        <#=reply.reply_list[0].content#>
                        </div>
                    </div>
                    <p class="discuss_extra_info"><#=reply.reply_list[0].time#></p>
                </div>
            <# } #>
                
        </li>
    </script>

    <script type="text/html" id="img_copyright_tpl">
        <span class="original_img_wrp">            
            <span class="tips_global">来自: <#=source_nickname#></span>
        </span>    
    </script>

  <script id="t_ad" type="text/html">
    <div class="rich_media_extra" id="gdt_area">
        <# if(pos_type==0){ #>
        <div class="rich_tips with_line title_tips">
            <span class="tips">广告</span>
        </div>
        <# } #>
        <div class="js_ad_link extra_link" data-type="<#=type#>" data-ticket="<#=ticket#>" data-url="<#=url#>" data-rl="<#=rl#>"  data-aid="<#=aid#>" data-pt="<#=pt#>" data-tid="<#=traceid#>" data-gid="<#=group_id#>" data-apurl="<#=apurl#>">




            <# if(pt==1){ #>
            <#=hint_txt#>
            <img class="icon_arrow_gray" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_arrow_gray1ef6d4.png">
            <img class="icon_loading_white icon_after" style="display:none;" id="loading_<#=traceid#>" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_loading_white2805ea.gif">
            <# }else if(pt==2){ #>
            
            <# if (logo.indexOf("http://mmsns.qpic.cn/") == 0){ #>
            <div class="brand_logo"><img src="<#=logo#>" alt="logo图片"></div>
            <# } #>
            <img class="appmsg_banner" src="<#=image_url#>">
            <# if(watermark_type!=0){ #><i class="promotion_tag"><# if(watermark_type==1){ #>商品推广<# }else if (watermark_type==2){ #>活动推广<# } #></i><# } #>
            <# }else if(pt==7){ #>
            
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">
                    <div class="preview_group_info">
                        <strong class="preview_group_title2"><#=hint_txt#></strong>
                        <div class="preview_group_desc"><#=ad_desc#></div>
                        <img src="<#=image_url#>" alt="" class="preview_card_avatar">
                    </div>
                </div>
            </div>
            <# }else if(pt==100){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=biz_info.nick_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <# if(!!biz_info.head_img){ #>
                        <img src="<#=biz_info.head_img#>" alt="" class="preview_group_avatar br_radius">
                        <# }else{ #>
                        <img class="preview_group_avatar br_radius" src="http://mmbiz.qpic.cn/mmbiz/a5icZrUmbV8p5jb6RZ8aYfjfS2AVle8URwBt8QIu6XbGewB9wiaWYWkPwq4R7pfdsFibuLkic16UcxDSNYtB8HnC1Q/0" alt="<#=biz_info.nick_name#>">
                        <# } #>                                 
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_view_profile_<#=pos_type#>" <# if(biz_info.is_subscribed == 0){ #>style="display:none"<# } #> class="btn btn_inline btn_primary btn_line js_ad_btn" href="javascript:void(0);">查看</a>
                        <a id="js_add_contact_<#=pos_type#>" data-url="<#=url#>" data-type="<#=type#>" data-tid="<#=traceid#>" data-rl="<#=rl#>" <# if(biz_info.is_subscribed ==1){ #>style="display:none"<# } #> class="btn btn_inline btn_line  btn_primary js_ad_btn" href="javascript:void(0);">关注</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==102){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_group_avatar br_radius">
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn btn_download" href="javascript:void(0);">下载</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==101){ #>
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">                            
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_card_avatar">                               
                    </div>
                    <div class="preview_group_opr">
                        <a href="javascript:void(0);" id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn">下载</a>
                    </div>
                </div>                        
            </div>
            <# }else if(pt==103||pt==104){ #>
            <div class="preview_group obvious_app">
                <div class="preview_group_inner">
                    <div class="pic_app">
                        <img src="<#=image_url#>" alt="">
                    </div>
                    <div class="info_app">
                        <p class="name_app"><#=app_info.app_name#></p>
                        <# if(pt==103){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._category#></span><em>|</em><span class="compacity"><#=app_info._app_size#></span></p>
                        <# } else if(pt==104){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._app_size#></span><em>|</em><span class="compacity"><#=app_info._down_count#></span></p>
                        <# } #>
                        
                        <p class="grade_app" id="js_app_rating_<#=pos_type#>">
                            
                            <span class="js_stars stars" style="display:none;"></span>
                            
                            <span class="js_scores scores">暂无评分</span>
                        </p>
                        <div class="dm_app">
                            <a href="javascript:void(0);" id="js_appdetail_action_<#=pos_type#>" class="ad_btn btn_download js_ad_btn">下载</a>
                            <p class="extra_info">来自<# if(pt==103){ #>App Store<# }else{ #>腾讯应用宝<# } #></p>
                        </div>
                    </div>
                </div>            
            </div>
            <# }else if(pt==105){ #>
            <div class="mpda_card cardticket">
                <div class="cardticket_hd cell">
                    <div class="cell_hd">
                        <span class="radius_avatar">
                            <img class="avatar" src="<#=card_info.card_logo_url#>">
                        </span>
                    </div>
                    <div class="cell_bd cell_primary"><#=card_info.card_title#></div>
                    <div class="cell_ft">
                        <a href="javascript:void(0);"  class="btn btn_plain_primary btn_inline js_ad_btn" id="js_card_action_<#=pos_type#>">领券</a>
                    </div>
                </div>
                <div class="cardticket_ft">
                    <div class="cardticket_theme"></div>
                    <p class="cardticket_source tips_global"><#=card_info.card_brand_name#></p>
                </div>
            </div>
            <# } #>
        </div>
    </div>
  </script>
  <script type="text/javascript">
      var not_in_mm_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/not_in_mm2637ae.css";
      var windowwx_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
      var tid = "";
      var aid = "";
      var clientversion = "0";
      var appuin = "MzAwMDU1MTE1OQ==";

      var source = "22";
      var scene = 75;
      
      var itemidx = "";
      var nickname = "高可用架构";
      var ct = "1448495023";
      var user_name = "gh_ef1c37a72e61";
      var user_name_new = "";
      var fakeid   = "";
      var version   = "";
      var is_limit_user   = "0";
      var msg_title = "【年度案例】双十一大型电商统一服务架构实战";
      var msg_desc = "本文将为大家揭秘双十一抗下几十亿流量的京东商品详情页统一服务架构";
      var msg_cdn_url = "http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapONRFbuHlDqtib4K3kedNJxhkSOIre4fJX8A7bV5MqZqdHUVImt4F4760qwocBEE6Z1M0oluBJO7blQ/0?wx_fmt=jpeg";
      var msg_link = "http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=401843895&amp;idx=1&amp;sn=2d4efc3f1c8ffc56c99d28150536fe93#rd";
      var user_uin = "0"*1;
      var msg_source_url = '';
      var img_format = 'jpeg';
      var srcid = '1126u8JqMh5cO4VeIAxoEoyz';
      var networkType;
      var appmsgid = '' || '401843895';
      var comment_id = "3002388636" * 1;
      var comment_enabled = "" * 1;
      var is_need_reward = "0" * 1;
      var is_https_res = ("" * 1) && (location.protocol == "https:");

      var devicetype = "";
      var source_username = "";
      var reprint_ticket = "";
      var source_mid = "";
      var source_idx = "";

      var show_comment = "";
      var __appmsgCgiData = {
            can_use_page : "0"*1,
            is_wxg_stuff_uin : "0"*1,
            card_pos : "",
            copyright_stat : "1",
            hd_head_img : "http://wx.qlogo.cn/mmhead/Q3auHgzwzM4DkCqSIEoCCu1zKRml7uqGvKdYV2Z2KHyFjuydwib6dNA/0"||(window.location.protocol+"//"+window.location.host + "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_rumor_link.2x264e76.jpg")
      };
      var _empty_v = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/pages/voice/empty26f1f1.mp3";

      var copyright_stat = "1" * 1;

      var pay_fee = "" * 1; // 付费阅读费用
      var pay_timestamp = "";
      var need_pay = "" * 1;

      var need_report_cost = "0" * 1;
      
            window.wxtoken = "";
        </script>

  <script type="text/javascript">
        (function() {
        var JSAPI = {
            ready: function(onBridgeReady) {
                if (typeof top.window.WeixinJSBridge == 'undefined' || !top.window.WeixinJSBridge.invoke) {
                    if (top.window.document.addEventListener) {
                        top.window.document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                    } else if (top.window.document.attachEvent) {
                        top.window.document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
                        top.window.document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                    }
                } else {
                    onBridgeReady();
                }
            },
            on: function(eventName, callback) {
                top.window.WeixinJSBridge.on(eventName, callback);
            }
        };
        var onA8KeyReady = function(A8KeyUrl) {
            if (A8KeyUrl) {
                var params = getQueryFromURL(A8KeyUrl);
                window.uin = params['uin'] || window.uin;
                window.key = params['key'] || window.key;
                window.pass_ticket = params['pass_ticket'] || window.pass_ticket;
            }
            seajs.use('appmsg/index.js');
        };
        var bridgeReadyTimer;
        var onBridgeReady = function() {
            window.logs.pagetime['jsapi_ready_time'] = (+new Date());
            if (bridgeReadyTimer) {
                clearTimeout(bridgeReadyTimer);
            }
            if (!window.isWeixinCached) {
                                window.logs['is_page_cached'] = 0;
                onA8KeyReady();
            } else if (window.getA8KeyUrl) {
                                window.logs.pagetime['a8key_ready_time'] = (+new Date());
                onA8KeyReady(window.getA8KeyUrl);
            } else {
                                JSAPI.on('onGetA8KeyUrl', function(res) {
                    window.logs.pagetime['a8key_ready_time'] = (+new Date());
                    onA8KeyReady(res.url);
                });
            }
        };

                if (typeof window.pass_ticket !== 'undefined' && !!window.pass_ticket) {
                        onA8KeyReady();
        } else if (window.isInWeixinApp() == false) {
                        onA8KeyReady();
        } else {
                        window.logs['is_page_cached'] = 1;
            JSAPI.ready(onBridgeReady);
                        bridgeReadyTimer = setTimeout(function() {
                window.logs['jsapi_ready_fail'] = 1000;
                onA8KeyReady();
            }, 2000);
        }
    })();
  </script>

    


 
</body><style type="text/css" id="577914458000"></style></html>