<!DOCTYPE html>
<!-- saved from url=(0104)http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=209403337&idx=1&sn=f99429e24e8c591111a355e072f93e05 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
<script type="text/javascript"> 
    var page_begintime = (+new Date());

    var biz = "MzAwMDU1MTE1OQ==";
    var sn = "f99429e24e8c591111a355e072f93e05" || "";
    var mid = "209403337" || "";
    var idx = "1" || "" ;
    
    //辟谣需求
    var is_rumor = ""*1;
    var norumor = ""*1;
    if (!!is_rumor&&!norumor){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/rumor") == -1){
        location.href = "http://mp.weixin.qq.com/mp/rumor?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }

    //原创需求，需要跳转到中间页
    /*
    var copyrightInfo = {
        display_source : ""*1,
        nocopyrightsource : ""*1
    };
    if (!!copyrightInfo.display_source&&!copyrightInfo.nocopyrightsource){
      if (!document.referrer || document.referrer.indexOf("mp.weixin.qq.com/mp/reprint") == -1){
        location.href = "http://mp.weixin.qq.com/mp/reprint?action=info&__biz=" + biz + "&mid=" + mid + "&idx=" + idx + "&sn=" + sn + "#wechat_redirect";
      }
    }*/
</script>

        
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">

<link rel="dns-prefetch" href="http://res.wx.qq.com/">
<link rel="dns-prefetch" href="http://mmbiz.qpic.cn/">
<link rel="shortcut icon" type="image/x-icon" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/favicon22c41b.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<script type="text/javascript">
    String.prototype.html = function(encode) {
        var replace =["&#39;", "'", "&quot;", '"', "&nbsp;", " ", "&gt;", ">", "&lt;", "<", "&amp;", "&", "&yen;", "¥"];
        if (encode) {
            replace.reverse();
        }
        for (var i=0,str=this;i< replace.length;i+= 2) {
             str=str.replace(new RegExp(replace[i],'g'),replace[i+1]);
        }
        return str;
    };

    window.isInWeixinApp = function() {
        return /MicroMessenger/.test(navigator.userAgent);
    };

    window.getQueryFromURL = function(url) {
        url = url || 'http://qq.com/s?a=b#rd'; // 做一层保护，保证URL是合法的
        var query = url.split('?')[1].split('#')[0].split('&'),
            params = {};
        for (var i=0; i<query.length; i++) {
            var arg = query[i].split('=');
            params[arg[0]] = arg[1];
        }
        if (params['pass_ticket']) {
        	params['pass_ticket'] = encodeURIComponent(params['pass_ticket'].html(false).html(false).replace(/\s/g,"+"));
        }
        return params;
    };

    (function() {
	    var params = getQueryFromURL(location.href);
        window.uin = params['uin'] || '';
        window.key = params['key'] || '';
        window.wxtoken = params['wxtoken'] || '';
        window.pass_ticket = params['pass_ticket'] || '';
    })();

    window.logs = {
    	pagetime: {}
    };
</script>

        <title>单表60亿记录等大数据场景的MySQL优化和运维之道&nbsp;| 高可用架构</title>
        
<link rel="stylesheet" type="text/css" href="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/page_mp_article_improve296e63.css">
<style>
     
    </style>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css">
<![endif]-->
<script type="text/javascript">
    document.domain = "qq.com";
</script>

    <script src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/page_pos29cc53.js" type="text/javascript" async="" crossorigin="true"></script><link rel="stylesheet" type="text/css" href="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/not_in_mm2637ae.css"></head>
    <body id="activity-detail" class="zh_CN mm_appmsg not_in_mm" ontouchstart="">
        
    <script type="text/javascript">
        var write_sceen_time = (+new Date());
    </script>
    
    <div id="js_cmt_mine" class="discuss_container editing access" style="display:none;">
        <div class="discuss_container_inner">
            <h2 class="rich_media_title">单表60亿记录等大数据场景的MySQL优化和运维之道&nbsp;| 高可用架构</h2>
            <span id="log"></span>
            <div class="frm_textarea_box_wrp">
                <span class="frm_textarea_box">
                    <textarea id="js_cmt_input" class="frm_textarea" placeholder="评论将由公众帐号筛选后显示，对所有人可见。"></textarea>
                    <div class="emotion_tool">
                        <span class="emotion_switch" style="display:none;"></span>
                        <span id="js_emotion_switch" class="pic_emotion_switch_wrp">
                            <img class="pic_default" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/icon_emotion_switch.2x278965.png" alt="">
                            <img class="pic_active" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/icon_emotion_switch_active.2x278965.png" alt="">
                        </span>
                        <div class="emotion_panel" id="js_emotion_panel">
                            <span class="emotion_panel_arrow_wrp" id="js_emotion_panel_arrow_wrp">
                                <i class="emotion_panel_arrow arrow_out"></i>
                                <i class="emotion_panel_arrow arrow_in"></i>
                            </span>
                            <div class="emotion_list_wrp" id="js_slide_wrapper">
                                
                                
                            </div>
                            <ul class="emotion_navs" id="js_navbar">
                                
                            </ul>
                        </div>
                    </div>
                </span>
            </div>
            <div class="discuss_btn_wrp"><a id="js_cmt_submit" class="btn btn_primary btn_discuss btn_disabled" href="javascript:;">提交</a></div>
            <div class="discuss_list_wrp" style="display:none">
                <div class="rich_tips with_line title_tips discuss_title_line">
                    <span class="tips">我的评论</span>
                </div>
                <ul class="discuss_list" id="js_cmt_mylist"></ul>
            </div>
            <div class="rich_tips tips_global loading_tips" id="js_mycmt_loading">
                <img src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                <span class="tips">加载中</span>
            </div>
            <div class="wx_poptips" id="js_cmt_toast" style="display:none;">
                <img alt="" class="icon_toast" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGoAAABqCAYAAABUIcSXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3NpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMTUxMzkxZS1jYWVhLTRmZTMtYTY2NS0xNTRkNDJiOGQyMWIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTA3QzM2RTg3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTA3QzM2RTc3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NWMyOGVjZTMtNzllZS00ODlhLWIxZTYtYzNmM2RjNzg2YjI2IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIxNTEzOTFlLWNhZWEtNGZlMy1hNjY1LTE1NGQ0MmI4ZDIxYiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmvxj1gAAAVrSURBVHja7J15rF1TFMbXk74q1ZKHGlMkJVIhIgg1FH+YEpEQJCKmGBpThRoSs5jVVNrSQUvEEENIhGiiNf9BiERICCFIRbUiDa2qvudbOetF3Tzv7XWGffa55/uS7593977n3vO7e5+199p7v56BgQGh0tcmvAUERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERVAUQVEERVAUQbVYk+HdvZVG8b5F0xj4RvhouB+eCy8KrdzDJc1RtAX8ILxvx98V1GyCSkN98Cx4z/95/Wn4fj6j6tUEeN4wkFSnw1MJqj5NhBfAuwaUHREUg4lqNMmePVsHll/HFhVfe1t3FwpJI8DXCCquDrCWNN4B6Tb4M3Z98aTPmTvh0YHl18PXw29yZiKejoPvcUD6E74yFBJbVDk6Bb7K8aP/Hb4c/tRzEYIqprPhSxzlf4Uvhb/0Xoig8qnHAJ3lqPMzfDH8XZ4LEpRf2sVdA5/sqPO9Qfop70UJyn+/boaPddT5yrq7VUUvTIVJI7q74MMddXR8NB1eXcYvhBpZm0s2w72/o86HFoKvLau/pYaXzjLMdUJ6y0LwtWV9CIIaXtvA8+G9HHV03u5q+K+yH47U0NoRngPv7KjzHDwTLj0bS1BDazfJJlcnOOostC6ysnCT+q80G/sIvFVgeW09D8FPVT0uoP7VfvAD8NjA8pqmuAN+OcYAjso0RbIZ8DGB5TVNcRO8JMaHY9SXSdfa3eeANJimWBLrA7JFiZwIXye+NMUV8CcxP2SRFjXefok7NRjSGZJlWUPvw2/wtNiQirSoXWyMsR28wR7AzzYM0oXw+Y7yK+CLJGeaoqjyrJSdZJD6Ov4+z5y6NJc0Az7NUecHydIUy+v60KNyQHoM3nKI1y7YCFiq0i7uBvgER52vDdKqWn9djhY1Dn4G3n6Ecqm2rF74dvgoR53S0hQxW9RJAZAGW5bSn58QJA27dQ7uIEedjywEX5NKVxCqsY6y+qA+LxFI4+yZ6oH0trWkNan80jygtIUsc5SflgAsDXgehfdx1KkkTRE76tN+Xue2jnTU0Ru1oIbvpt30bBtKhOp5yaaRkts0lic8V1i6dPcIRx2d/l8Y8XtNNEg7OOo8bl1kmmOKnDsO88CaYzejau0hWZqiL7C83oCH4SeTHvwV2BqqsHRVztSEYOmWF80NeXZT6Hd4KflResE9vCnBOlCyGfDNAstHTVPUDWoQ1t3iW+9WNizvlhfd4aerXd+ThqiMfNR6+9LvOOro5OY5JX2H4+F7HZD+kGzlamMgldWiirQsjcwWFbjmqZJteekJLK9pisvgL6RhKvuciZiwzrWWGapfrPy30kBVcSBIrw0aD3PU0XB6cehntq7rTMf7/2iQlktDVdXJLXlg6VjmiYBn6rWSTRCH6hvJ0hQrpcGq8oidsmHpTP8t8DGO9/vcWt9qabiqPgup1yKyQwvC2tSefZ73SSpNkUJ4PlLorlHZ+446nc8f3fIyywlJhwrTuwVSjBa1ccvSxN0hjjoK5xVrYZMd9V6XbFfgBukixTwGLg8sDam3dZR/wZ6L/dJlin1en8LS+bgpFbz3Ygvzu1J1HKxYNqxGpCmaCEo12rrBorD6LRp8UbpcdR5VWhTW35KlKd6QFqjuM2XzwlpnMxTvSkuUwuG/Xlg6NtPjbT6WFimF/VG6LEvXgn8QGDjMbBukVECFwhpoS+CQatfX2Q1q6H7wENHdrfCr0lKleEB9JyxNneus+VJpsVL9TwI6W65LovWIGl3KtVJaLv7LBwYTFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFFWq/hFgADUMN4RzT6/OAAAAAElFTkSuQmCC">
                <p class="toast_content">已评论</p>
            </div>
        </div>
    </div>

    <div id="js_article" class="rich_media">
        
        <div id="js_top_ad_area" class="top_banner">
 
        </div>
                

        <div class="rich_media_inner">
            <div id="page-content">
                <div id="img-content" class="rich_media_area_primary">
                    <h2 class="rich_media_title" id="activity-name">
                        单表60亿记录等大数据场景的MySQL优化和运维之道&nbsp;| 高可用架构 
                    </h2>
                    <div class="rich_media_meta_list">
                        						                        <em id="post-date" class="rich_media_meta rich_media_meta_text">2015-08-09</em>

                                                <em class="rich_media_meta rich_media_meta_text">杨尚刚</em>
                                                <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="javascript:void(0);" id="post-user">高可用架构</a>
                        <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">高可用架构</span>

                        <div id="js_profile_qrcode" class="profile_container" style="display: none;">
                            <div class="profile_inner">
                                <strong class="profile_nickname">高可用架构</strong>
                                <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                                <p class="profile_meta">
                                <label class="profile_meta_label">微信号</label>
                                <span class="profile_meta_value">ArchNotes</span>
                                </p>

                                <p class="profile_meta">
                                <label class="profile_meta_label">功能介绍</label>
                                <span class="profile_meta_value">高可用架构公众号。</span>
                                </p>
                                
                            </div>
                            <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                                <i class="profile_arrow arrow_out"></i>
                                <i class="profile_arrow arrow_in"></i>
                            </span>
                        </div>
                    </div>
                                        
                                                            
                                                            
                    
                    <div class="rich_media_content " id="js_content">
                        <p style="margin-bottom: 15px; padding: 0px; border: 0px; margin-top: 0px !important;">此文是根据杨尚刚在【QCON高可用架构群】中，针对MySQL在单表海量记录等场景下，业界广泛关注的MySQL问题的经验分享整理而成，转发请注明出处。</p><blockquote style="margin-top: 15px; margin-bottom: 15px; padding: 0px 15px; border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(221, 221, 221); color: rgb(119, 119, 119);"><p style="margin-top: 0px; margin-bottom: 0px; padding: 0px; border: 0px;">杨尚刚，美图公司数据库高级DBA，负责美图后端数据存储平台建设和架构设计。前新浪高级数据库工程师，负责新浪微博核心数据库架构改造优化，以及数据库相关的服务器存储选型设计。</p></blockquote><h2 style="margin: 20px 0px 10px; padding: 0px; border-width: 0px 0px 1px; border-top-style: initial; border-right-style: initial; border-left-style: initial; border-top-color: initial; border-right-color: initial; border-left-color: initial; -webkit-font-smoothing: antialiased; font-size: 24px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0);">前言</h2><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">MySQL数据库大家应该都很熟悉，而且随着前几年的阿里的去IOE，MySQL逐渐引起更多人的重视。</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">MySQL历史</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>1979年，Monty Widenius写了最初的版本，96年发布1.0</p></li><li><p>1995-2000年，MySQL AB成立，引入BDB</p></li><li><p>2000年4月，集成MyISAM和replication</p></li><li><p>2001年，Heikki Tuuri向MySQL建议集成InnoDB</p></li><li><p>2003发布5.0，提供了视图、存储过程等功能</p></li><li><p>2008年，MySQL AB被Sun收购，09年推出5.1</p></li><li><p>2009年4月，Oracle收购Sun，2010年12月推出5.5</p></li><li><p>2013年2月推出5.6 GA，5.7开发中</p></li></ul><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">MySQL的优点</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>使用简单</p></li><li><p>开源免费</p></li><li><p>扩展性“好”，在一定阶段扩展性好</p></li><li><p>社区活跃</p></li><li><p>性能可以满足互联网存储和性能需求，离不开硬件支持</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上面这几个因素也是大多数公司选择考虑MySQL的原因。不过MySQL本身存在的问题和限制也很多，有些问题点也经常被其他数据库吐槽或鄙视</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">MySQL存在的问题</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>优化器对复杂SQL支持不好</p></li><li><p>对SQL标准支持不好</p></li><li><p>大规模集群方案不成熟，主要指中间件</p></li><li><p>ID生成器，全局自增ID</p></li><li><p>异步逻辑复制，数据安全性问题</p></li><li><p>Online DDL</p></li><li><p>HA方案不完善</p></li><li><p>备份和恢复方案还是比较复杂，需要依赖外部组件</p></li><li><p>展现给用户信息过少，排查问题困难</p></li><li><p>众多分支，让人难以选择</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">看到了刚才讲的MySQL的优势和劣势，可以看到MySQL面临的问题还是远大于它的优势的,很多问题也是我们实际需要在运维中优化解决的，这也是MySQL DBA的一方面价值所在。并且MySQL的不断发展也离不开社区支持，比如Google最早提交的半同步patch，后来也合并到官方主线。Facebook Twitter等也都开源了内部使用MySQL分支版本，包含了他们内部使用的patch和特性。</p><h2 style="margin: 20px 0px 10px; padding: 0px; border-width: 0px 0px 1px; border-top-style: initial; border-right-style: initial; border-left-style: initial; border-top-color: initial; border-right-color: initial; border-left-color: initial; -webkit-font-smoothing: antialiased; font-size: 24px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0);">数据库开发规范</h2><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">数据库开发规范定义：开发规范是针对内部开发的一系列建议或规则, 由DBA制定(如果有DBA的话)。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">开发规范本身也包含几部分：基本命名和约束规范，字段设计规范，索引规范，使用规范。</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">规范存在意义</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>保证线上数据库schema规范</p></li><li><p>减少出问题概率</p></li><li><p>方便自动化管理</p></li><li><p>规范需要长期坚持，对开发和DBA是一个双赢的事情</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">想想没有开发规范，有的开发写出各种全表扫描的SQL语句或者各种奇葩SQL语句，我们之前就看过开发写的SQL 可以打印出好几页纸。这种造成业务本身不稳定，也会让DBA天天忙于各种救火。</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">基本命名和约束规范</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>表字符集选择UTF8 ，如果需要存储emoj表情，需要使用UTF8mb4(MySQL 5.5.3以后支持)</p></li><li><p>存储引擎使用InnoDB</p></li><li><p>变长字符串尽量使用varchar varbinary</p></li><li><p>不在数据库中存储图片、文件等</p></li><li><p>单表数据量控制在1亿以下</p></li><li><p>库名、表名、字段名不使用保留字</p></li><li><p>库名、表名、字段名、索引名使用小写字母，以下划线分割 ，需要见名知意</p></li><li><p>库表名不要设计过长，尽可能用最少的字符表达出表的用途</p></li></ul><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">字段规范</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>所有字段均定义为NOT NULL ，除非你真的想存Null</p></li><li><p>字段类型在满足需求条件下越小越好，使用UNSIGNED存储非负整数 ，实际使用时候存储负数场景不多</p></li><li><p>使用TIMESTAMP存储时间</p></li><li><p>使用varchar存储变长字符串 ，当然要注意varchar(M)里的M指的是字符数不是字节数；使用UNSIGNED INT存储IPv4 地址而不是CHAR(15) ，这种方式只能存储IPv4，存储不了IPv6</p></li><li><p>使用DECIMAL存储精确浮点数，用float有的时候会有问题</p></li><li><p>少用blob text</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于为什么定义不使用Null的原因</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">* 1.浪费存储空间，因为InnoDB需要有额外一个字节存储</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">* 2.表内默认值Null过多会影响优化器选择执行计划</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于使用datatime和timestamp，现在在5.6.4之后又有了变化，使用二者存储在存储空间上大差距越来越小 ，并且本身datatime存储范围就比timestamp大很多，timestamp只能存储到2038年</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8mafsOjU7wz23T08SWycFVOPysjC2x3ubibf9UXPxmG4RHTBJ8vlfwlfLg/0?wx_fmt=jpeg" data-ratio="0.5564053537284895" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">索引规范</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>单个索引字段数不超过5，单表索引数量不超过5，索引设计遵循B+ Tree索引最左前缀匹配原则</p></li><li><p>选择区分度高的列作为索引</p></li><li><p>建立的索引能覆盖80%主要的查询，不求全，解决问题的主要矛盾</p></li><li><p>DML和order by和group by字段要建立合适的索引</p></li><li><p>避免索引的隐式转换</p></li><li><p>避免冗余索引</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于索引规范，一定要记住索引这个东西是一把双刃剑，在加速读的同时也引入了很多额外的写入和锁，降低写入能力，这也是为什么要控制索引数原因。之前看到过不少人给表里每个字段都建了索引，其实对查询可能起不到什么作用。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">冗余索引例子</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em>idx_<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">a</em>b<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">c(a,b,c) </em></em></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">idx_<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">a(a) 冗余 </em></em></em></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; "><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">idx_</em>a</em>b(a,b) 冗余</em></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">隐式转换例子</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em>字段:<code style="">remark</code> varchar(50) NOT Null </em></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em>MySQL&gt;SELECT <code style="">id</code>, <code style="">gift_code</code> FROM gift WHERE <code style="">deal_id</code> = 640 AND remark=115127; 1 row in set (0.14 sec) </em></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><em>MySQL&gt;SELECT <code style="">id</code>, <code style="">gift_code</code> FROM pool_gift WHERE<code style="">deal_id</code> = 640 AND remark=‘115127’; 1 row in set (0.005 sec)</em></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">字段定义为varchar，但传入的值是个int，就会导致全表扫描，要求程序端要做好类型检查</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">SQL类规范</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>尽量不使用存储过程、触发器、函数等</p></li><li><p>避免使用大表的JOIN，MySQL优化器对join优化策略过于简单</p></li><li><p>避免在数据库中进行数学运算和其他大量计算任务</p></li><li><p>SQL合并，主要是指的DML时候多个value合并，减少和数据库交互</p></li><li><p>合理的分页，尤其大分页</p></li><li><p>UPDATE、DELETE语句不使用LIMIT ，容易造成主从不一致</p></li></ul><h2 style="margin: 20px 0px 10px; padding: 0px; border-width: 0px 0px 1px; border-top-style: initial; border-right-style: initial; border-left-style: initial; border-top-color: initial; border-right-color: initial; border-left-color: initial; -webkit-font-smoothing: antialiased; font-size: 24px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0);">数据库运维规范</h2><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">运维规范主要内容</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>SQL审核，DDL审核和操作时间，尤其是OnlineDDL</p></li><li><p>高危操作检查，Drop前做好数据备份</p></li><li><p>权限控制和审计</p></li><li><p>日志分析，主要是指的MySQL慢日志和错误日志</p></li><li><p>高可用方案</p></li><li><p>数据备份方案</p></li></ul><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">版本选择</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>MySQL社区版，用户群体最大</p></li><li><p>MySQL企业版，收费</p></li><li><p>Percona Server版，新特性多</p></li><li><p>MariaDB版，国内用户不多</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">建议选择优先级为：MySQL社区版 &gt; Percona Server &gt; MariaDB &gt; MySQL 企业版</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">不过现在如果大家使用RDS服务，基本还以社区版为主</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">Online DDL问题</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">原生MySQL执行DDL时需要锁表，且锁表期间业务是无法写入数据的，对服务影响很大，MySQL对这方面的支持是比较差的。大表做DDL对DBA来说是很痛苦的，相信很多人经历过。如何做到Online DDL呢，是不是就无解了呢？当然不是！</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maWqeB31Z0b07ucl1LLkYMH5pbztFlJzxsTm1xPXt3J8l8e3LGhxlXhg/0?wx_fmt=jpeg" data-ratio="0.2294455066921606" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(1)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上面表格里提到的 Facebook OSC和5.6 OSC也是目前两种比较靠谱的方案</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">MySQL 5.6的OSC方案还是解决不了DDL的时候到从库延时的问题，所以现在建议使用Facebook OSC这种思路更优雅</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">下图是Facebook OSC的思路</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8ma7wkdJUKSxl1RMBmJiao2RSlAgbqTEqlOIxLGrvaWEVZayAG5sSkJ8Qw/0?wx_fmt=jpeg" data-ratio="0.5850860420650096" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(2)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">后来Percona公司根据Facebook OSC思路，用perl重写了一版，就是我们现在用得很多的pt-online-schema-change，软件本身非常成熟，支持目前主流版本。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">使用pt-online-schema-change的优点有：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>1.无阻塞写入</p></li><li><p>2.完善的条件检测和延时负载策略控制</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">值得一提的是，腾讯互娱的DBA在内部分支上也实现了Online DDL，之前测试过确实不错，速度快，原理是通过修改InnoDB存储格式来实现。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">使用pt-online-schema-change的限制有：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>改表时间会比较长(相比直接alter table改表)</p></li><li><p>修改的表需要有唯一键或主键</p></li><li><p>在同一端口上的并发修改不能太多</p></li></ul><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">可用性</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">关于可用性，我们今天分享一种无缝切主库方案，可以用于日常切换，使用思路也比较简单</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">在正常条件下如何无缝去做主库切换，核心思路是让新主库和从库停在相同位置，主要依赖slave start until 语句，结合双主结构，考虑自增问题。</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maUcM56ia9GUAsrB6ediaSa8LibUMkFNUTxSI2rKXlvfFCorCjdyrLIyFaA/0?wx_fmt=jpeg" data-ratio="0.6462715105162524" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(3)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">MySQL集群方案：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>集群方案主要是如何组织MySQL实例的方案</p></li><li><p>主流方案核心依然采用的是MySQL原生的复制方案</p></li><li><p>原生主从同步肯定存在着性能和安全性问题</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">MySQL半同步复制：</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">现在也有一些理论上可用性更高的其它方案</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>Percona XtraDB Cluster(没有足够的把控力度，不建议上)</p></li><li><p>MySQL Cluster(有官方支持，不过实际用的不多)</p></li></ul><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maTia9cqlqrwYvfJ6giavnQfUwLb4SCNbpVZ4Uh5yRqpbIUKLZ4Oib6qy5A/0?wx_fmt=jpeg" data-ratio="0.5544933078393881" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(4)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">红框内是目前大家使用比较多的部署结构和方案。当然异常层面的HA也有很多第三方工具支持，比如MHA、MMM等，推荐使用MHA</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">sharding拆分问题</h3><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>Sharding is very complex, so itʼs best not to shard until itʼs obvious that you will actually need to!</p></li><li><p>sharding是按照一定规则数据重新分布的方式</p></li><li><p>主要解决单机写入压力过大和容量问题</p></li><li><p>主要有垂直拆分和水平拆分两种方式</p></li><li><p>拆分要适度，切勿过度拆分</p></li><li><p>有中间层控制拆分逻辑最好，否则拆分过细管理成本会很高</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">曾经管理的单表最大60亿＋，单表数据文件大小1TB＋，人有时候就要懒一些</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maDf9zVbtKHriblfeicyvtyYoSibhK1XMZiaoM30AFGGu8HXhQxfNtZ5G75Q/0?wx_fmt=jpeg" data-ratio="0.42065009560229444" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(5)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是水平拆分和垂直拆分的示意图</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">数据库备份</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">首先要保证的，最核心的是数据库数据安全性。数据安全都保障不了的情况下谈其他的指标(如性能等)，其实意义就不大了。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">备份的意义是什么呢?</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>数据恢复！</p></li><li><p>数据恢复！</p></li><li><p>数据恢复！</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">目前备份方式的几个纬度：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>全量备份 VS 增量备份</p></li><li><p>热备 VS 冷备</p></li><li><p>物理备份 VS 逻辑备份</p></li><li><p>延时备份</p></li><li><p>全量binlog备份</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">建议方式：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>热备＋物理备份</p></li><li><p>核心业务：延时备份＋逻辑备份</p></li><li><p>全量binlog备份</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">借用一下某大型互联网公司做的备份系统数据：一年7000＋次扩容，一年12＋次数据恢复，日志量每天3TB，数据总量2PB，每天备份数据量百TB级，全年备份36万次，备份成功了99.9%。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">主要做的几点：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>备份策略集中式调度管理</p></li><li><p>xtrabackup热备</p></li><li><p>备份结果统计分析</p></li><li><p>备份数据一致性校验</p></li><li><p>采用分布式文件系统存储备份</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">备份系统采用分布式文件系统原因：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>解决存储分配的问题</p></li><li><p>解决存储NFS备份效率低下问题</p></li><li><p>存储集中式管理</p></li><li><p>数据可靠性更好</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">使用分布式文件系统优化点：</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">* Pbzip压缩，降低多副本存储带来的存储成本，降低网络带宽消耗</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">* 元数据节点HA，提高备份集群的可用性</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">* erasure code方案调研</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">数据恢复方案</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">目前的MySQL数据恢复方案主要还是基于备份来恢复，可见备份的重要性。比如我今天下午15点删除了线上一张表，该如何恢复呢？首先确认删除语句，然后用备份扩容实例启动，假设备份时间点是凌晨3点，就还需要把凌晨3点到现在关于这个表的binlog导出来，然后应用到新扩容的实例上，确认好恢复的时间点，然后把删除表的数据导出来应用到线上。</p><h2 style="margin: 20px 0px 10px; padding: 0px; border-width: 0px 0px 1px; border-top-style: initial; border-right-style: initial; border-left-style: initial; border-top-color: initial; border-right-color: initial; border-left-color: initial; -webkit-font-smoothing: antialiased; font-size: 24px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0);">性能优化</h2><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">复制优化</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">MySQL复制：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>是MySQL应用得最普遍的应用技术，扩展成本低</p></li><li><p>逻辑复制</p></li><li><p>单线程问题，从库延时问题</p></li><li><p>可以做备份或读复制</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">问题很多，但是能解决基本问题</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maoUwMicwvuMh8EDRmdGn5hgwibXwzDPoMxNo1ltNqahAnRI2ZsupWeD8Q/0?wx_fmt=jpeg" data-ratio="1.112810707456979" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(6)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是MySQL复制原理图，红框内就是MySQL一直被人诟病的单线程问题</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">单线程问题也是MySQL主从延时的一个重要原因，单线程解决方案：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>官方5.6+多线程方案</p></li><li><p>Tungsten为代表的第三方并行复制工具</p></li><li><p>sharding</p></li></ul><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8macKloWagURiaqEql6Ls50dl7KbCRxUvRUvnMdLmfDJ3LrF9dHfQicKH2A/0?wx_fmt=jpeg" data-ratio="0.7552581261950286" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(7)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是MySQL5.6 目前实现的并行复制原理图，是基于库级别的复制，所以如果你只有一个库，使用这个意义不大</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">当然MySQL也认识到5.6这种并行的瓶颈所在，所以在5.7引入了另外一种并行复制方式，基于logical timestamp的并行复制，并行复制不再受限于库的个数，效率会大大提升</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8mapdg1N9LLiahKgQ66DJHOub0ThgL4KNp7qr8pryvdxSBKibOcQMW7MRTg/0?wx_fmt=jpeg" data-ratio="0.6022944550669216" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(8)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是5.7的logical timestamp的复制原理图</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">刚才我也提到MySQL原来只支持异步复制，这种数据安全性是非常差的，所以后来引入了半同步复制，从5.5开始支持</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maOGs9iaWibcx307mibJPQODxxWuk4blTn9FCOEX60HJnf39gyaEwC9khibw/0?wx_fmt=jpeg" data-ratio="0.39579349904397704" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(9)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是原生异步复制和半同步复制的区别。可以看到半同步通过从库返回ACK这种方式确认从库收到数据，数据安全性大大提高</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">在5.7之后，半同步也可以配置你指定多个从库参与半同步复制，之前版本都是默认一个从库</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">对于半同步复制效率问题有一个小的优化，就是使用5.6+的mysqlbinlog以daemon方式作为从库，同步效率会好很多</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于更安全的复制，MySQL 5.7也是有方案的，方案名叫Group replication 官方多主方案，基于Corosync实现</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8malia1iaNHiaz1bhC7WUticQQAQOKk7Gt8MngIMficic1eNFkiaSmYPzvQESwxg/0?wx_fmt=jpeg" data-ratio="0.3193116634799235" data-w="" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(10)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">主从延时问题</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">原因：一般都会做读写分离，其实从库压力反而比主库大／从库读写压力大非常容易导致延时。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">解决方案：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>首先定位延时瓶颈</p></li><li><p>如果是IO压力，可以通过升级硬件解决，比如替换SSD等</p></li><li><p>如果IO和CPU都不是瓶颈，非常有可能是SQL单线程问题，解决方案可以考虑刚才提到的并行复制方案</p></li><li><p>如果还有问题，可以考虑sharding拆分方案</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">提到延时不得不提到很坑人的Seconds <em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">behind </em>master，使用过MySQL的应该很熟悉</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">这个值的源码里算法</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><code style="">long time_diff= ((long)(time(0) – mi-&gt;rli.last_master_timestamp) – mi-&gt;clock_diff_with_master);</code> </p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">Seconds<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">behind</em>master来判断延时不可靠，在网络抖动或者一些特殊参数配置情况下，会造成这个值是0但其实延时很大了。通过heartbeat表插入时间戳这种机制判断延时是更靠谱的</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">复制注意点：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>Binlog格式，建议都采用row格式，数据一致性更好</p></li><li><p>Replication filter应用</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">主从数据一致性问题：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>row格式下的数据恢复问题</p></li></ul><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">InnoDB优化</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">成熟开源事务存储引擎，支持ACID，支持事务四个隔离级别，更好的数据安全性，高性能高并发，MVCC，细粒度锁，支持O_DIRECT。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">主要优化参数：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">file</em>per_table =1</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">buffer</em>pool_size，根据数据量和内存合理设置</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">flush</em>log_at<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">trx</em>commit= 0 1 2</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">log</em>file_size，可以设置大一些</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">page</em>size</p></li><li><p>Innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">flush</em>method = o_direct</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">undo</em>directory 放到高速设备(5.6＋)</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">buffer</em>pool_dump</p></li><li><p><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">at</em>shutdown ，bufferpool dump (5.6+)</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8margsiauiayoys1CXDoEicejpDhWxmhNYfdzLb6PaVOQu3VQicpTibAiaDVVqg/0?wx_fmt=jpeg" data-ratio="0.2152917505030181" data-w="497" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 497px !important; visibility: visible !important; height: 107px !important;"><br><br></p></li></ul><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是5.5 4G的redo log和5.6 设置大于4G redo log文件性能对比，可以看到稳定性更好了。innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">log</em>file_size设置还是很有意义的</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">InnoDB比较好的特性：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>Bufferpool预热和动态调整大小，动态调整大小需要5.7支持</p></li><li><p>Page size自定义调整，适应目前硬件</p></li><li><p>InnoDB压缩，大大降低数据容量，一般可以压缩50%，节省存储空间和IO，用CPU换空间</p></li><li><p>Transportable tablespaces，迁移ibd文件，用于快速单表恢复</p></li><li><p>Memcached API，full text，GIS等</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">InnoDB在SSD上的优化：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>在5.5以上，提高innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">write</em>io<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">threads和innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">read</em>io</em>threads</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">io</em>capacity需要调大</p></li><li><p>日志文件和redo放到机械硬盘，undo放到SSD，建议这样，但必要性不大</p></li><li><p>atomic write,不需要Double Write Buffer</p></li><li><p>InnoDB压缩</p></li><li><p>单机多实例</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">也要搞清楚InnoDB哪些文件是顺序读写，哪些是随机读写</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">随机读写：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>datadir</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">data </em>file_path</p></li><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">undo </em>directory</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">顺序读写：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>innodb<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">log</em>group<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">home</em>dir</p></li><li><p>log-bin</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">InnoDB VS MyISAM：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>数据安全性至关重要，InnoDB完胜，曾经遇到过一次90G的MyISAM表repair，花了两天时间，如果在线上几乎不可忍受</p></li><li><p>并发度高</p></li><li><p>MySQL 5.5默认引擎改为InnoDB，标志着MyISAM时代的落幕</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">TokuDB：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>支持事务 ACID 特性，支持多版本控制(MVCC)</p></li><li><p>基于Fractal Tree Index，非常适合写入密集场景</p></li><li><p>高压缩比，原生支持Online DDL</p></li><li><p>主流分支都支持，收费转开源 。目前可以和InnoDB媲美的存储引擎</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">目前主流使用TokuDB主要是看中了它的高压缩比，Tokudb有三种压缩方式：quicklz、zlib、lzma，压缩比依次更高。现在很多使用zabbix的后端数据表都采用的TokuDB，写入性能好，压缩比高。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">下图是我之前做的测试对比和InnoDB</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8massLdVUY8H5FWE5Yia5icx4mq86GyfMyn3XxuUzXQSnQlZxZuiaxy4lmxg/0?wx_fmt=jpeg" data-ratio="0.8680688336520076" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 607.6481835564053px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><br></p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maSb32YJMJ71MibICicnwayvhhKroqhTSPRu4vm1sXexA07vLa0aW3Vdxg/0?wx_fmt=jpeg" data-ratio="0.5736137667304015" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 401.52963671128106px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是sysbench测试的和InnoDB性能对比图，可以看到TokuDB在测试过程中写入稳定性是非常好的。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">tokudb存在的问题：</p><ul style="margin-top: 15px; margin-bottom: 15px; padding-left: 30px; border: 0px;" class=" list-paddingleft-2"><li><p>官方分支还没很好的支持</p></li><li><p>热备方案问题，目前只有企业版才有</p></li><li><p>还是有bug的，版本更新比较快，不建议在核心业务上用</p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">比如我们之前遇到过一个问题：TokuDB的内部状态显示上一次完成的checkpoint时间是“Jul 17 12:04:11 2014”，距离当时发现现在都快5个月了，结果堆积了大量redo log不能删除，后来只能重启实例，结果重启还花了七八个小时</p><h3 style="margin: 20px 0px 10px; padding: 0px; border: 0px; -webkit-font-smoothing: antialiased; font-size: 18px;">MySQL优化相关的case</h3><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;">Query cache，MySQL内置的查询加速缓存，理念是好的,但设计不够合理，有点out。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">锁的粒度非常大MySQL 5.6默认已经关闭</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">When the query cache helps, it can help a lot. When it hurts, it can hurt a lot.明显前半句已经没有太大用处，在高并发下非常容易遇到瓶颈。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于事务隔离级别 ，InnoDB默认隔离级别是可重复读级别，当然InnoDB虽然是设置的可重复读，但是也是解决了幻读的，建议改成读已提交级别，可以满足大多数场景需求，有利于更高的并发，修改transaction-isolation。</p><p><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maqqcbVpUByadpsfIB0bE03UZMj7xkm1DOA9fG1fZLd8vdic0JrnynwsA/0?wx_fmt=jpeg" data-ratio="0.32122370936902483" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 224.8565965583174px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><br></p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maw86TIWliaKhZrQBDBvwyLTJicb8w3h8sHLMGLsJywcluYCF578DRxu4g/0?wx_fmt=jpeg" data-ratio="1.2" data-w="20" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(11)" style="width: auto !important; visibility: visible !important; height: auto !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是一个比较经典的死锁case，有兴趣可以测试下</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong><span style="font-size: 18px;">关于SSD</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于SSD，还是提一下吧。某知名大V说过“最近10年对数据库性能影响最大的是闪存”，稳定性和性能可靠性已经得到大规模验证，多块SATA SSD做Raid5，推荐使用。采用PCIe SSD，主流云平台都提供SSD云硬盘支持。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><span style="font-size: 18px;"><strong>最后说一下大家关注的单表60亿记录问题，表里数据也是线上比较核心的。</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">先说下当时情况，表结构比较简单，都是bigint这种整型，索引比较多，应该有2-3个，单表行数60亿＋，单表容量1.2TB左右，当然内部肯定是有碎片的。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">形成原因：历史遗留问题，按照我们前面讲的开发规范，这个应该早拆分了，当然不拆有几个原因：</p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">性能未遇到瓶颈 ，主要原因</p></li><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">DBA比较“懒“</p></li><li><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">想看看InnoDB的极限，挑战一下。不过风险也是很大的，想想如果在一个1.2TB表上加个字段加个索引，那感觉绝对酸爽。还有就是单表恢复的问题，恢复时间不可控。</p></li></ol><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">我们后续做的优化 ，采用了刚才提到的TokuDB，单表容量在InnoDB下1TB+，使用Tokudb的lzma压缩到80GB，压缩效果非常好。这样也解决了单表过大恢复时间问题，也支持online DDL，基本达到我们预期。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">今天讲的主要针对MySQL本身优化和规范性质的东西，还有一些比较好的运维经验，希望大家能有所收获。今天这些内容是为后续数据库做平台化的基础。我今天分享就到这里，谢谢大家。</p><h2 style="margin: 20px 0px 10px; padding: 0px; border-width: 0px 0px 1px; border-top-style: initial; border-right-style: initial; border-left-style: initial; border-top-color: initial; border-right-color: initial; border-left-color: initial; -webkit-font-smoothing: antialiased; font-size: 24px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); color: rgb(0, 0, 0);">QA</h2><p style="margin-top: 10px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q1：use schema;select * from table; 和select * from schema.table;两种写法有什么不一样吗？会对主从同步有影响吗？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">对于主从复制来说执行效率上差别不大，不过在使用replication filter时候这种情况需要小心，应该要使用Replicate<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Wild</em>Ignore<em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Table这种参数，如果不使用带wild</em>ignore，第一种方式会有问题，过滤不起作用。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q2：对于用于MySQL的ssd，测试方式和ssd的参数配置方面，有没有好的建议？主要针对ssd的配置哈</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于SATA SSD配置参数，建议使用Raid5，想更保险使用Raid50，更土豪使用Raid 10</p><p style="text-align: center;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maY2k8Cz8zibA33XQJy9R8976wRYxToKlbhzuLDawM0E9kVBAiarWSAcBg/0?wx_fmt=jpeg" data-ratio="0.24665391969407266" data-w="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 700px !important; visibility: visible !important; height: 172.65774378585087px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">上图是主要的参数优化，性能提升最大的是第一个修改调度算法的</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q3：数据库规范已制定好，如何保证开发人员必须按照规范来开发？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">关于数据库规范实施问题，也是有两个方面吧，第一、定期给开发培训开发规范，让开发能更了解。第二、还是在流程上规范，比如把我们日常通用的建表和字段策略固化到程序，做成自动化审核系统。这两方面结合 效果会比较好。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q4：如何最大限度提高innodb的命中率？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">这个问题前提是你的数据要有热点，读写热点要有交集，否则命中率很难提高。在有热点的前提下，也要求你的你的内存要足够大，能够存更多的热点数据。尽量不要做一些可能污染bufferpool的操作，比如全表扫描这种。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q5：主从复制的情况下，如果有CAS这样的需求，是不是只能强制连主库？因为有延迟的存在，如果读写不在一起的话，会有脏数据。</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">如果有CAS需求，确实还是直接读主库好一些，因为异步复制还是会有延迟的。只要SQL优化的比较好，读写都在主库也是没什么问题的。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q6：关于开发规范，是否有必要买国标?</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">这个国标是什么东西，不太了解。不过从字面看，国标应该也是偏学术方面的，在具体工程实施时候未必能用好。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q7：主从集群能不能再细化一点那？不知道这样问合适不？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">看具体哪方面吧。主从集群每个小集群一般都是采用一主多从方式，每个小集群对应特定的一组业务。然后监控备份和HA都是在每个小集群实现。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q8：如何跟踪数据库table某个字段值发生变化？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">追踪字段值变化可以通过分析row格式binlog好一些。比如以前同事就是通过自己开发的工具来解析row格式binlog，跟踪数据行变化。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q9：对超大表水平拆分，在使用MySQL中间件方面有什么建议和经验分享？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">对于超大表水平拆分，在中间件上经验不是很多，早期人肉搞过几次。也使用过自己研发的数据库中间件，不过线上应用的规模不大。关于目前众多的开源中间件里，360的atlas是目前还不错的，他们公司内部应用的比较多。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q10：我们用的MySQL proxy做读负载，但是少量数据压力下并没有负载，请问有这回事吗？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">少量数据压力下，并没有负载 ，这个没测试过，不好评价</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q11：对于binlog格式，为什么只推荐row，而不用网上大部分文章推荐的Mix ？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">这个主要是考虑数据复制的可靠性，row更好。mixed含义是指如果有一些容易导致主从不一致的SQL ，比如包含UUID函数的这种，转换为row。既然要革命，就搞的彻底一些。这种mix的中间状态最坑人了。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q12： 读写分离，一般是在程序里做，还是用proxy ，用proxy的话一般用哪个？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">这个还是独立写程序好一些，与程序解耦方便后期维护。proxy国内目前开源的比较多，选择也要慎重。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q13： 我想问一下关于mysql线程池相关的问题，什么情况下适合使用线程池，相关的参数应该如何配置，老师有这方面的最佳实践没有？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">线程池这个我也没测试过。从原理上来说，短链接更适合用线程池方式，减少建立连接的消耗。这个方面的最佳配置，我还没测试过，后面测试有进展可以再聊聊。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q14： 误删数据这种，数据恢复流程是怎么样的(从库也被同步删除的情况)？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">看你删除数据的情况，如果只是一张表，单表在几GB或几十GB。如果能有延时备份，对于数据恢复速度是很有好处的。恢复流程可以参考我刚才分享的部分。目前的MySQL数据恢复方案主要还是基于备份来恢复 ，可见备份的重要性。比如我今天下午15点删除了线上一张表，该如何恢复呢。首先确认删除语句，然后用备份扩容实例启动，假设备份时间点是凌晨3点。就还需要把凌晨3点到现在关于这个表的binlog导出来，然后应用到新扩容的实例上。确认好恢复的时间点，然后把删除表的数据导出来应用到线上。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">Q15： 关于备份，binlog备份自然不用说了，物理备份有很多方式，有没有推荐的一种，逻辑备份在量大的时候恢复速度比较慢，一般用在什么场景？</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;">物理备份采用xtrabackup热备方案比较好。逻辑备份一般用在单表恢复效果会非常好。比如你删了一个2G表，但你总数据量2T，用物理备份就会要慢了，逻辑备份就非常有用了。</p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">想和群内专家继续交流MySQL相关技术，请关注公众号后，回复arch，申请进群。</strong></p><p style="margin-top: 15px; margin-bottom: 15px; padding: 0px; border: 0px;"><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; ">本文策划 庆丰@微博, 内容由王杰编辑，刘伟@途牛、陈刚@北京智识 校对与发布，其他多位志愿者对本文亦有贡献。读者可以通过搜索“ArchNotes”或长按下面图片，关注“高可用架构”公众号，查看更多架构方面内容，获取通往架构师之路的宝贵经验。转载请注明来自“高可用架构（ArchNotes）”公众号，敬请包含二维码！</strong></p><p style="margin-top: 15px; padding: 0px; border: 0px; margin-bottom: 0px !important; text-align: center;"><img data-src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOPoaibhicCyMkia552rIu4wAtUThl4HiaABoLpmOkKMHVKHnprghrbTXQia0zgJuNmlU5icoKflhYdhtqPQ/0?wx_fmt=jpeg" style="margin: 0px; padding: 0px; border: 0px; width: auto !important; visibility: visible !important; height: auto !important;" data-ratio="1" data-w="430" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/640(12)"></p><p><br></p>
                    </div>
                    <script type="text/javascript">
                        var first_sceen__time = (+new Date());

                        if ("" == 1 && document.getElementById('js_content'))
                            document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });

                                        (function(){
                            if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                                var link = document.createElement('link');
                                var head = document.getElementsByTagName('head')[0];
                                link.rel = 'stylesheet';
                                link.type = 'text/css';
                                link.href = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
                                head.appendChild(link);
                            }
                        })();
                    </script>
                    <link rel="stylesheet" type="text/css" href="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/page_mp_article_improve_combo29ab01.css">
                                        
                                        
                                        <div class="rich_media_tool" id="js_toobar2">
                                                                    <div id="js_read_area2" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum2"></span></div>

                        <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like2">
                            <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum2"></span>
                        </span>

                        <a id="js_report_article2" style="display:none;" class="media_tool_meta tips_global meta_extra" href="javascript:void(0);">举报</a>

                    </div>
                </div>

                <div class="rich_media_area_extra">

                    
                                        <div class="mpda_bottom_container" id="js_bottom_ad_area">
                        
                    </div>

                    
                    <div id="js_iframetest" style="display:none;"></div>

                    
                                    </div>
               
            </div>
            <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display: block;">
                <div class="qr_code_pc_inner">
                    <div class="qr_code_pc">
                        <img id="js_pc_qr_code_img" class="qr_code_pc_img" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/qrcode">
                        <p>微信扫一扫<br>关注该公众号</p>
                    </div>
                </div>
            </div>

        </div>
    </div>


        
        <script>window.moon_map = {"appmsg/emotion/caret.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/caret278965.js","appmsg/emotion/map.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/map278965.js","appmsg/emotion/textarea.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/textarea27cdc5.js","appmsg/emotion/nav.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/nav278965.js","appmsg/emotion/common.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/common278965.js","appmsg/emotion/slide.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/slide27cdc5.js","biz_wap/jsapi/cardticket.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/cardticket275627.js","pages/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report292ed8.js","pages/music_player.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_player298e98.js","pages/loadscript.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/loadscript292ed8.js","appmsg/emotion/dom.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/dom278965.js","appmsg/emotion/emotion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/emotion27f4f1.js","biz_wap/utils/hashrouter.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/hashrouter2805ea.js","a/gotoappdetail.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/gotoappdetail29b1f8.js","a/ios.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/ios275627.js","a/android.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/android275627.js","a/profile.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/profile29b1f8.js","a/card.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/card29b1f8.js","biz_wap/utils/position.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/position29b1f8.js","appmsg/a_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a_report282222.js","biz_common/utils/monitor.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/monitor27f4f1.js","biz_common/utils/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/report275627.js","biz_common/utils/huatuo.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/huatuo293afc.js","biz_common/utils/cookie.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/cookie275627.js","pages/voice_component.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_component298e98.js","new_video/ctl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/ctl292ed8.js","biz_common/utils/spin.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/spin275627.js","biz_wap/jsapi/pay.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/pay275627.js","appmsg/reward_entry.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/reward_entry29bb2b.js","appmsg/comment.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment294506.js","appmsg/like.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/like297cdb.js","appmsg/a.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/a29b1f8.js","pages/version4video.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/version4video292ed8.js","biz_wap/utils/storage.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/storage275627.js","biz_common/tmpl.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/tmpl275627.js","biz_common/ui/imgonepx.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/ui/imgonepx275627.js","biz_common/dom/attr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/attr275627.js","biz_wap/utils/ajax.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/ajax297cdb.js","biz_common/utils/string/html.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/string/html275627.js","appmsg/report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report296743.js","biz_common/dom/class.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/class275627.js","appmsg/report_and_source.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report_and_source292f48.js","appmsg/page_pos.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/page_pos29cc53.js","appmsg/cdn_speed_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_speed_report275627.js","appmsg/voice.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voice275627.js","appmsg/qqmusic.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/qqmusic29bb50.js","appmsg/iframe.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/iframe2989c1.js","appmsg/review_image.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/review_image275627.js","appmsg/outer_link.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/outer_link275627.js","biz_wap/jsapi/core.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/core275627.js","biz_common/dom/event.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/event275627.js","appmsg/copyright_report.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/copyright_report2805ea.js","appmsg/pay_for_reading.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/pay_for_reading28f721.js","appmsg/async.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/async29bb2b.js","biz_wap/ui/lazyload_img.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/ui/lazyload_img275627.js","biz_common/log/jserr.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/log/jserr2805ea.js","appmsg/share.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share29bb2b.js","biz_wap/utils/mmversion.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/mmversion275627.js","appmsg/cdn_img_lib.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_img_lib275627.js","biz_common/utils/url/parse.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/url/parse275627.js","biz_wap/utils/device.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/device27f46f.js","appmsg/index.js":"http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/index29a503.js"};window.moon_crossorigin = true;</script><script type="text/javascript" src="./单表60亿记录等大数据场景的MySQL优化和运维之道   高可用架构_files/moon275627.js" crossorigin=""></script>
    <script id="voice_tpl" type="text/html">        
        <span id="voice_main_<#=voiceid#>_<#=posIndex#>" class="db audio_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="audio_wrp db">
                <span id="voice_play_<#=voiceid#>_<#=posIndex#>" class="audio_play_area">
                    <i class="icon_audio_default"></i>
                    <i class="icon_audio_playing"></i>
                    <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/audio/icon_audio_unread26f1f1.png" alt="" class="pic_audio_default">
                </span>
                <span class="audio_length tips_global"><#=duration_str#></span>
                <span class="db audio_info_area">
                    <strong class="db audio_title"><#=title#></strong>
                    <span class="audio_source tips_global"><#if(window.nickname){#>来自<#=window.nickname#><#}#></span>
                </span>
                <span id="voice_progress_<#=voiceid#>_<#=posIndex#>" class="progress_bar" style="width:0px;"></span>
            </span>
        </span>
    </script>

    <script id="qqmusic_tpl" type="text/html">        
        <span id="qqmusic_main_<#=comment_id#>_<#=posIndex#>" class="db qqmusic_area <#if(!musicSupport){#> unsupport<#}#>">
            <span class="tc tips_global unsupport_tips" <#if(show_not_support!==true){#>style="display:none;"<#}#>>
            当前浏览器不支持播放音乐或语音，请在微信或其他浏览器中播放            </span>
            <span class="db qqmusic_wrp">
                <span class="db qqmusic_bd">
                    <span id="qqmusic_play_<#=musicid#>_<#=posIndex#>" class="play_area">
                        <i class="icon_qqmusic_switch"></i>
                        <img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_default.2x26f1f1.png" alt="" class="pic_qqmusic_default">
                        <img src="<#=music_img#>" data-autourl="<#=audiourl#>" data-musicid="<#=musicid#>" class="qqmusic_thumb" alt="">
                    </span>
                                        <a id="qqmusic_home_<#=musicid#>_<#=posIndex#>" href="javascript:void(0);" class="access_area">
                        <span class="qqmusic_songname"><#=music_name#></span>
                        <span class="qqmusic_singername"><#=singer#></span>
                        <span class="qqmusic_source"><img src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/appmsg/qqmusic/icon_qqmusic_source263724.png" alt=""></span>
                    </a>
                </span>
            </span>       
        </span>
    </script>

    <script id="t_cmt" type="text/html">
        <li class="discuss_item" id="cid<# if (is_from_me == 1) { #><#=my_id#><# } else { #><#=content_id#><# } #>">
            <# if(is_elected == 1){ #>
            <div class="discuss_opr">
                <span class="media_tool_meta tips_global meta_praise js_comment_praise <# if(like_status == 1){ #>praised<# } #>" data-status="<#=like_status#>" data-content-id='<#=content_id#>'>
                    <i class="icon_praise_gray"></i>
                    <span class="praise_num"><# if(like_num_format !== 0){ #><#=like_num_format#> <# } #></span>
                </span>
            </div>
            <# } #>
            <div class="user_info">
                <strong class="nickname"><#=nick_name#><# if(is_from_friend == 1){ #>(朋友)<# } #></strong>
                <img class="avatar" src="<#=logo_url#>">
            </div>
            <div class="discuss_message">
                <span class="discuss_status"><#=status#></span>
                <div class="discuss_message_content">
                <#=content#>
                </div>
            </div>
            <p class="discuss_extra_info">
                <#=time#>               
                <# if (is_from_me == 1) { #>
                <a class="discuss_del js_del" href="javascript:;" data-my-id="<#=my_id#>" data-content-id="<#=content_id#>">删除</a>
                <# } #>
            </p>
            <# if(reply && reply.reply_list && reply.reply_list.length > 0){ #>
                <div class="reply_result">
                    <div class="nickname">作者回复</div>
                    <div class="discuss_message">
                        <div class="discuss_message_content">
                        <#=reply.reply_list[0].content#>
                        </div>
                    </div>
                    <p class="discuss_extra_info"><#=reply.reply_list[0].time#></p>
                </div>
            <# } #>
                
        </li>
    </script>

  <script id="t_ad" type="text/html">
    <div class="rich_media_extra" id="gdt_area">
        <# if(pos_type==0){ #>
        <div class="rich_tips with_line title_tips">
            <span class="tips">广告</span>
        </div>
        <# } #>
        <div class="js_ad_link extra_link" data-type="<#=type#>" data-ticket="<#=ticket#>" data-url="<#=url#>" data-rl="<#=rl#>"  data-aid="<#=aid#>" data-pt="<#=pt#>" data-tid="<#=traceid#>" data-gid="<#=group_id#>" data-apurl="<#=apurl#>">




            <# if(pt==1){ #>
            <#=hint_txt#>
            <img class="icon_arrow_gray" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_arrow_gray1ef6d4.png">
            <img class="icon_loading_white icon_after" style="display:none;" id="loading_<#=traceid#>" src="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/icon/common/icon_loading_white2805ea.gif">
            <# }else if(pt==2){ #>
            
            <# if (logo.indexOf("http://mmsns.qpic.cn/") == 0){ #>
            <div class="brand_logo"><img src="<#=logo#>" alt="logo图片"></div>
            <# } #>
            <img class="appmsg_banner" src="<#=image_url#>">
            <# if(watermark_type!=0){ #><i class="promotion_tag"><# if(watermark_type==1){ #>商品推广<# }else if (watermark_type==2){ #>活动推广<# } #></i><# } #>
            <# }else if(pt==7){ #>
            
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">
                    <div class="preview_group_info">
                        <strong class="preview_group_title2"><#=hint_txt#></strong>
                        <div class="preview_group_desc"><#=ad_desc#></div>
                        <img src="<#=image_url#>" alt="" class="preview_card_avatar">
                    </div>
                </div>
            </div>
            <# }else if(pt==100){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=biz_info.nick_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <# if(!!biz_info.head_img){ #>
                        <img src="<#=biz_info.head_img#>" alt="" class="preview_group_avatar br_radius">
                        <# }else{ #>
                        <img class="preview_group_avatar br_radius" src="http://mmbiz.qpic.cn/mmbiz/a5icZrUmbV8p5jb6RZ8aYfjfS2AVle8URwBt8QIu6XbGewB9wiaWYWkPwq4R7pfdsFibuLkic16UcxDSNYtB8HnC1Q/0" alt="<#=biz_info.nick_name#>">
                        <# } #>                                 
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_view_profile_<#=pos_type#>" <# if(biz_info.is_subscribed == 0){ #>style="display:none"<# } #> class="btn btn_inline btn_primary btn_line js_ad_btn" href="javascript:void(0);">查看</a>
                        <a id="js_add_contact_<#=pos_type#>" data-url="<#=url#>" data-type="<#=type#>" data-tid="<#=traceid#>" data-rl="<#=rl#>" <# if(biz_info.is_subscribed ==1){ #>style="display:none"<# } #> class="btn btn_inline btn_line  btn_primary js_ad_btn" href="javascript:void(0);">关注</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==102){ #>
            <div class="preview_group">
                <div class="preview_group_inner">
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_group_avatar br_radius">
                    </div>
                    <div class="preview_group_opr">
                        <a id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn btn_download" href="javascript:void(0);">下载</a>
                    </div>
                </div>
            </div>
            <# }else if(pt==101){ #>
            <div class="preview_group preview_card">
                <div class="preview_group_inner card_inner">                            
                    <div class="preview_group_info append_btn">
                        <strong class="preview_group_title"><#=app_info.app_name#></strong>
                        <div class="preview_group_desc"><#=hint_txt#></div>
                        <img src="<#=app_info.icon_url#>" alt="" class="preview_card_avatar">                               
                    </div>
                    <div class="preview_group_opr">
                        <a href="javascript:void(0);" id="js_app_action_<#=pos_type#>" class="btn btn_inline btn_primary js_ad_btn">下载</a>
                    </div>
                </div>                        
            </div>
            <# }else if(pt==103||pt==104){ #>
            <div class="preview_group obvious_app">
                <div class="preview_group_inner">
                    <div class="pic_app">
                        <img src="<#=image_url#>" alt="">
                    </div>
                    <div class="info_app">
                        <p class="name_app"><#=app_info.app_name#></p>
                        <# if(pt==103){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._category#></span><em>|</em><span class="compacity"><#=app_info._app_size#></span></p>
                        <# } else if(pt==104){ #>
                        <p class="profile_app" style="display:none;"><span class="fun_exp"><#=app_info._app_size#></span><em>|</em><span class="compacity"><#=app_info._down_count#></span></p>
                        <# } #>
                        
                        <p class="grade_app" id="js_app_rating_<#=pos_type#>">
                            
                            <span class="js_stars stars" style="display:none;"></span>
                            
                            <span class="js_scores scores">暂无评分</span>
                        </p>
                        <div class="dm_app">
                            <a href="javascript:void(0);" id="js_appdetail_action_<#=pos_type#>" class="ad_btn btn_download js_ad_btn">下载</a>
                            <p class="extra_info">来自<# if(pt==103){ #>App Store<# }else{ #>腾讯应用宝<# } #></p>
                        </div>
                    </div>
                </div>            
            </div>
            <# }else if(pt==105){ #>
            <div class="mpda_card cardticket">
                <div class="cardticket_hd cell">
                    <div class="cell_hd">
                        <span class="radius_avatar">
                            <img class="avatar" src="<#=card_info.card_logo_url#>">
                        </span>
                    </div>
                    <div class="cell_bd cell_primary"><#=card_info.card_title#></div>
                    <div class="cell_ft">
                        <a href="javascript:void(0);"  class="btn btn_plain_primary btn_inline js_ad_btn" id="js_card_action_<#=pos_type#>">领券</a>
                    </div>
                </div>
                <div class="cardticket_ft">
                    <div class="cardticket_theme"></div>
                    <p class="cardticket_source tips_global"><#=card_info.card_brand_name#></p>
                </div>
            </div>
            <# } #>
        </div>
    </div>
  </script>
  <script type="text/javascript">
      var not_in_mm_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/not_in_mm2637ae.css";
      var windowwx_css = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2826cc.css";
      var tid = "";
      var aid = "";
      var clientversion = "0";
      var appuin = "MzAwMDU1MTE1OQ==";

      var source = "";
      var scene = 75;
      
      var itemidx = "";
      var nickname = "高可用架构";
      var ct = "1439115723";
      var user_name = "gh_ef1c37a72e61";
      var user_name_new = "";
      var fakeid   = "";
      var version   = "";
      var is_limit_user   = "0";
      var msg_title = "单表60亿记录等大数据场景的MySQL优化和运维之道&nbsp;|&nbsp;高可用架构";
      var msg_desc = "业界知名数据库专家杨尚刚分享的在单表60亿记录等大数据场景下，MySQL优化和运维之道";
      var msg_cdn_url = "http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOODltJiaib4ia4ydzokHzwW8maicQES3gvibOrRT50Jx0CiaRNtqGq5Aq7RGFeWcjeSVsF8vka5I8FiaRiakA/0?wx_fmt=jpeg";
      var msg_link = "http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=209403337&amp;idx=1&amp;sn=f99429e24e8c591111a355e072f93e05#rd";
      var user_uin = "0"*1;
      var msg_source_url = '';
      var img_format = 'jpeg';
      var srcid = '';
      var networkType;
      var appmsgid = '' || '209403337';
      var comment_id = "0" * 1;
      var comment_enabled = "" * 1;
      var is_need_reward = "0" * 1;
      var is_https_res = ("" * 1) && (location.protocol == "https:");

      var devicetype = "";
      var source_username = "";
      var reprint_ticket = "";
      var source_mid = "";
      var source_idx = "";

      var show_comment = "";
      var __appmsgCgiData = {
            can_use_page : "0"*1,
            is_wxg_stuff_uin : "0"*1,
            card_pos : "",
            copyright_stat : "0",
            hd_head_img : "http://wx.qlogo.cn/mmhead/Q3auHgzwzM4DkCqSIEoCCu1zKRml7uqGvKdYV2Z2KHyFjuydwib6dNA/0"||(window.location.protocol+"//"+window.location.host + "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_rumor_link.2x264e76.jpg")
      };
      var _empty_v = "http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/pages/voice/empty26f1f1.mp3";

      var copyright_stat = "0" * 1;

      var pay_fee = "" * 1; // 付费阅读费用
      var pay_timestamp = "";
      var need_pay = "" * 1;

      var need_report_cost = "0" * 1;
      
            window.wxtoken = "";
        </script>

  <script type="text/javascript">
        (function() {
        var JSAPI = {
            ready: function(onBridgeReady) {
                if (typeof top.window.WeixinJSBridge == 'undefined' || !top.window.WeixinJSBridge.invoke) {
                    if (top.window.document.addEventListener) {
                        top.window.document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                    } else if (top.window.document.attachEvent) {
                        top.window.document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
                        top.window.document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                    }
                } else {
                    onBridgeReady();
                }
            },
            on: function(eventName, callback) {
                top.window.WeixinJSBridge.on(eventName, callback);
            }
        };
        var onA8KeyReady = function(A8KeyUrl) {
            if (A8KeyUrl) {
                var params = getQueryFromURL(A8KeyUrl);
                window.uin = params['uin'] || window.uin;
                window.key = params['key'] || window.key;
                window.pass_ticket = params['pass_ticket'] || window.pass_ticket;
            }
            seajs.use('appmsg/index.js');
        };
        var bridgeReadyTimer;
        var onBridgeReady = function() {
            window.logs.pagetime['jsapi_ready_time'] = (+new Date());
            if (bridgeReadyTimer) {
                clearTimeout(bridgeReadyTimer);
            }
            if (!window.isWeixinCached) {
                                window.logs['is_page_cached'] = 0;
                onA8KeyReady();
            } else if (window.getA8KeyUrl) {
                                window.logs.pagetime['a8key_ready_time'] = (+new Date());
                onA8KeyReady(window.getA8KeyUrl);
            } else {
                                JSAPI.on('onGetA8KeyUrl', function(res) {
                    window.logs.pagetime['a8key_ready_time'] = (+new Date());
                    onA8KeyReady(res.url);
                });
            }
        };

                if (typeof window.pass_ticket !== 'undefined' && !!window.pass_ticket) {
                        onA8KeyReady();
        } else if (window.isInWeixinApp() == false) {
                        onA8KeyReady();
        } else {
                        window.logs['is_page_cached'] = 1;
            JSAPI.ready(onBridgeReady);
                        bridgeReadyTimer = setTimeout(function() {
                window.logs['jsapi_ready_fail'] = 1000;
                onA8KeyReady();
            }, 2000);
        }
    })();
  </script>

    


 
</body><style type="text/css" id="682250320000"></style></html>